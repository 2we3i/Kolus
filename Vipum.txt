// ==UserScript==
// @name         –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä - v1.8.1 (KOLUS Style)
// @namespace    pillar.autofill.advanced
// @version      1.8.1
// @description  üèóÔ∏è –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –æ–ø–æ—Ä –≤ —Å—Ç–∏–ª–µ KOLUS | Created by KAST Team
// @match        https://moe2.agentumit.ru/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    console.log('üöÄ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä v1.8.1 –∑–∞–≥—Ä—É–∂–µ–Ω | Created by KAST Team');

    const STORAGE_KEY = 'pillar_autofill_v1';

    /******************************************************************
     * –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
     ******************************************************************/
    const PILLAR_TYPE_TO_MATERIAL = {
        '–°–í 95': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è', '–°–í 110': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è', '–°–ö–¶': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è',
        '–î–µ—Ä–µ–≤—è–Ω–∞—è –Ω/–≤': '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', '–û–°–¶-1.5-9.0': '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', '–¢—Ä—É–±–æ—Å—Ç–æ–π–∫–∞': '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è'
    };
    const PILLAR_TYPES       = ['–°–í 95', '–°–í 110', '–°–ö–¶', '–î–µ—Ä–µ–≤—è–Ω–∞—è –Ω/–≤', '–û–°–¶-1.5-9.0', '–¢—Ä—É–±–æ—Å—Ç–æ–π–∫–∞'];
    const CONSTRUCTION_TYPES = [
        { name: '–æ–¥–Ω–æ—Å—Ç–æ–µ—á–Ω–∞—è', stands: 1 }, { name: '–¥–≤—É—Ö—Å—Ç–æ–µ—á–Ω–∞—è', stands: 2 },
        { name: '—Ç—Ä–µ—Ö—Å—Ç–æ–µ—á–Ω–∞—è', stands: 3 }, { name: '–ê-–æ–±—Ä–∞–∑–Ω–∞—è', stands: 2 }, { name: '–ü-–æ–±—Ä–∞–∑–Ω–∞—è', stands: 2 }
    ];
    const PLACEMENT_TYPES = ['–û—Ç–≤–µ—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è', '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è', '–£–≥–ª–æ–≤–∞—è', '–ö–æ–Ω—Ü–µ–≤–∞—è'];
    const BRACING_MATS    = ['–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è'];
    const ATTACH_MATS     = ['–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è'];
    const LAMP_TYPES      = ['–î–ù–ê–¢', '–î–†–õ', '–°–≤–µ—Ç–æ–¥–∏–æ–¥', '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é'];

    const defaultData = {
        pillar: { type: '–°–í 95', constructionType: '–æ–¥–Ω–æ—Å—Ç–æ–µ—á–Ω–∞—è', placement: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è', material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' },
        stands: { count: 1, material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' },
        bracing: { count: 0, material: '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è' },
        attachments: { count: 0, material: '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è' },
        additionalLoad: { communicationCabinet: 0, communicationLine: 0, streetLamp: 0, volsMuffle: 0, streetLantern: 0, voltageLines: 0 },
        lamps: [],
        ui: { pos: { x: 20, y: 20 }, isCollapsed: false, scale: 100 }
    };

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;
    db.additionalLoad = Object.assign({ communicationCabinet: 0, communicationLine: 0, streetLamp: 0, volsMuffle: 0, streetLantern: 0, voltageLines: 0 }, db.additionalLoad || {});
    db.ui = Object.assign({ pos: { x: 20, y: 20 }, isCollapsed: false, scale: 100 }, db.ui || {});
    const saveDb = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(db));

    /******************************************************************
     * –£–¢–ò–õ–ò–¢–´
     ******************************************************************/
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function setReactInput(input, value) {
        if (!input) return false;
        try {
            Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set.call(input, value);
            input.dispatchEvent(new Event('input',  { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            return true;
        } catch (e) { return false; }
    }

    async function waitForField(selector, timeout = 6000) {
        const t0 = Date.now();
        let el = document.querySelector(selector);
        while (!el && Date.now() - t0 < timeout) { await sleep(150); el = document.querySelector(selector); }
        return el || null;
    }

    async function fillField(selector, value, label) {
        const el = await waitForField(selector, 5000);
        if (!el) { console.warn(`${label}: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`); return false; }
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await sleep(100);
        if ((el.value || '') === value) return true;
        for (let i = 0; i < 5; i++) {
            setReactInput(el, value);
            await sleep(200);
            if ((el.value || '') === value) return true;
            await sleep(150);
        }
        return false;
    }

    async function clickReactSelect(selector, value) {
        const sel = document.querySelector(selector);
        if (!sel) return false;
        ['mousedown', 'mouseup', 'click'].forEach(t =>
            sel.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(300);
        for (let i = 0; i < 40; i++) {
            const opt = [...document.querySelectorAll('.smwb-menu__item')].find(o => o.textContent.trim() === value);
            if (opt) {
                ['mousedown', 'mouseup', 'click'].forEach(t =>
                    opt.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    async function clickCamera(selector) {
        const btn = document.querySelector(selector);
        if (!btn) return false;
        const fs = btn.closest('fieldset');
        if (fs) {
            fs.scrollIntoView({ behavior: 'smooth', block: 'center' });
            await sleep(150);
            const hasPhoto = [...fs.querySelectorAll('img')].some(img => {
                const src = img.src || '';
                return (src.startsWith('https://') || src.startsWith('blob:') || src.startsWith('data:image'))
                    && !src.includes('iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB')
                    && img.width > 10;
            });
            if (hasPhoto) return true;
        }
        ['mousedown', 'mouseup', 'click'].forEach(t =>
            btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(100);
        return true;
    }

    // –ö–ª–∏–∫–∞–µ—Ç –∫–∞–º–µ—Ä—É —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Ä–∞–∑, —á—Ç–æ–±—ã –Ω–∞–±—Ä–∞—Ç—å –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
    async function clickCameraN(selector, needed) {
        const fs = document.querySelector(selector);
        if (!fs) return false;
        fs.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await sleep(150);
        const countRealPhotos = () => [...fs.querySelectorAll('img')].filter(img => {
            const src = img.src || '';
            return (src.startsWith('https://') || src.startsWith('blob:') || src.startsWith('data:image'))
                && !src.includes('iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB')
                && img.width > 10;
        }).length;
        const already = countRealPhotos();
        const toClick = Math.max(0, needed - already);
        for (let i = 0; i < toClick; i++) {
            const btn = fs.querySelector('button.smwb-fab');
            if (!btn) break;
            ['mousedown', 'mouseup', 'click'].forEach(t =>
                btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
            );
            await sleep(400);
        }
        return true;
    }

    async function setCounter(selector, target) {
        const inp = await waitForField(selector, 4000);
        if (!inp) return false;
        const cont  = inp.closest('.zC3boZPYpGZ1oTnRKpH9') || inp.closest('.MUUhtVW6OxD9dYFURbyO') || inp.parentElement;
        const plus  = cont.querySelector('button.tKCNx3Mjilgu1eJFpBSs');
        const minus = cont.querySelector('button.bfwPpp5XjJbr4xH4oW1r');
        if (!plus || !minus) return false;
        const get = () => parseInt(inp.value) || 0;
        let retries = 0;
        while (get() < target && retries < 15) {
            const b = get(); plus.click(); await sleep(300);
            if (get() === b) { retries++; await sleep(300); } else retries = 0;
        }
        while (get() > target) { minus.click(); await sleep(500); }
        return get() === target;
    }

    /******************************************************************
     * –ö–ê–†–£–°–ï–õ–¨
     ******************************************************************/
    function getCarouselIndex() {
        const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
        for (let i = 0; i < dots.length; i++) if (dots[i].classList.contains('current')) return i;
        return 0;
    }

    async function goToSlide(target, maxTries = 5) {
        for (let t = 1; t <= maxTries; t++) {
            const cur = getCarouselIndex();
            if (cur === target) return true;
            const diff = target - cur;
            const next = document.querySelector('.smwb-carousel__navigation__button--next');
            const prev = document.querySelector('.smwb-carousel__navigation__button--prev');
            const btn  = diff > 0 ? next : prev;
            if (btn) { for (let c = 0; c < Math.abs(diff); c++) { btn.click(); await sleep(350); } }
            if (getCarouselIndex() === target) return true;
            const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
            if (target < dots.length) {
                const d = dots[target].querySelector('button') || dots[target];
                ['mousedown', 'mouseup', 'click'].forEach(e =>
                    d.dispatchEvent(new MouseEvent(e, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(500);
                if (getCarouselIndex() === target) return true;
            }
            await sleep(300);
        }
        return false;
    }

    /******************************************************************
     * –ù–ê–ì–†–£–ó–ö–ò
     ******************************************************************/
    function buildDesiredLoads() {
        const list = [];
        // –§–æ–Ω–∞—Ä–∏ ‚Äî –ü–ï–†–í–´–ú–ò
        for (let i = 0; i < db.additionalLoad.streetLamp; i++) {
            const lamp = db.lamps[i] || { type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' };
            list.push({ type: '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π', lamp });
        }
        // –°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏
        for (let i = 0; i < db.additionalLoad.streetLantern; i++)
            list.push({ type: '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫' });
        for (let i = 0; i < db.additionalLoad.communicationCabinet; i++)
            list.push({ type: '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π', owner: '–ù/–î' });
        for (let i = 0; i < db.additionalLoad.communicationLine; i++)
            list.push({ type: '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏', lineType: '–í–û–õ–°' });
        for (let i = 0; i < db.additionalLoad.volsMuffle; i++)
            list.push({ type: '–º—É—Ñ—Ç–∞ –í–û–õ–°' });
        for (let i = 0; i < db.additionalLoad.voltageLines; i++)
            list.push({ type: '–ª–∏–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è' });
        return list;
    }

    function getLoadCounter() {
        const inp = document.querySelector('input[name="additionalLoad.count"]');
        if (!inp) return null;
        const cont = inp.closest('.zC3boZPYpGZ1oTnRKpH9') || inp.closest('.MUUhtVW6OxD9dYFURbyO') || inp.parentElement;
        return { input: inp, plus: cont.querySelector('button.tKCNx3Mjilgu1eJFpBSs'), minus: cont.querySelector('button.bfwPpp5XjJbr4xH4oW1r'), count: () => parseInt(inp.value) || 0 };
    }

    async function fillLoad(loadIndex, loadData) {
        const { type } = loadData;
        const typeSelector = `input[name="additionalLoad.info[${loadIndex}].type"]`;
        let typeInput = document.querySelector(typeSelector);
        if (!typeInput) {
            const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
            const slideIdx = loadIndex + 1;
            if (slideIdx < dots.length) {
                const d = dots[slideIdx].querySelector('button') || dots[slideIdx];
                ['mousedown', 'mouseup', 'click'].forEach(t =>
                    d.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(600);
            }
            typeInput = await waitForField(typeSelector, 8000);
        }
        if (!typeInput) return false;
        await fillField(typeSelector, type, `–¢–∏–ø[${loadIndex}]`);
        await sleep(200);
        if (type === '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π') {
            await fillField(`input[name="additionalLoad.info[${loadIndex}].distributionCabinetOwner"]`, loadData.owner || '–ù/–î', `–í–ª–∞–¥–µ–ª–µ—Ü[${loadIndex}]`);
        } else if (type === '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏') {
            await fillField(`input[name="additionalLoad.info[${loadIndex}].communicationLineType"]`, loadData.lineType || '–í–û–õ–°', `–¢–∏–ø –ª–∏–Ω–∏–∏[${loadIndex}]`);
        } else if (type === '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π' && loadData.lamp) {
            const lamp = loadData.lamp;
            const lt   = lamp.type === '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é' ? lamp.customType : lamp.type;
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampType"]`, lt, `–õ–∞–º–ø–∞[${loadIndex}]`);
            await sleep(150);
            // –ï–¥–∏–Ω–∏—á–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å = 3: –ø—Ä–æ–±—É–µ–º –º–∞–∫—Å 4 –Ω–∞–∂–∞—Ç–∏—è, –µ—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            const powerInp = document.querySelector(`input[name="additionalLoad.info[${loadIndex}].streetLampPower"]`);
            if (powerInp) {
                const powerCont = powerInp.closest('.zC3boZPYpGZ1oTnRKpH9') || powerInp.closest('.MUUhtVW6OxD9dYFURbyO') || powerInp.parentElement;
                const powerMinus = powerCont ? powerCont.querySelector('button.bfwPpp5XjJbr4xH4oW1r') : null;
                const powerPlus  = powerCont ? powerCont.querySelector('button.tKCNx3Mjilgu1eJFpBSs') : null;
                const getVal = () => parseInt(powerInp.value) || 0;
                if (powerMinus && powerPlus) {
                    let attempts = 0;
                    while (getVal() !== 3 && attempts < 4) {
                        getVal() > 3 ? powerMinus.click() : powerPlus.click();
                        await sleep(300);
                        attempts++;
                    }
                    if (getVal() !== 3) log(`–ú–æ—â–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞—Ä—è[${loadIndex}]: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å 3 (–æ—Å—Ç–∞–ª–æ—Å—å ${getVal()}), –ø—Ä–æ–ø—É—â–µ–Ω–æ`, 'debug');
                }
            }
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampMountType"]`, lamp.mounting, `–ö—Ä–µ–ø–ª–µ–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampFasteningType"]`, lamp.powerSupply, `–ü–∏—Ç–∞–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampLuminaireDirection"]`, lamp.direction, `–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            // –§–æ—Ç–æ –ª–∞–º–ø—ã ‚Äî 2 —Ñ–æ—Ç–æ: –æ–±—â–µ–µ + –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º
            await clickCameraN(`fieldset[name="additionalLoad.info[${loadIndex}].streetLampPhotoUrls"]`, 2);
            await sleep(150);
            // –§–æ—Ç–æ –∫—Ä–æ–Ω—à—Ç–µ–π–Ω–∞
            await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].streetLampMountPhotoUrls"] button.smwb-fab`);
        } else if (type === '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫') {
            // –°–≤–µ—Ç–∏–ª—å–Ω–∏–∫: —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –Ω–∞–≥—Ä—É–∑–∫–∏ + —Ñ–æ—Ç–æ –∫—Ä–æ–Ω—à—Ç–µ–π–Ω–∞
            await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].lampBracketPhotoUrls"] button.smwb-fab`);
        } else if (type === '–º—É—Ñ—Ç–∞ –í–û–õ–°') {
            // –†–µ–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—è: fiberOpticSpliceClosureOwner
            await fillField(`input[name="additionalLoad.info[${loadIndex}].fiberOpticSpliceClosureOwner"]`, '–ù/–î', `–í–ª–∞–¥–µ–ª–µ—Ü –º—É—Ñ—Ç—ã[${loadIndex}]`);
        } else if (type === '–ª–∏–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è') {
            // –¢–æ–ª—å–∫–æ —Ç–∏–ø + —Ñ–æ—Ç–æ, –¥–æ–ø. –ø–æ–ª–µ–π –Ω–µ—Ç
        }
        await sleep(150);
        await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].photoUrls"] button.smwb-fab`);
        return true;
    }

    async function syncLoads() {
        const desired = buildDesiredLoads();
        const N = desired.length;
        const counter = await (async () => {
            for (let i = 0; i < 10; i++) { const c = getLoadCounter(); if (c && c.plus && c.minus) return c; await sleep(500); }
            return null;
        })();
        if (!counter) return;
        let siteCount = counter.count();
        if (siteCount > N) {
            for (let i = 0; i < siteCount - N; i++) { counter.minus.click(); await sleep(700); }
        } else if (siteCount < N) {
            for (let i = 0; i < N - siteCount; i++) { counter.plus.click(); await sleep(700); }
        }
        siteCount = counter.count();
        if (siteCount !== N) return;
        for (let i = 0; i < N; i++) { await fillLoad(i, desired[i]); await sleep(200); }
    }

    /******************************************************************
     * –ê–í–¢–û–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –§–û–†–ú–´
     ******************************************************************/
    async function loadFromForm() {
        try {
            let changed = false;
            const pillarEl = document.querySelector('fieldset[name="pillarType"] .smwb-select-field__values');
            if (pillarEl) {
                const t = pillarEl.textContent.trim();
                if (t && PILLAR_TYPE_TO_MATERIAL[t] && db.pillar.type !== t) {
                    db.pillar.type = t; db.pillar.material = PILLAR_TYPE_TO_MATERIAL[t];
                    db.stands.material = db.pillar.material; changed = true;
                }
            }
            const pairs = [
                ['input[name="constructionType"]', v => { db.pillar.constructionType = v; }],
                ['input[name="placement"]',        v => { db.pillar.placement = v; }],
                ['input[name="material"]',         v => { db.pillar.material = v; db.stands.material = v; }]
            ];
            for (const [sel, setter] of pairs) {
                const el = document.querySelector(sel);
                if (el?.value) { setter(el.value); changed = true; }
            }
            const sc = document.querySelector('input[name="stand.count"]');
            if (sc) { const v = parseInt(sc.value)||0; if (db.stands.count !== v) { db.stands.count = v; changed = true; } }
            const bc = document.querySelector('input[name="bracing.count"]');
            if (bc) { const v = parseInt(bc.value)||0; if (db.bracing.count !== v) { db.bracing.count = v; changed = true; } }
            // –ú–∞—Ç–µ—Ä–∏–∞–ª —É–∫–æ—Å–∞ ‚Äî –±–µ—Ä—ë–º —Å –ø–µ—Ä–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ —É–∫–æ—Å–æ–≤
            const bm = document.querySelector('input[name="bracing.info[0].material"]') ||
                       document.querySelector('input[name="bracing.material"]');
            if (bm?.value && db.bracing.material !== bm.value) { db.bracing.material = bm.value; changed = true; }
            const loadCounter = getLoadCounter();
            if (loadCounter) {
                const siteLoadCount = loadCounter.count();
                let cabs=0, lines=0, lamps=0, muffles=0, lanterns=0, voltLines=0;
                for (let i = 0; i < siteLoadCount; i++) {
                    const ti = document.querySelector(`input[name="additionalLoad.info[${i}].type"]`);
                    if (!ti) continue;
                    const v = ti.value.trim();
                    if (v === '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π') cabs++;
                    else if (v === '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏') lines++;
                    else if (v === '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π') lamps++;
                    else if (v === '–º—É—Ñ—Ç–∞ –í–û–õ–°') muffles++;
                    else if (v === '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫') lanterns++;
                    else if (v === '–ª–∏–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è') voltLines++;
                }
                if (db.additionalLoad.communicationCabinet !== cabs || db.additionalLoad.communicationLine !== lines ||
                    db.additionalLoad.streetLamp !== lamps || db.additionalLoad.volsMuffle !== muffles ||
                    db.additionalLoad.streetLantern !== lanterns || db.additionalLoad.voltageLines !== voltLines) {
                    db.additionalLoad.communicationCabinet = cabs;
                    db.additionalLoad.communicationLine = lines;
                    db.additionalLoad.streetLamp = lamps;
                    db.additionalLoad.volsMuffle = muffles;
                    db.additionalLoad.streetLantern = lanterns;
                    db.additionalLoad.voltageLines = voltLines;
                    db.lamps = Array.from({ length: lamps }, () => ({ type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' }));
                    changed = true;
                }
            }
            if (changed) { saveDb(); updateUI(); }
        } catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e); }
    }

    let formDetected = false;
    function startDetection() {
        setInterval(async () => {
            const ok = document.querySelector('fieldset[name="pillarType"]') && document.querySelector('input[name="constructionType"]');
            if (ok && !formDetected) { formDetected = true; await sleep(800); await loadFromForm(); }
            if (!ok && formDetected) formDetected = false;
        }, 2000);
    }

    /******************************************************************
     * UI (SHADOW DOM) ‚Äî –≤ —Å—Ç–∏–ª–µ KOLUS
     ******************************************************************/
    const host = document.createElement('div');
    host.id = 'pillar-ui-host';
    host.style.display = 'none';
    document.body.appendChild(host);
    const shadow = host.attachShadow({ mode: 'open' });

    const css = `
    @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    .root { position: fixed; width: 340px; background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; z-index: 1000000; box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1); color: #fff; overflow: hidden; animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: top left; display: flex; flex-direction: column; max-height: 90vh; }

    /* ‚îÄ‚îÄ –®–∞–ø–∫–∞ ‚îÄ‚îÄ */
    .header { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 8px 12px; cursor: move; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); user-select: none; flex-shrink: 0; }
    .header-title { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 13px; letter-spacing: 0.3px; }
    .header-icon { width: 18px; height: 18px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
    .header-controls { display: flex; gap: 6px; align-items: center; }
    .header-btn { width: 24px; height: 24px; border-radius: 5px; background: rgba(255,255,255,0.1); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; line-height: 1; }
    .header-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

    /* ‚îÄ‚îÄ –°–≤—ë—Ä–Ω—É—Ç–∞—è –∏–Ω—Ñ–æ-—Å—Ç—Ä–æ–∫–∞ ‚îÄ‚îÄ */
    .collapsed-info { padding: 8px 12px; display: none; flex-direction: column; gap: 6px; background: rgba(0,0,0,0.2); }
    .collapsed-info.visible { display: flex; }
    .collapsed-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .collapsed-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; font-size: 9px; }
    .collapsed-value { font-weight: 700; font-size: 11px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.3); color: #a78bfa; }

    /* ‚îÄ‚îÄ –¢–µ–ª–æ ‚îÄ‚îÄ */
    .body { padding: 10px 12px; padding-bottom: 70px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex: 1; }
    .body::-webkit-scrollbar { width: 5px; }
    .body::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
    .body::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 3px; }
    .body::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.7); }

    /* ‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å-–ø–∞–Ω–µ–ª—å ‚îÄ‚îÄ */
    .status-panel { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
    .status-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .status-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; font-size: 9px; }
    .status-value { font-weight: 700; font-size: 11px; padding: 3px 8px; border-radius: 5px; background: rgba(0,0,0,0.3); color: #a78bfa; }

    /* ‚îÄ‚îÄ –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ‚îÄ‚îÄ */
    .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); margin: 2px 0; }

    /* ‚îÄ‚îÄ –ü–æ–ª—è ‚îÄ‚îÄ */
    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-label { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.3px; }
    .field-label-icon { font-size: 12px; }
    .field-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; padding: 7px 10px; color: #fff; font-size: 12px; transition: all 0.2s; outline: none; font-family: inherit; width: 100%; }
    .field-input:focus { border-color: rgba(139,92,246,0.6); background: rgba(0,0,0,0.4); box-shadow: 0 0 0 2px rgba(139,92,246,0.1); }
    .field-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; padding: 7px 10px; color: #fff; font-size: 12px; transition: all 0.2s; outline: none; font-family: inherit; width: 100%; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23fff' opacity='.5' d='M5 7L1 3h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
    .field-select:focus { border-color: rgba(139,92,246,0.6); box-shadow: 0 0 0 2px rgba(139,92,246,0.1); }
    .field-select option { background: #1e1b4b; }

    /* ‚îÄ‚îÄ –°—á—ë—Ç—á–∏–∫ ‚îÄ‚îÄ */
    .number-control { display: flex; align-items: center; gap: 6px; }
    .number-btn { width: 26px; height: 26px; border-radius: 6px; border: none; background: rgba(139,92,246,0.2); color: #8b5cf6; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; transition: all 0.2s; flex-shrink: 0; }
    .number-btn:hover { background: rgba(139,92,246,0.35); transform: scale(1.05); }
    .number-display { flex: 1; text-align: center; font-size: 14px; font-weight: 700; color: #a78bfa; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 7px; }

    /* ‚îÄ‚îÄ –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ ‚îÄ‚îÄ */
    .compact-row { display: flex; gap: 6px; }
    .compact-row .field-group { flex: 1; }

    /* ‚îÄ‚îÄ –ù–∞–≥—Ä—É–∑–∫–∏ (–ø–ª–∏—Ç–∫–∏) ‚îÄ‚îÄ */
    .load-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .load-tile { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px 10px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 4px; user-select: none; }
    .load-tile:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
    .load-tile.active { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.5); }
    .load-tile-header { display: flex; justify-content: space-between; align-items: center; }
    .load-tile-icon { font-size: 15px; }
    .load-tile-count { background: rgba(139,92,246,0.3); color: #a78bfa; border-radius: 5px; padding: 2px 7px; font-weight: 700; font-size: 12px; min-width: 22px; text-align: center; }
    .load-tile.active .load-tile-count { background: rgba(139,92,246,0.5); color: #c4b5fd; }
    .load-tile-name { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.3px; }
    .load-tile.active .load-tile-name { color: rgba(167,139,250,0.9); }
    .load-hint { font-size: 9px; color: rgba(255,255,255,0.35); text-align: center; margin-top: 2px; }

    /* ‚îÄ‚îÄ –ü–æ–¥–≤–∞–ª —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚îÄ‚îÄ */
    .footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 12px; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.4)); display: flex; gap: 6px; backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); }
    .btn { flex: 1; padding: 9px 16px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-fill { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; box-shadow: 0 3px 10px rgba(139,92,246,0.3); }
    .btn-fill:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139,92,246,0.4); }
    .btn-scan { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.3)); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
    .btn-scan:hover:not(:disabled) { background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.4)); transform: translateY(-1px); }

    /* ‚îÄ‚îÄ –ú–∞—Å—à—Ç–∞–± ‚îÄ‚îÄ */
    .scale-controls { display: flex; align-items: center; gap: 4px; }
    .scale-btn { width: 20px; height: 20px; border-radius: 4px; border: none; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; transition: all 0.2s; }
    .scale-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
    .scale-value { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.8); min-width: 32px; text-align: center; }

    /* ‚îÄ‚îÄ –õ–æ–≥–∏ ‚îÄ‚îÄ */
    .log-panel { position: fixed; bottom: 20px; right: 20px; width: 420px; max-height: 320px; background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1); z-index: 999999; display: flex; flex-direction: column; overflow: hidden; }
    .log-panel.hidden { display: none; }
    .log-header { background: rgba(0,0,0,0.3); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
    .log-title { font-weight: 700; font-size: 12px; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 6px; }
    .log-actions { display: flex; gap: 5px; }
    .log-btn { padding: 4px 8px; background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.3); border-radius: 5px; color: #a78bfa; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .log-btn:hover { background: rgba(139,92,246,0.3); }
    .log-content { flex: 1; overflow-y: auto; padding: 10px 12px; }
    .log-content::-webkit-scrollbar { width: 4px; }
    .log-content::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 2px; }
    .log-entry { font-size: 10px; font-family: 'Menlo', 'Consolas', monospace; margin-bottom: 3px; line-height: 1.5; }

    /* ‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚îÄ‚îÄ */
    .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(0,0,0,0.95)); border: 1px solid rgba(34,197,94,0.5); border-radius: 10px; padding: 12px 16px; color: #fff; font-size: 12px; font-weight: 600; z-index: 1000002; box-shadow: 0 8px 24px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; max-width: 280px; }
    .notification-warning { background: linear-gradient(135deg, rgba(234,179,8,0.95), rgba(0,0,0,0.95)); border-color: rgba(234,179,8,0.5); }
    .notification-error   { background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(0,0,0,0.95)); border-color: rgba(239,68,68,0.5); }

    /* ‚îÄ‚îÄ –ú–æ–¥–∞–ª–∫–∏ ‚îÄ‚îÄ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000001; }
    .modal-overlay.show { display: flex; }
    .modal { background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; padding: 20px; width: 90%; max-width: 340px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto; }
    .modal::-webkit-scrollbar { width: 4px; }
    .modal::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 2px; }
    .modal-title { font-size: 14px; font-weight: 700; margin-bottom: 14px; color: #fff; display: flex; align-items: center; gap: 6px; }
    .modal-content { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
    .modal-buttons { display: flex; gap: 6px; }
    .modal-btn { flex: 1; padding: 9px 16px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .modal-btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; }
    .modal-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(139,92,246,0.4); }
    .modal-btn-secondary { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
    .modal-btn-secondary:hover { background: rgba(255,255,255,0.15); }

    /* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ —Ñ–æ–Ω–∞—Ä—è ‚îÄ‚îÄ */
    .lamp-card { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .lamp-card-title { font-size: 11px; font-weight: 700; color: #a78bfa; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .radio-group { display: flex; gap: 4px; flex-wrap: wrap; }
    .radio-option { flex: 1; min-width: calc(33.33% - 3px); }
    .radio-input  { display: none; }
    .radio-label  { display: flex; align-items: center; justify-content: center; padding: 6px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; cursor: pointer; transition: all 0.2s; font-size: 11px; font-weight: 500; text-align: center; }
    .radio-label:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
    .radio-input:checked + .radio-label { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.6); color: #a78bfa; font-weight: 600; }

    /* ‚îÄ‚îÄ Discord ‚îÄ‚îÄ */
    .discord-link { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 6px 10px; background: rgba(88,101,242,0.2); border: 1px solid rgba(88,101,242,0.3); border-radius: 7px; color: #5865f2; font-size: 10px; font-weight: 600; text-decoration: none; transition: all 0.2s; margin-top: 4px; }
    .discord-link:hover { background: rgba(88,101,242,0.3); transform: translateY(-1px); }
    `;

    const html = `
    <div class="root" id="mainPanel">
        <div class="header" id="dragHandle">
            <div class="header-title">
                <div class="header-icon">üèóÔ∏è</div>
                <span>–û–ø–æ—Ä—ã v1.8.1</span>
            </div>
            <div class="header-controls">
                <div class="scale-controls">
                    <button class="scale-btn" id="btnScaleDown">‚àí</button>
                    <span class="scale-value" id="scaleValue">100%</span>
                    <button class="scale-btn" id="btnScaleUp">+</button>
                </div>
                <button class="header-btn" id="btnToggleLogs" title="–ñ—É—Ä–Ω–∞–ª">üìã</button>
                <button class="header-btn" id="btnMinimize">‚àí</button>
            </div>
        </div>

        <div class="collapsed-info" id="collapsedInfo">
            <div class="collapsed-row">
                <span class="collapsed-label">üèóÔ∏è –û–ø–æ—Ä–∞</span>
                <span class="collapsed-value" id="collapsedPillar">‚Äî</span>
            </div>
            <div class="collapsed-row">
                <span class="collapsed-label">üìê –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</span>
                <span class="collapsed-value" id="collapsedConstruct">‚Äî</span>
            </div>
        </div>

        <div class="body" id="bodyContent">

            <!-- –°—Ç–∞—Ç—É—Å -->
            <div class="status-panel">
                <div class="status-row">
                    <span class="status-label">üèóÔ∏è –ú–∞—Ä–∫–∞ –æ–ø–æ—Ä—ã</span>
                    <span class="status-value" id="statusPillar">‚Äî</span>
                </div>
                <div class="status-row">
                    <span class="status-label">üìê –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</span>
                    <span class="status-value" id="statusConstruct">‚Äî</span>
                </div>
            </div>

            <div class="divider"></div>

            <!-- –û–ø–æ—Ä–∞ -->
            <div class="field-group">
                <label class="field-label"><span class="field-label-icon">üèóÔ∏è</span>–ú–∞—Ä–∫–∞ –æ–ø–æ—Ä—ã</label>
                <select class="field-select" id="selPillarType"></select>
            </div>

            <div class="compact-row">
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üìê</span>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</label>
                    <select class="field-select" id="selConstructionType"></select>
                </div>
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üìç</span>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                    <select class="field-select" id="selPlacement"></select>
                </div>
            </div>

            <div class="divider"></div>

            <!-- –£–∫–æ—Å—ã -->
            <div class="compact-row">
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üîß</span>–£–∫–æ—Å—ã</label>
                    <div class="number-control">
                        <button class="number-btn" id="btnBrDown">‚àí</button>
                        <div class="number-display" id="dispBracing">0</div>
                        <button class="number-btn" id="btnBrUp">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">ü™µ</span>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select class="field-select" id="selBracingMat"></select>
                </div>
            </div>

            <div class="divider"></div>

            <!-- –ù–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="field-group">
                <label class="field-label"><span class="field-label-icon">‚ö°</span>–ù–∞–≥—Ä—É–∑–∫–∏</label>
                <div class="load-hint">–õ–ö–ú ‚Äî –¥–æ–±–∞–≤–∏—Ç—å ¬∑ –ü–ö–ú ‚Äî —É–±—Ä–∞—Ç—å</div>
                <div class="load-grid">
                    <div class="load-tile" id="loadCabinet">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üóÑÔ∏è</span>
                            <span class="load-tile-count" id="cntCabinet">0</span>
                        </div>
                        <div class="load-tile-name">–®–∫–∞—Ñ</div>
                    </div>
                    <div class="load-tile" id="loadCommLine">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üì°</span>
                            <span class="load-tile-count" id="cntCommLine">0</span>
                        </div>
                        <div class="load-tile-name">–õ–∏–Ω–∏—è —Å–≤—è–∑–∏</div>
                    </div>
                    <div class="load-tile" id="loadStreetLamp">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üí°</span>
                            <span class="load-tile-count" id="cntStreetLamp">0</span>
                        </div>
                        <div class="load-tile-name">–§–æ–Ω–∞—Ä—å</div>
                    </div>
                    <div class="load-tile" id="loadVolsMuffle">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üîå</span>
                            <span class="load-tile-count" id="cntVolsMuffle">0</span>
                        </div>
                        <div class="load-tile-name">–ú—É—Ñ—Ç–∞ –í–û–õ–°</div>
                    </div>
                    <div class="load-tile" id="loadStreetLantern">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üîÜ</span>
                            <span class="load-tile-count" id="cntStreetLantern">0</span>
                        </div>
                        <div class="load-tile-name">–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫</div>
                    </div>
                    <div class="load-tile" id="loadVoltageLines">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">‚ö°</span>
                            <span class="load-tile-count" id="cntVoltageLines">0</span>
                        </div>
                        <div class="load-tile-name">–†–∞–∑–Ω. –Ω–∞–ø—Ä.</div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <a href="#" class="discord-link" id="discordLink">
                <span>üí¨</span><span>Discord: KAST Team</span>
            </a>
        </div>

        <div class="footer">
            <button class="btn btn-scan" id="btnScan">
                <span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
            <button class="btn btn-fill" id="btnFill">
                <span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="log-panel hidden" id="logPanel">
        <div class="log-header">
            <div class="log-title">üìã –ñ—É—Ä–Ω–∞–ª</div>
            <div class="log-actions">
                <button class="log-btn" id="btnCopyLogs">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="log-btn" id="btnClearLogs">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="log-btn" id="btnCloseLogs">‚úï</button>
            </div>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-entry" style="color:rgba(255,255,255,0.35);font-style:italic;">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ (–¥–µ—Ä–µ–≤–æ) -->
    <div class="modal-overlay" id="modalAttach">
        <div class="modal">
            <div class="modal-title">ü™µ –ü—Ä–∏—Å—Ç–∞–≤–∫–∏</div>
            <div class="modal-content">
                <div class="field-group">
                    <label class="field-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <div class="number-control">
                        <button class="number-btn" id="btnAtDown">‚àí</button>
                        <div class="number-display" id="dispAttach">0</div>
                        <button class="number-btn" id="btnAtUp">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select class="field-select" id="selAttachMat"></select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="btnCancelAttach">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary"   id="btnConfirmAttach">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: —Ñ–æ–Ω–∞—Ä–∏ -->
    <div class="modal-overlay" id="modalLamps">
        <div class="modal">
            <div class="modal-title">üí° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–∞—Ä–µ–π</div>
            <div class="modal-content" id="lampsConfig"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="btnCancelLamps">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary"   id="btnConfirmLamps">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    `;

    shadow.innerHTML = `<style>${css}</style>${html}`;

    /******************************************************************
     * –°–°–´–õ–ö–ò –ù–ê –≠–õ–ï–ú–ï–ù–¢–´
     ******************************************************************/
    const ui = {
        main:           shadow.querySelector('#mainPanel'),
        body:           shadow.querySelector('#bodyContent'),
        btnMin:         shadow.querySelector('#btnMinimize'),
        btnTogLogs:     shadow.querySelector('#btnToggleLogs'),
        btnScaleUp:     shadow.querySelector('#btnScaleUp'),
        btnScaleDown:   shadow.querySelector('#btnScaleDown'),
        scaleValue:     shadow.querySelector('#scaleValue'),
        statusPillar:   shadow.querySelector('#statusPillar'),
        statusConstruct:shadow.querySelector('#statusConstruct'),
        collapsedInfo:  shadow.querySelector('#collapsedInfo'),
        collapsedPillar:shadow.querySelector('#collapsedPillar'),
        collapsedConst: shadow.querySelector('#collapsedConstruct'),
        selPillar:      shadow.querySelector('#selPillarType'),
        selConstruct:   shadow.querySelector('#selConstructionType'),
        selPlacement:   shadow.querySelector('#selPlacement'),
        dispBracing:    shadow.querySelector('#dispBracing'),
        btnBrUp:        shadow.querySelector('#btnBrUp'),
        btnBrDown:      shadow.querySelector('#btnBrDown'),
        selBracingMat:  shadow.querySelector('#selBracingMat'),
        loadCabinet:    shadow.querySelector('#loadCabinet'),
        loadCommLine:   shadow.querySelector('#loadCommLine'),
        loadStreetLamp: shadow.querySelector('#loadStreetLamp'),
        loadVolsMuffle: shadow.querySelector('#loadVolsMuffle'),
        cntCabinet:     shadow.querySelector('#cntCabinet'),
        cntCommLine:    shadow.querySelector('#cntCommLine'),
        cntStreetLamp:  shadow.querySelector('#cntStreetLamp'),
        cntVolsMuffle:  shadow.querySelector('#cntVolsMuffle'),
        loadStreetLantern: shadow.querySelector('#loadStreetLantern'),
        cntStreetLantern:  shadow.querySelector('#cntStreetLantern'),
        loadVoltageLines:  shadow.querySelector('#loadVoltageLines'),
        cntVoltageLines:   shadow.querySelector('#cntVoltageLines'),
        btnFill:        shadow.querySelector('#btnFill'),
        btnScan:        shadow.querySelector('#btnScan'),
        modalAttach:    shadow.querySelector('#modalAttach'),
        dispAttach:     shadow.querySelector('#dispAttach'),
        btnAtUp:        shadow.querySelector('#btnAtUp'),
        btnAtDown:      shadow.querySelector('#btnAtDown'),
        selAttachMat:   shadow.querySelector('#selAttachMat'),
        btnConfAtch:    shadow.querySelector('#btnConfirmAttach'),
        btnCancAtch:    shadow.querySelector('#btnCancelAttach'),
        modalLamps:     shadow.querySelector('#modalLamps'),
        lampsConfig:    shadow.querySelector('#lampsConfig'),
        btnConfLamps:   shadow.querySelector('#btnConfirmLamps'),
        btnCancLamps:   shadow.querySelector('#btnCancelLamps'),
        discordLink:    shadow.querySelector('#discordLink'),
        logPanel:       shadow.querySelector('#logPanel'),
        logContent:     shadow.querySelector('#logContent'),
    };

    /******************************************************************
     * –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
     ******************************************************************/
    let logMessages = [];
    function log(message, type = 'info') {
        const ts = new Date().toLocaleTimeString('ru-RU');
        logMessages.push({ time: ts, message, type });
        const colors = { success: '#22c55e', error: '#ef4444', warning: '#eab308', debug: '#60a5fa', info: 'rgba(255,255,255,0.5)' };
        const icons  = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', debug: 'üîç', info: '‚ÑπÔ∏è' };
        const el = document.createElement('div');
        el.className = 'log-entry';
        el.style.color = colors[type] || colors.info;
        el.innerHTML = `<span style="opacity:0.5;">[${ts}]</span> ${icons[type]||'‚ÑπÔ∏è'} ${message}`;
        ui.logContent.appendChild(el);
        ui.logContent.scrollTop = ui.logContent.scrollHeight;
    }
    function clearLogs() {
        logMessages = [];
        ui.logContent.innerHTML = '<div class="log-entry" style="color:rgba(255,255,255,0.35);font-style:italic;">–û—á–∏—â–µ–Ω–æ</div>';
    }
    function copyLogs() {
        const t = document.createElement('textarea');
        t.value = logMessages.map(e => `[${e.time}] ${e.message}`).join('\n');
        t.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(t);
        t.select();
        try { document.execCommand('copy'); showNotification('‚úÖ –õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!'); }
        catch { showNotification('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error'); }
        document.body.removeChild(t);
    }

    shadow.querySelector('#btnCopyLogs').addEventListener('click', copyLogs);
    shadow.querySelector('#btnClearLogs').addEventListener('click', () => clearLogs());
    shadow.querySelector('#btnCloseLogs').addEventListener('click', () => ui.logPanel.classList.add('hidden'));

    ui.btnTogLogs.addEventListener('click', () => {
        ui.logPanel.classList.toggle('hidden');
        ui.btnTogLogs.style.background = ui.logPanel.classList.contains('hidden') ? 'rgba(255,255,255,0.1)' : 'rgba(139,92,246,0.4)';
    });

    /******************************************************************
     * –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
     ******************************************************************/
    function showNotification(message, type = 'success') {
        const n = document.createElement('div');
        n.className = `notification notification-${type}`;
        n.textContent = message;
        shadow.appendChild(n);
        setTimeout(() => { n.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => n.remove(), 300); }, 3000);
    }

    /******************************************************************
     * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–õ–ï–ö–¢–û–í
     ******************************************************************/
    function initSelects() {
        const fill = (el, items) => items.forEach(v => {
            const o = document.createElement('option');
            o.value = v; o.textContent = v; el.appendChild(o);
        });
        fill(ui.selPillar,     PILLAR_TYPES);
        fill(ui.selConstruct,  CONSTRUCTION_TYPES.map(c => c.name));
        fill(ui.selPlacement,  PLACEMENT_TYPES);
        fill(ui.selBracingMat, BRACING_MATS);
        fill(ui.selAttachMat,  ATTACH_MATS);
    }

    /******************************************************************
     * –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
     ******************************************************************/
    function updateUI() {
        ui.selPillar.value      = db.pillar.type;
        ui.selConstruct.value   = db.pillar.constructionType;
        ui.selPlacement.value   = db.pillar.placement;
        ui.dispBracing.textContent = db.bracing.count;
        ui.selBracingMat.value  = db.bracing.material;

        ui.statusPillar.textContent    = db.pillar.type;
        ui.statusConstruct.textContent = db.pillar.constructionType;
        ui.collapsedPillar.textContent = db.pillar.type;
        ui.collapsedConst.textContent  = db.pillar.constructionType;

        const loads = [
            { tile: ui.loadCabinet,       cnt: ui.cntCabinet,       key: 'communicationCabinet' },
            { tile: ui.loadCommLine,      cnt: ui.cntCommLine,      key: 'communicationLine' },
            { tile: ui.loadStreetLamp,    cnt: ui.cntStreetLamp,    key: 'streetLamp' },
            { tile: ui.loadVolsMuffle,    cnt: ui.cntVolsMuffle,    key: 'volsMuffle' },
            { tile: ui.loadStreetLantern, cnt: ui.cntStreetLantern, key: 'streetLantern' },
            { tile: ui.loadVoltageLines,  cnt: ui.cntVoltageLines,  key: 'voltageLines' },
        ];
        loads.forEach(({ tile, cnt, key }) => {
            const v = db.additionalLoad[key];
            cnt.textContent = v;
            tile.classList.toggle('active', v > 0);
        });

        updateScale();
    }

    /******************************************************************
     * –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï
     ******************************************************************/
    function updateScale() {
        ui.main.style.transform = `scale(${db.ui.scale / 100})`;
        ui.scaleValue.textContent = `${db.ui.scale}%`;
    }
    ui.btnScaleUp.addEventListener('click',   () => { if (db.ui.scale < 150) { db.ui.scale += 5; updateScale(); saveDb(); } });
    ui.btnScaleDown.addEventListener('click', () => { if (db.ui.scale > 60)  { db.ui.scale -= 5; updateScale(); saveDb(); } });

    /******************************************************************
     * –°–û–ë–´–¢–ò–Ø –ü–û–õ–ï–ô
     ******************************************************************/
    ui.selPillar.addEventListener('change', e => {
        db.pillar.type = e.target.value;
        db.pillar.material = PILLAR_TYPE_TO_MATERIAL[e.target.value] || '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è';
        db.stands.material = db.pillar.material; saveDb(); updateUI();
    });
    ui.selConstruct.addEventListener('change', e => {
        db.pillar.constructionType = e.target.value;
        const ct = CONSTRUCTION_TYPES.find(c => c.name === e.target.value);
        if (ct) db.stands.count = ct.stands; saveDb(); updateUI();
    });
    ui.selPlacement.addEventListener('change', e => { db.pillar.placement = e.target.value; saveDb(); });
    ui.btnBrUp.addEventListener('click',   () => { db.bracing.count++; saveDb(); updateUI(); });
    ui.btnBrDown.addEventListener('click', () => { if (db.bracing.count > 0) { db.bracing.count--; saveDb(); updateUI(); } });
    ui.selBracingMat.addEventListener('change', e => { db.bracing.material = e.target.value; saveDb(); });

    // –ù–∞–≥—Ä—É–∑–∫–∏ ‚Äî –õ–ö–ú / –ü–ö–ú
    [
        { el: ui.loadCabinet,       key: 'communicationCabinet' },
        { el: ui.loadCommLine,      key: 'communicationLine' },
        { el: ui.loadStreetLamp,    key: 'streetLamp' },
        { el: ui.loadVolsMuffle,    key: 'volsMuffle' },
        { el: ui.loadStreetLantern, key: 'streetLantern' },
        { el: ui.loadVoltageLines,  key: 'voltageLines' },
    ].forEach(({ el, key }) => {
        el.addEventListener('click', e => {
            if (e.button !== 0) return;
            db.additionalLoad[key]++;
            if (key === 'streetLamp') db.lamps.push({ type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' });
            saveDb(); updateUI();
            showNotification(`+1 ${el.querySelector('.load-tile-name').textContent.trim()}`);
        });
        el.addEventListener('contextmenu', e => {
            e.preventDefault();
            if (db.additionalLoad[key] > 0) {
                db.additionalLoad[key]--;
                if (key === 'streetLamp' && db.lamps.length > 0) db.lamps.pop();
                saveDb(); updateUI();
            }
        });
    });

    // –ü—Ä–∏—Å—Ç–∞–≤–∫–∏ (–º–æ–¥–∞–ª–∫–∞)
    ui.btnAtUp.addEventListener('click',   () => { db.attachments.count++; ui.dispAttach.textContent = db.attachments.count; saveDb(); });
    ui.btnAtDown.addEventListener('click', () => { if (db.attachments.count > 0) { db.attachments.count--; ui.dispAttach.textContent = db.attachments.count; saveDb(); } });
    ui.selAttachMat.addEventListener('change', e => { db.attachments.material = e.target.value; saveDb(); });
    ui.btnCancAtch.addEventListener('click',  () => ui.modalAttach.classList.remove('show'));
    ui.btnConfAtch.addEventListener('click',  () => { ui.modalAttach.classList.remove('show'); afterAttachments(); });

    // –§–æ–Ω–∞—Ä–∏ (–º–æ–¥–∞–ª–∫–∞)
    ui.btnCancLamps.addEventListener('click', () => ui.modalLamps.classList.remove('show'));
    ui.btnConfLamps.addEventListener('click', () => { ui.modalLamps.classList.remove('show'); startFill(); });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –∫–ª–∏–∫–æ–º –∑–∞ –∏—Ö –ø—Ä–µ–¥–µ–ª–∞–º–∏
    [ui.modalAttach, ui.modalLamps].forEach(m =>
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); })
    );
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') [ui.modalAttach, ui.modalLamps].forEach(m => m.classList.remove('show'));
    });

    /******************************************************************
     * –ì–ï–ù–ï–†–ê–¶–ò–Ø UI –î–õ–Ø –§–û–ù–ê–†–ï–ô
     ******************************************************************/
    function genLampsUI() {
        ui.lampsConfig.innerHTML = db.lamps.map((lamp, i) => `
            <div class="lamp-card">
                <div class="lamp-card-title">üí° –§–æ–Ω–∞—Ä—å ${i + 1}</div>
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–¢–∏–ø –ª–∞–º–ø—ã</label>
                    <select class="field-select lamp-type" data-i="${i}">
                        ${LAMP_TYPES.map(t => `<option value="${t}" ${lamp.type===t?'selected':''}>${t}</option>`).join('')}
                    </select>
                </div>
                ${lamp.type === '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é' ? `
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø</label>
                    <input type="text" class="field-input lamp-custom" data-i="${i}" value="${lamp.customType||''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–†–í-250">
                </div>` : ''}
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–ö—Ä–µ–ø–ª–µ–Ω–∏–µ</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" class="radio-input lamp-mount" id="m${i}a" name="m${i}" value="–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π"  ${lamp.mounting==='–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π' ?'checked':''} data-i="${i}"><label class="radio-label" for="m${i}a">–ü—Ä–∏—Å—Ç–∞–≤–Ω–æ–π</label></div>
                        <div class="radio-option"><input type="radio" class="radio-input lamp-mount" id="m${i}b" name="m${i}" value="–∫–æ–Ω—Å–æ–ª—å–Ω—ã–π" ${lamp.mounting==='–∫–æ–Ω—Å–æ–ª—å–Ω—ã–π'?'checked':''} data-i="${i}"><label class="radio-label" for="m${i}b">–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π</label></div>
                    </div>
                </div>
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–ü–∏—Ç–∞–Ω–∏–µ</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" class="radio-input lamp-power" id="p${i}a" name="p${i}" value="–ö–∞–±–µ–ª—å" ${lamp.powerSupply==='–ö–∞–±–µ–ª—å'?'checked':''} data-i="${i}"><label class="radio-label" for="p${i}a">–ö–∞–±–µ–ª—å</label></div>
                        <div class="radio-option"><input type="radio" class="radio-input lamp-power" id="p${i}b" name="p${i}" value="–ü—Ä–æ–≤–æ–¥" ${lamp.powerSupply==='–ü—Ä–æ–≤–æ–¥'?'checked':''} data-i="${i}"><label class="radio-label" for="p${i}b">–ü—Ä–æ–≤–æ–¥</label></div>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                    <select class="field-select lamp-dir" data-i="${i}">
                        <option value="–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏" ${lamp.direction==='–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏'?'selected':''}>–ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏</option>
                        <option value="–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ"           ${lamp.direction==='–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ'          ?'selected':''}>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ</option>
                        <option value="–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏"     ${lamp.direction==='–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏'    ?'selected':''}>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏</option>
                    </select>
                </div>
            </div>`).join('');

        shadow.querySelectorAll('.lamp-type').forEach(s   => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].type        = e.target.value; saveDb(); genLampsUI(); }));
        shadow.querySelectorAll('.lamp-custom').forEach(s => s.addEventListener('input',  e => { const i = +e.target.dataset.i; db.lamps[i].customType  = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-mount').forEach(s  => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].mounting    = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-power').forEach(s  => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].powerSupply = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-dir').forEach(s    => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].direction   = e.target.value; saveDb(); }));
    }

    /******************************************************************
     * –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –°–ê–ô–¢–ê
     ******************************************************************/
    ui.btnScan.addEventListener('click', async () => {
        ui.btnScan.disabled = true;
        ui.btnScan.innerHTML = '<span>‚è≥</span><span>–°–∫–∞–Ω–∏—Ä—É—é...</span>';
        try {
            await loadFromForm();
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞–Ω—ã —Å —Å–∞–π—Ç–∞', 'success');
        } catch (err) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏', 'error');
        } finally {
            ui.btnScan.disabled = false;
            ui.btnScan.innerHTML = '<span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>';
        }
    });

    /******************************************************************
     * –ö–ù–û–ü–ö–ê –ó–ê–ü–û–õ–ù–ò–¢–¨
     ******************************************************************/
    ui.btnFill.addEventListener('click', async () => {
        clearLogs();
        log('üöÄ –ó–∞–ø—É—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–æ—Ä—ã...', 'info');
        if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è') {
            ui.dispAttach.textContent = db.attachments.count;
            ui.selAttachMat.value     = db.attachments.material;
            ui.modalAttach.classList.add('show');
        } else {
            db.attachments.count = 0;
            afterAttachments();
        }
    });

    async function afterAttachments() {
        if (db.additionalLoad.streetLamp > 0) { genLampsUI(); ui.modalLamps.classList.add('show'); }
        else startFill();
    }

    /******************************************************************
     * –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø
     ******************************************************************/
    async function startFill() {
        ui.btnFill.disabled = true;
        ui.btnFill.innerHTML = '<span>‚è≥</span><span>–ó–∞–ø–æ–ª–Ω—è—é...</span>';
        showNotification('‚è≥ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'warning');
        try {
            log('‚ïê'.repeat(45), 'info');
            log('v1.8.1 ‚Äî –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä—ã', 'info');
            log('‚ïê'.repeat(45), 'info');

            // –ú–∞—Ä–∫–∞ –æ–ø–æ—Ä—ã
            if (db.pillar.type) {
                const cur = document.querySelector('fieldset[name="pillarType"] .smwb-select-field__values');
                if (!cur || cur.textContent.trim() !== db.pillar.type)
                    await clickReactSelect('fieldset[name="pillarType"] .smwb-select-field', db.pillar.type);
                log(`–ú–∞—Ä–∫–∞: ${db.pillar.type}`, 'success');
                await sleep(150);
            }

            await fillField('input[name="constructionType"]', db.pillar.constructionType, '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤');
            await sleep(150);
            await fillField('input[name="placement"]', db.pillar.placement, '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
            await sleep(150);
            await fillField('input[name="material"]', db.pillar.material, '–ú–∞—Ç–µ—Ä–∏–∞–ª');
            await sleep(150);

            if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è')
                await fillField('input[name="woodTemporaryType"]', '–±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏', '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ü–∏—è');
            await sleep(150);

            // –°—Ç–æ–π–∫–∏
            log(`\n=== –°–¢–û–ô–ö–ò (${db.stands.count}) ===`, 'info');
            if (await setCounter('input[name="stand.count"]', db.stands.count) && db.stands.count > 0) {
                await sleep(600);
                for (let i = 0; i < db.stands.count; i++) {
                    log(`–°—Ç–æ–π–∫–∞ ${i+1}/${db.stands.count}`, 'info');
                    await goToSlide(i); await sleep(200);
                    await fillField(`input[name="stand.info[${i}].material"]`, db.stands.material, `–ú–∞—Ç. —Å—Ç–æ–π–∫–∏ ${i+1}`);
                    await sleep(100);
                    await clickCamera(`fieldset[name="stand.info[${i}].photoUrls"] button.smwb-fab`);
                    await sleep(100);
                }
            }

            // –£–∫–æ—Å—ã
            if (db.bracing.count > 0) {
                log(`\n=== –£–ö–û–°–´ (${db.bracing.count}) ===`, 'info');
                if (await setCounter('input[name="bracing.count"]', db.bracing.count)) {
                    await sleep(600);
                    for (let i = 0; i < db.bracing.count; i++) {
                        log(`–£–∫–æ—Å ${i+1}/${db.bracing.count}`, 'info');
                        await goToSlide(i); await sleep(200);
                        await fillField(`input[name="bracing.info[${i}].material"]`, db.bracing.material, `–ú–∞—Ç. —É–∫–æ—Å–∞ ${i+1}`);
                        await sleep(100);
                        await clickCamera(`fieldset[name="bracing.info[${i}].photoUrls"] button.smwb-fab`);
                        await sleep(100);
                    }
                }
            }

            // –ü—Ä–∏—Å—Ç–∞–≤–∫–∏
            if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è' && db.attachments.count > 0) {
                log(`\n=== –ü–†–ò–°–¢–ê–í–ö–ò (${db.attachments.count}) ===`, 'info');
                if (await setCounter('input[name="attachment.count"]', db.attachments.count)) {
                    await sleep(600);
                    for (let i = 0; i < db.attachments.count; i++) {
                        log(`–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ ${i+1}/${db.attachments.count}`, 'info');
                        await goToSlide(i); await sleep(200);
                        await fillField(`input[name="attachment.info[${i}].material"]`, db.attachments.material, `–ú–∞—Ç. –ø—Ä–∏—Å—Ç. ${i+1}`);
                        await sleep(100);
                        await clickCamera(`fieldset[name="attachment.info[${i}].photoUrls"] button.smwb-fab`);
                        await sleep(100);
                    }
                }
            }

            // –ù–∞–≥—Ä—É–∑–∫–∏
            await syncLoads();

            log('\n‚úÖ –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û', 'success');
            showNotification('‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!', 'success');

        } catch (err) {
            log(`‚ùå –û–®–ò–ë–ö–ê: ${err.message}`, 'error');
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
        } finally {
            ui.btnFill.disabled = false;
            ui.btnFill.innerHTML = '<span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>';
        }
    }

    /******************************************************************
     * –ú–ò–ù–ò–ú–ò–ó–ê–¶–ò–Ø + –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï
     ******************************************************************/
    ui.btnMin.addEventListener('click', () => {
        db.ui.isCollapsed = !db.ui.isCollapsed;
        ui.body.style.display = db.ui.isCollapsed ? 'none' : 'flex';
        ui.collapsedInfo.classList.toggle('visible', db.ui.isCollapsed);
        ui.btnMin.textContent = db.ui.isCollapsed ? '+' : '‚àí';
        saveDb();
    });

    let dragging = false, ox, oy;
    shadow.querySelector('#dragHandle').addEventListener('mousedown', e => {
        dragging = true; ox = e.clientX - ui.main.offsetLeft; oy = e.clientY - ui.main.offsetTop;
        ui.main.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e => {
        if (dragging) { ui.main.style.left = (e.clientX - ox) + 'px'; ui.main.style.top = (e.clientY - oy) + 'px'; }
    });
    document.addEventListener('mouseup', () => {
        if (dragging) {
            dragging = false; ui.main.style.cursor = '';
            db.ui.pos = { x: parseInt(ui.main.style.left), y: parseInt(ui.main.style.top) }; saveDb();
        }
    });

    /******************************************************************
     * DISCORD
     ******************************************************************/
    ui.discordLink.addEventListener('click', e => {
        e.preventDefault();
        window.open('https://discord.gg/RC6HhTqCdR', '_blank');
    });

    /******************************************************************
     * –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨ –ó–ê –§–û–†–ú–û–ô (–∞–≤—Ç–æ show/hide)
     ******************************************************************/
    function isPillarForm() {
        return !!(
            document.querySelector('fieldset[name="pillarType"]') ||
            document.querySelector('input[name="constructionType"]') ||
            document.querySelector('input[name="stand.count"]')
        );
    }

    function checkFormPresence() {
        const visible = isPillarForm();
        host.style.display = (visible && !window.pillarManuallyHidden) ? 'block' : 'none';
    }

    function startFormObserver() {
        checkFormPresence();
        const observer = new MutationObserver(() => checkFormPresence());
        observer.observe(document.body, { childList: true, subtree: true });
    }

    /******************************************************************
     * –ì–û–†–Ø–ß–ê–Ø –ö–õ–ê–í–ò–®–ê ALT+–û ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å
     ******************************************************************/
    window.pillarManuallyHidden = false;
    document.addEventListener('keydown', e => {
        if (e.altKey && e.key.toLowerCase() === '–æ') {
            e.preventDefault();
            window.pillarManuallyHidden = !window.pillarManuallyHidden;
            checkFormPresence();
            const msg = window.pillarManuallyHidden ? 'üôà –û–ø–æ—Ä—ã —Å–∫—Ä—ã—Ç—ã. ALT+–û –¥–ª—è –ø–æ–∫–∞–∑–∞' : '‚úÖ –û–ø–æ—Ä—ã –ø–æ–∫–∞–∑–∞–Ω—ã. ALT+–û –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è';
            const n = document.createElement('div');
            n.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,rgba(139,92,246,0.95),rgba(0,0,0,0.95));border:1px solid rgba(139,92,246,0.5);border-radius:10px;padding:12px 16px;color:#fff;font-size:12px;font-family:-apple-system,sans-serif;z-index:1000001;box-shadow:0 8px 24px rgba(0,0,0,0.5);max-width:280px;`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }
    });

    /******************************************************************
     * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
     ******************************************************************/
    ui.main.style.left = db.ui.pos.x + 'px';
    ui.main.style.top  = db.ui.pos.y + 'px';
    if (db.ui.isCollapsed) {
        ui.body.style.display = 'none';
        ui.collapsedInfo.classList.add('visible');
        ui.btnMin.textContent = '+';
    }

    initSelects();
    updateUI();
    startDetection();
    startFormObserver();

    console.log('‚úÖ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä v1.8.1 –≥–æ—Ç–æ–≤! | Created by KAST Team');
    console.log('üí° –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: ALT+–û ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å UI');
})();
