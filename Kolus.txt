// ==UserScript==
// @name         KOLUS - –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º
// @namespace    kolus.ultimate
// @version      1.6.0
// @description  –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏ —É–º–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º | Created by KAST Team
// @match        https://moe2.agentumit.ru/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    console.log('üöÄ KOLUS v1.6.0 –∑–∞–≥—Ä—É–∂–µ–Ω | Created by KAST Team');

    const STORAGE_KEY = 'kolus_ultimate_v1';

    const WIRE_DATABASE = [
        '–°–ò–ü 2—Ö16', '–°–ò–ü 4—Ö16', '–°–ò–ü 4—Ö25', '–°–ò–ü 4—Ö35', '–°–ò–ü 4—Ö50', '–°–ò–ü 4—Ö70', '–°–ò–ü 4—Ö95', '–°–ò–ü 4—Ö120', '–°–ò–ü 4—Ö150',
        '–°–ò–ü 3—Ö25', '–°–ò–ü 3—Ö35', '–°–ò–ü 3—Ö50', '–°–ò–ü 3—Ö70', '–°–ò–ü 3—Ö95', '–°–ò–ü 3—Ö120',
        '–ê-16', '–ê-25', '–ê-35', '–ê-50', '–ê-70', '–ê-95', '–ê-120', '–ê-150', '–ê-185', '–ê-240',
        '–ê 16', '–ê 25', '–ê 35', '–ê 50', '–ê 70', '–ê 95', '–ê 120', '–ê 150', '–ê 185', '–ê 240',
        '–ê–°-16/2.7', '–ê–°-25/4.2', '–ê–°-35/6.2', '–ê–°-50/8', '–ê–°-70/11', '–ê–°-95/16', '–ê–°-120/19', '–ê–°-150/24', '–ê–°-185/29', '–ê–°-240/32',
        '–ê–í–í–ì 2—Ö2.5', '–ê–í–í–ì 2—Ö4', '–ê–í–í–ì 2—Ö6', '–ê–í–í–ì 2—Ö10', '–ê–í–í–ì 2—Ö16', '–ê–í–í–ì 2—Ö25', '–ê–í–í–ì 2—Ö35',
        '–ê–í–í–ì 3—Ö2.5', '–ê–í–í–ì 3—Ö4', '–ê–í–í–ì 3—Ö6', '–ê–í–í–ì 3—Ö10', '–ê–í–í–ì 3—Ö16', '–ê–í–í–ì 3—Ö25', '–ê–í–í–ì 3—Ö35',
        '–ê–í–í–ì 4—Ö2.5', '–ê–í–í–ì 4—Ö4', '–ê–í–í–ì 4—Ö6', '–ê–í–í–ì 4—Ö10', '–ê–í–í–ì 4—Ö16', '–ê–í–í–ì 4—Ö25', '–ê–í–í–ì 4—Ö35', '–ê–í–í–ì 4—Ö50', '–ê–í–í–ì 4—Ö70',
        '–ê–í–í–ì 5—Ö2.5', '–ê–í–í–ì 5—Ö4', '–ê–í–í–ì 5—Ö6', '–ê–í–í–ì 5—Ö10', '–ê–í–í–ì 5—Ö16', '–ê–í–í–ì 5—Ö25',
        '–í–í–ì 2—Ö1.5', '–í–í–ì 2—Ö2.5', '–í–í–ì 2—Ö4', '–í–í–ì 2—Ö6', '–í–í–ì 2—Ö10', '–í–í–ì 2—Ö16', '–í–í–ì 2—Ö25',
        '–í–í–ì 3—Ö1.5', '–í–í–ì 3—Ö2.5', '–í–í–ì 3—Ö4', '–í–í–ì 3—Ö6', '–í–í–ì 3—Ö10', '–í–í–ì 3—Ö16', '–í–í–ì 3—Ö25', '–í–í–ì 3—Ö35',
        '–í–í–ì 4—Ö1.5', '–í–í–ì 4—Ö2.5', '–í–í–ì 4—Ö6', '–í–í–ì 4—Ö10', '–í–í–ì 4—Ö16', '–í–í–ì 4—Ö25', '–í–í–ì 4—Ö35', '–í–í–ì 4—Ö50',
        '–í–í–ì 5—Ö1.5', '–í–í–ì 5—Ö2.5', '–í–í–ì 5—Ö4', '–í–í–ì 5—Ö6', '–í–í–ì 5—Ö10', '–í–í–ì 5—Ö16', '–í–í–ì 5—Ö25',
        '–ü–£–ì–í 1—Ö1.5', '–ü–£–ì–í 1—Ö2.5', '–ü–£–ì–í 1—Ö4', '–ü–£–ì–í 1—Ö6', '–ü–£–ì–í 1—Ö10', '–ü–£–ì–í 1—Ö16', '–ü–£–ì–í 1—Ö25', '–ü–£–ì–í 1—Ö35', '–ü–£–ì–í 1—Ö50', '–ü–£–ì–í 1—Ö70', '–ü–£–ì–í 1—Ö95', '–ü–£–ì–í 1—Ö120',
        '–ü–í-1 1.5', '–ü–í-1 2.5', '–ü–í-1 4', '–ü–í-1 6', '–ü–í-1 10', '–ü–í-1 16', '–ü–í-1 25', '–ü–í-1 35', '–ü–í-1 50',
        '–ü–í-3 1.5', '–ü–í-3 2.5', '–ü–í-3 4', '–ü–í-3 6', '–ü–í-3 10', '–ü–í-3 16', '–ü–í-3 25', '–ü–í-3 35',
        '–ê–ü–í 2.5', '–ê–ü–í 4', '–ê–ü–í 6', '–ê–ü–í 10', '–ê–ü–í 16', '–ê–ü–í 25', '–ê–ü–í 35', '–ê–ü–í 50', '–ê–ü–í 70', '–ê–ü–í 95', '–ê–ü–í 120',
        '–ü–í–° 2—Ö0.75', '–ü–í–° 2—Ö1.5', '–ü–í–° 2—Ö2.5', '–ü–í–° 3—Ö0.75', '–ü–í–° 3—Ö1.5', '–ü–í–° 3—Ö2.5', '–ü–í–° 4—Ö1.5', '–ü–í–° 4—Ö2.5',
        'NYM 2—Ö1.5', 'NYM 2—Ö2.5', 'NYM 3—Ö1.5', 'NYM 3—Ö2.5', 'NYM 4—Ö1.5', 'NYM 5—Ö1.5',
        '–ö–í–í–ì 4—Ö1.5', '–ö–í–í–ì 4—Ö2.5', '–ö–í–í–ì 7—Ö1.5', '–ö–í–í–ì 14—Ö1.5', '–ö–í–í–ì 19—Ö1.5',
        '–ö–ì 3—Ö2.5', '–ö–ì 3—Ö4', '–ö–ì 3—Ö6', '–ö–ì 3—Ö10', '–ö–ì 3—Ö16', '–ö–ì 3—Ö25'
    ];

    const defaultData = {
        wireLength: '',
        clearance: '5.0',
        fastening: '–ù–∞—Ç—è–∂–Ω–æ–µ',
        crossingObject: '–î–µ—Ä–µ–≤–æ',
        couplingCount: '0',  // –î–æ–±–∞–≤–ª–µ–Ω–æ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ñ—Ç
        presets: [
            { id: 'p1', name: '‚ö° –°–ò–ü –ù–∞—Ç—è–∂–∫–∞',  wireBrand: '–°–ò–ü 4—Ö50', roadType: '–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è', construction: '–í–õ', terrain: '–Ω–∞—Å–µ–ª–µ–Ω–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å', designation: '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å' },
            { id: 'p2', name: 'üîß –°–ò–ü –ü–æ–¥–¥–µ—Ä–∂–∫–∞', wireBrand: '–°–ò–ü 4—Ö50', roadType: '–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è', construction: '–í–õ', terrain: '–Ω–∞—Å–µ–ª–µ–Ω–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å', designation: '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å' },
            { id: 'p3', name: 'üèôÔ∏è –ì–æ—Ä–æ–¥',         wireBrand: '–°–ò–ü 4—Ö25', roadType: '–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è', construction: '–í–õ', terrain: '–Ω–∞—Å–µ–ª–µ–Ω–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å', designation: '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å' }
        ],
        activeId: 'p1',
        isCrossingEnabled: true,
        pos: { x: 20, y: 20 },
        isCollapsed: false,
        isVisible: true,
        scale: 100,
        compactMode: false
    };

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;

    // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (!db.wireLength && db.wireLength !== '') db.wireLength = '';
    if (!db.fastening) db.fastening = '–ù–∞—Ç—è–∂–Ω–æ–µ';
    if (!db.crossingObject) {
        const firstPreset = db.presets && db.presets[0];
        db.crossingObject = (firstPreset && firstPreset.crossingObject) || '–î–µ—Ä–µ–≤–æ';
    }
    if (db.clearance === undefined) db.clearance = '5.0';
    if (db.couplingCount === undefined) db.couplingCount = '0';  // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
    if (db.presets && db.presets.length > 0) {
        db.presets = db.presets.map(p => {
            if (Array.isArray(p.fastenings)) delete p.fastenings;
            delete p.fastening; delete p.wireLength; delete p.clearance;
            delete p.crossingType; delete p.crossingObject;
            return p;
        });
    }
    if (db.scale === undefined) db.scale = 100;
    if (db.isVisible === undefined) db.isVisible = true;
    if (db.compactMode === undefined) db.compactMode = false;

    const saveDb = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    const getActive = () => db.presets.find(p => p.id === db.activeId) || db.presets[0];

    /******************************************************************
     * –ü–†–û–í–ï–†–ö–ê –¢–ò–ü–ê –§–û–†–ú–´
     ******************************************************************/
    function isWireForm() {
        return !!(
            document.querySelector('fieldset[name="cableType"]') ||
            document.querySelector('input[name="cableType"]') ||
            document.querySelector('input[name="wireTension"]') ||
            document.querySelector('input[name="phaseCount"]') ||
            document.querySelector('input[name="designation"]')
        );
    }

    function checkFormTypeAndInitialize() {
        if (window.kolusUIInitialized) return true;
        if (!isWireForm()) {
            console.log('‚ö†Ô∏è KOLUS: –§–æ—Ä–º–∞ —Å—Ç–æ–ª–±–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, —Å–∫—Ä–∏–ø—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            return false;
        }
        console.log('‚úÖ KOLUS: –§–æ—Ä–º–∞ –ø—Ä–æ–≤–æ–¥–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        return true;
    }

    /******************************************************************
     * –£–¢–ò–õ–ò–¢–´
     ******************************************************************/
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function findSimilarWires(input) {
        if (!input || input.length < 1) return [];
        const normalized = input.toLowerCase().trim();
        return WIRE_DATABASE.filter(wire => wire.toLowerCase().includes(normalized)).slice(0, 5);
    }

    function wireMatches(wire1, wire2) {
        if (!wire1 || !wire2) return false;
        const n1 = wire1.toLowerCase().replace(/\s+/g, '').replace(/[-_]/g, '');
        const n2 = wire2.toLowerCase().replace(/\s+/g, '').replace(/[-_]/g, '');
        if (wire1 == '') {
            return true;
        }
        return n1 === n2;
    }

    function isWireTypeA(wireBrand) {
        if (!wireBrand) return false;
        const n = wireBrand.trim().toUpperCase();
        return (/^–ê[\s-]\d+/.test(n) || /^A[\s-]\d+/.test(n)) &&
               !n.startsWith('–ê–°') && !n.startsWith('AC') &&
               !n.startsWith('–ê–í') && !n.startsWith('AB') &&
               !n.startsWith('–ê–ü') && !n.startsWith('AP');
    }

    function isWireTypeAC(wireBrand) {
        if (!wireBrand) return false;
        const n = wireBrand.trim().toUpperCase();
        return n.startsWith('–ê–°') || n.startsWith('AC');
    }

    function isWireTypeAorAC(wireBrand) {
        return isWireTypeA(wireBrand) || isWireTypeAC(wireBrand);
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –°–ò–ü 2—Ö16
    function isSIP2x16(wireBrand) {
        if (!wireBrand) return false;
        const normalized = wireBrand.trim().toUpperCase().replace(/\s+/g, '').replace(/[-_]/g, '');
        return normalized === '–°–ò–ü2–•16' || normalized === '–°–ò–ü2X16';
    }

    /******************************************************************
     * –†–ê–ë–û–¢–ê –° –°–ê–ô–¢–û–ú
     ******************************************************************/
    function setReactInputValue(input, value) {
        if (!input) return false;
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
            nativeSetter.call(input, value);
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            return true;
        } catch(e) {
            console.warn('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è:', e);
            return false;
        }
    }

    async function waitForInput(selector, timeout = 5000) {
        const start = Date.now();
        let input = document.querySelector(selector);
        while (!input && Date.now() - start < timeout) {
            await sleep(200);
            input = document.querySelector(selector);
        }
        return input;
    }

    async function selectWireBrandReact(value) {
        const select = document.querySelector('fieldset[name="cableType"] .smwb-select-field');
        if (!select) {
            console.warn('–°–µ–ª–µ–∫—Ç –º–∞—Ä–∫–∏ –ø—Ä–æ–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return false;
        }
        ['mousedown', 'mouseup', 'click'].forEach(t =>
            select.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(300);
        let option = null;
        for (let i = 0; i < 50; i++) {
            option = [...document.querySelectorAll('.smwb-menu__item')].find(o => o.textContent.trim() === value);
            if (option) break;
            await sleep(100);
        }
        if (option) {
            ['mousedown', 'mouseup', 'click'].forEach(t =>
                option.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
            );
            await sleep(200);
            return true;
        }
        console.warn('–ú–∞—Ä–∫–∞ –ø—Ä–æ–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ:', value);
        return false;
    }

    function scanSiteData() {
        const data = {};
        const wireEl = document.querySelector('fieldset[name="cableType"] .smwb-select-field span') ||
                       document.querySelector('input[name="cableType"]');
        if (wireEl) data.wireBrand = (wireEl.textContent || wireEl.value || '').trim();
        const fasteningEl = document.querySelector('input[name="fastening.type"]');
        if (fasteningEl) data.fastening = fasteningEl.value;
        const terrainEl = document.querySelector('input[name="areaType"]');
        if (terrainEl) data.terrain = terrainEl.value;
        const roadEl = document.querySelector('input[name="roadType"]');
        if (roadEl) data.roadType = roadEl.value;
        const constructionEl = document.querySelector('input[name="construction"]');
        if (constructionEl) data.construction = constructionEl.value;
        const crossObjEl = document.querySelector('input[name="crossing.object"]');
        if (crossObjEl) data.crossingObject = crossObjEl.value;
        const lengthSelectors = ['input[name*="length"]','input[name*="wireLength"]','input[name*="cableLength"]','input[placeholder*="–º–µ—Ç—Ä"]','input[placeholder*="–¥–ª–∏–Ω"]','[data-name*="length"] input','fieldset[name*="length"] input'];
        for (const sel of lengthSelectors) {
            const el = document.querySelector(sel);
            if (el && el.value && !isNaN(parseFloat(el.value))) { data.wireLength = el.value; break; }
        }
        return data;
    }

    /******************************************************************
     * –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨ –ó–ê –§–û–†–ú–û–ô (–∞–≤—Ç–æ show/hide)
     ******************************************************************/
    function startFormObserver() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI –æ–¥–∏–Ω —Ä–∞–∑ (—Å–∫—Ä—ã—Ç—ã–º)
        initializeUI();

        function checkFormPresence() {
            const formVisible = isWireForm();
            const host = document.getElementById('kolus-ui-host');
            if (!host) return;
            if (formVisible && !window.kolusManuallyHidden) {
                host.style.display = 'block';
            } else {
                host.style.display = 'none';
            }
        }

        // –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        checkFormPresence();

        // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ DOM
        const observer = new MutationObserver(() => checkFormPresence());
        observer.observe(document.body, { childList: true, subtree: true });
    }

    /******************************************************************
     * UI (SHADOW DOM)
     ******************************************************************/
    function initializeUI() {
        if (window.kolusUIInitialized) { console.log('‚ö†Ô∏è KOLUS: UI —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
        window.kolusUIInitialized = true;

        const host = document.createElement('div');
        host.id = 'kolus-ui-host';
        document.body.appendChild(host);
        const shadow = host.attachShadow({ mode: 'open' });

        const css = `
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        .root { position: fixed; width: 360px; background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; z-index: 1000000; box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1); color: #fff; overflow: hidden; animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: top left; display: flex; flex-direction: column; max-height: 90vh; }
        .header { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 14px 16px; cursor: move; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); user-select: none; flex-shrink: 0; }
        .header-title { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 15px; letter-spacing: 0.5px; }
        .header-icon { width: 20px; height: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .header-btn { width: 28px; height: 28px; border-radius: 6px; background: rgba(255,255,255,0.1); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; line-height: 1; }
        .header-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .collapsed-info { padding: 12px 16px; display: none; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.2); }
        .collapsed-info.visible { display: flex; }
        .collapsed-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .collapsed-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; }
        .collapsed-value { font-weight: 700; font-size: 12px; padding: 3px 8px; border-radius: 5px; background: rgba(0,0,0,0.3); }
        .collapsed-value.match-green { background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
        .collapsed-value.match-red { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        .collapsed-value.match-yellow { background: rgba(234,179,8,0.2); color: #eab308; border: 1px solid rgba(234,179,8,0.3); animation: pulse 2s infinite; }
        .body { padding: 16px; padding-bottom: 90px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; flex: 1; }
        .body::-webkit-scrollbar { width: 6px; }
        .body::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .body::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 3px; }
        .body::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.7); }
        .status-panel { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .status-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .status-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; }
        .status-value { font-weight: 700; font-size: 13px; padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); transition: all 0.3s; }
        .status-value.match-green { background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
        .status-value.match-red { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        .status-value.match-yellow { background: rgba(234,179,8,0.2); color: #eab308; border: 1px solid rgba(234,179,8,0.3); animation: pulse 2s infinite; }
        .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); margin: 4px 0; }
        .field-group { display: flex; flex-direction: column; gap: 6px; }
        .field-label { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; }
        .field-label-icon { font-size: 14px; }
        .field-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 10px 14px; color: #fff; font-size: 13px; transition: all 0.2s; outline: none; font-family: inherit; }
        .field-input::placeholder { color: rgba(255,255,255,0.4); }
        .field-input:focus { border-color: rgba(139,92,246,0.6); background: rgba(0,0,0,0.4); box-shadow: 0 0 0 3px rgba(139,92,246,0.1); }
        .field-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .preset-controls { display: flex; gap: 6px; }
        .preset-controls .field-input { flex: 1; }
        .preset-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: rgba(139,92,246,0.2); color: #8b5cf6; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; flex-shrink: 0; }
        .preset-btn:hover { background: rgba(139,92,246,0.3); transform: translateY(-1px); }
        .preset-btn.add { background: rgba(34,197,94,0.2); color: #22c55e; }
        .preset-btn.add:hover { background: rgba(34,197,94,0.3); }
        .preset-btn.delete { background: rgba(239,68,68,0.2); color: #ef4444; }
        .preset-btn.delete:hover { background: rgba(239,68,68,0.3); }
        .preset-btn.edit { background: rgba(234,179,8,0.2); color: #eab308; }
        .preset-btn.edit:hover { background: rgba(234,179,8,0.3); }
        .clearance-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; }
        .clearance-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; }
        .clearance-controls { display: flex; align-items: center; gap: 8px; }
        .clearance-input { width: 60px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 6px 10px; color: #fff; font-size: 14px; font-weight: 700; text-align: center; outline: none; }
        .clearance-input:focus { border-color: rgba(139,92,246,0.6); box-shadow: 0 0 0 3px rgba(139,92,246,0.1); }
        .clearance-btn { width: 28px; height: 28px; border-radius: 6px; border: none; background: rgba(139,92,246,0.2); color: #8b5cf6; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; transition: all 0.2s; }
        .clearance-btn:hover { background: rgba(139,92,246,0.3); transform: scale(1.05); }
        .radio-group { display: flex; gap: 6px; flex-wrap: wrap; }
        .radio-option { flex: 1; min-width: calc(33.33% - 4px); }
        .radio-input { display: none; }
        .radio-label { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; }
        .radio-label:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
        .radio-input:checked + .radio-label { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.6); color: #a78bfa; }
        .radio-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .radio-input:checked + .radio-label .radio-dot { border-color: #8b5cf6; background: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.2); }
        .radio-input:checked + .radio-label .radio-dot::after { content: ''; width: 6px; height: 6px; border-radius: 50%; background: #fff; }
        .toggle-section { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.2s; }
        .toggle-section:hover { background: rgba(0,0,0,0.4); }
        .toggle-switch { position: relative; width: 50px; height: 26px; flex-shrink: 0; }
        .toggle-input { display: none; }
        .toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 13px; transition: 0.3s; cursor: pointer; }
        .toggle-slider::before { content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-input:checked + .toggle-slider { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .toggle-input:checked + .toggle-slider::before { transform: translateX(24px); }
        .toggle-label { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; flex: 1; pointer-events: none; }
        .toggle-status { margin-left: auto; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .toggle-status.active { background: rgba(34,197,94,0.2); color: #22c55e; }
        .toggle-status.inactive { background: rgba(239,68,68,0.2); color: #ef4444; }
        .crossing-fields { display: flex; flex-direction: column; gap: 12px; margin-top: 8px; transition: all 0.3s; }
        .crossing-fields.hidden { opacity: 0; max-height: 0; overflow: hidden; margin-top: 0; pointer-events: none; }
        .crossing-objects { display: flex; flex-wrap: wrap; gap: 6px; }
        .crossing-obj-option { flex: 1; min-width: calc(50% - 3px); }
        .crossing-obj-input { display: none; }
        .crossing-obj-label { display: flex; align-items: center; justify-content: center; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 11px; font-weight: 500; text-align: center; }
        .crossing-obj-label:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
        .crossing-obj-input:checked + .crossing-obj-label { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.6); color: #a78bfa; }
        .crossing-obj-input:disabled + .crossing-obj-label { opacity: 0.4; cursor: not-allowed; }
        .footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.4)); display: flex; gap: 8px; backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); }
        .btn { flex: 1; padding: 12px 20px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn:disabled:hover { transform: none; }
        .btn-fill { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; box-shadow: 0 4px 12px rgba(139,92,246,0.3); }
        .btn-fill:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139,92,246,0.4); }
        .btn-scan { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.3)); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
        .btn-scan:hover:not(:disabled) { background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.4)); transform: translateY(-1px); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000001; animation: slideIn 0.2s ease-out; }
        .modal { background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 16px; padding: 24px; width: 90%; max-width: 360px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #fff; display: flex; align-items: center; gap: 8px; }
        .modal-content { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .modal-text { font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.5; }
        .modal-highlight { color: #8b5cf6; font-weight: 600; }
        .modal-buttons { display: flex; gap: 8px; }
        .modal-btn { flex: 1; padding: 12px 20px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .modal-btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; }
        .modal-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .modal-btn-secondary { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
        .modal-btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .suggestions { margin-top: 6px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; max-height: 200px; overflow-y: auto; animation: slideIn 0.2s ease-out; }
        .suggestions-title { padding: 8px 12px; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .suggestions-list { display: flex; flex-direction: column; }
        .suggestion-item { padding: 10px 12px; font-size: 13px; color: rgba(255,255,255,0.9); cursor: pointer; transition: all 0.15s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(0,0,0,0.95)); border: 1px solid rgba(34,197,94,0.5); border-radius: 12px; padding: 14px 18px; color: #fff; font-size: 13px; font-weight: 600; z-index: 1000002; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; max-width: 300px; }
        .notification-warning { background: linear-gradient(135deg, rgba(234,179,8,0.95), rgba(0,0,0,0.95)); border-color: rgba(234,179,8,0.5); }
        .notification-error { background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(0,0,0,0.95)); border-color: rgba(239,68,68,0.5); }
        .discord-link { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 12px; background: rgba(88,101,242,0.2); border: 1px solid rgba(88,101,242,0.3); border-radius: 10px; color: #5865f2; font-size: 11px; font-weight: 600; text-decoration: none; transition: all 0.2s; margin-top: 12px; }
        .discord-link:hover { background: rgba(88,101,242,0.3); transform: translateY(-1px); }
        .scale-controls { display: flex; align-items: center; gap: 6px; }
        .scale-btn { width: 24px; height: 24px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; transition: all 0.2s; }
        .scale-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .scale-value { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); min-width: 36px; text-align: center; }
        .settings-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; }
        .settings-bar-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; }
        .settings-toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .settings-toggle-input { display: none; }
        .settings-toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 12px; transition: 0.3s; cursor: pointer; }
        .settings-toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .settings-toggle-input:checked + .settings-toggle-slider { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .settings-toggle-input:checked + .settings-toggle-slider::before { transform: translateX(20px); }
        .root.compact { max-height: none; }
        .root.compact .body { max-height: none; overflow-y: visible; }
        `;

        const html = `
        <div class="root" id="mainPanel">
            <div class="header" id="dragHandle">
                <div class="header-title">
                    <div class="header-icon">‚ö°</div>
                    <span>KOLUS v1.6.0</span>
                </div>
                <div class="header-controls">
                    <div class="scale-controls">
                        <button class="scale-btn" id="btnScaleDown">‚àí</button>
                        <span class="scale-value" id="scaleValue">100%</span>
                        <button class="scale-btn" id="btnScaleUp">+</button>
                    </div>
                    <button class="header-btn" id="btnSettings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                    <button class="header-btn" id="btnMinimize">‚àí</button>
                </div>
            </div>

            <div class="collapsed-info" id="collapsedInfo">
                <div class="collapsed-row">
                    <span class="collapsed-label">üì° –ú–∞—Ä–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ</span>
                    <span class="collapsed-value match-yellow" id="collapsedWire">...</span>
                </div>
                <div class="collapsed-row">
                    <span class="collapsed-label">üéØ –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ—Å–µ—Ç</span>
                    <span class="collapsed-value" id="collapsedPreset" style="color:#8b5cf6;">‚Äî</span>
                </div>
            </div>

            <div class="body" id="bodyContent">
                <div class="status-panel">
                    <div class="status-row">
                        <span class="status-label">üì° –ú–∞—Ä–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ</span>
                        <span class="status-value match-yellow" id="statusWire">...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">üìã –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ—Å–µ—Ç</span>
                        <span class="status-value" id="statusPreset" style="color:#8b5cf6;">‚Äî</span>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üéØ</span>
                        –ü—Ä–µ—Å–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                    </label>
                    <div class="preset-controls">
                        <select class="field-input" id="presetSelect"></select>
                        <button class="preset-btn add"    id="btnAddPreset"    title="–°–æ–∑–¥–∞—Ç—å –ø—Ä–µ—Å–µ—Ç">+</button>
                        <button class="preset-btn edit"   id="btnEditPreset"   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="preset-btn delete" id="btnDeletePreset" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
                <div id="settingsPanel" style="display:none; flex-direction:column; gap:8px;">
                    <div class="settings-bar">
                        <span class="settings-bar-label">üìê –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)</span>
                        <label class="settings-toggle">
                            <input type="checkbox" class="settings-toggle-input" id="toggleCompact">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="divider"></div>
                </div>

                <div class="clearance-row">
                    <span class="clearance-label">üìè –ì–∞–±–∞—Ä–∏—Ç (–º) ‚Äî –¥–ª—è –≤—Å–µ—Ö</span>
                    <div class="clearance-controls">
                        <button class="clearance-btn" id="btnClearanceMinus">‚àí</button>
                        <input  type="number" class="clearance-input" id="inputClearance"
                                step="0.5" min="1.0" max="15.0" value="5.0">
                        <button class="clearance-btn" id="btnClearancePlus">+</button>
                    </div>
                </div>

                <!-- –ù–û–í–û–ï –ü–û–õ–ï: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ñ—Ç -->
                <div class="clearance-row">
                    <span class="clearance-label">üîå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ñ—Ç</span>
                    <div class="clearance-controls">
                        <button class="clearance-btn" id="btnCouplingMinus">‚àí</button>
                        <input  type="number" class="clearance-input" id="inputCouplingCount"
                                step="1" min="0" max="50" value="0">
                        <button class="clearance-btn" id="btnCouplingPlus">+</button>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üìê</span>
                        –î–ª–∏–Ω–∞ –ø—Ä–æ–≤–æ–¥–∞ (–º) ‚Äî –æ–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö
                    </label>
                    <input type="number" min="0" step="0.1" class="field-input" id="inputWireLength" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –ø—Ä–æ–≤–æ–¥–∞...">
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üîå</span>
                        –ú–∞—Ä–∫–∞ –ø—Ä–æ–≤–æ–¥–∞
                    </label>
                    <input type="text" class="field-input" id="inputWireBrand" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∞..." autocomplete="off">
                    <div id="wireSuggestions" class="suggestions" style="display:none;">
                        <div class="suggestions-title">üí° –ü–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</div>
                        <div class="suggestions-list" id="wireSuggestionsList"></div>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">‚öôÔ∏è</span>
                        –°–ø–æ—Å–æ–± –∫—Ä–µ–ø–ª–µ–Ω–∏—è ‚Äî –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="fasteningNatyazhnoe" name="fastening" value="–ù–∞—Ç—è–∂–Ω–æ–µ" checked>
                            <label class="radio-label" for="fasteningNatyazhnoe"><span class="radio-dot"></span><span>–ù–∞—Ç—è–∂–Ω–æ–µ</span></label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="fasteningPodderzh" name="fastening" value="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ">
                            <label class="radio-label" for="fasteningPodderzh"><span class="radio-dot"></span><span>–ü–æ–¥–¥–µ—Ä–∂.</span></label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="fasteningAnkernoe" name="fastening" value="–ê–Ω–∫–µ—Ä–Ω–æ–µ">
                            <label class="radio-label" for="fasteningAnkernoe"><span class="radio-dot"></span><span>–ê–Ω–∫–µ—Ä–Ω–æ–µ</span></label>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="toggle-section" id="toggleCrossing">
                    <div class="toggle-switch">
                        <input type="checkbox" class="toggle-input" id="crossingToggle" checked>
                        <span class="toggle-slider"></span>
                    </div>
                    <div class="toggle-label">
                        <span>üîÄ</span><span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π</span>
                        <span class="toggle-status active" id="toggleStatus">–í–ö–õ</span>
                    </div>
                </div>

                <div class="crossing-fields" id="crossingFields">
                    <div class="field-group">
                        <label class="field-label">
                            <span class="field-label-icon">üå≥</span>
                            –û–±—ä–µ–∫—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Äî –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö
                        </label>
                        <div class="crossing-objects">
                            <div class="crossing-obj-option">
                                <input type="radio" class="crossing-obj-input" id="crossTree"     name="crossingObject" value="–î–µ—Ä–µ–≤–æ"    checked>
                                <label class="crossing-obj-label" for="crossTree">üå≤ –î–µ—Ä–µ–≤–æ</label>
                            </div>
                            <div class="crossing-obj-option">
                                <input type="radio" class="crossing-obj-input" id="crossFence"    name="crossingObject" value="–ó–∞–±–æ—Ä">
                                <label class="crossing-obj-label" for="crossFence">üöß –ó–∞–±–æ—Ä</label>
                            </div>
                            <div class="crossing-obj-option">
                                <input type="radio" class="crossing-obj-input" id="crossRoad"     name="crossingObject" value="–î–æ—Ä–æ–≥–∞">
                                <label class="crossing-obj-label" for="crossRoad">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</label>
                            </div>
                            <div class="crossing-obj-option">
                                <input type="radio" class="crossing-obj-input" id="crossBuilding" name="crossingObject" value="–°—Ç—Ä–æ–µ–Ω–∏–µ">
                                <label class="crossing-obj-label" for="crossBuilding">üè† –°—Ç—Ä–æ–µ–Ω–∏–µ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üèóÔ∏è</span>
                        –¢–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="constructionVL" name="construction" value="–í–õ" checked>
                            <label class="radio-label" for="constructionVL"><span class="radio-dot"></span><span>–í–õ</span></label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="constructionKL" name="construction" value="–ö–õ">
                            <label class="radio-label" for="constructionKL"><span class="radio-dot"></span><span>–ö–õ</span></label>
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üõ£Ô∏è</span>
                        –¢–∏–ø –¥–æ—Ä–æ–≥–∏
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="roadAsphalt" name="roadType" value="–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è" checked>
                            <label class="radio-label" for="roadAsphalt"><span class="radio-dot"></span><span>–ê—Å—Ñ–∞–ª—å—Ç</span></label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="roadGround" name="roadType" value="–ì—Ä—É–Ω—Ç–æ–≤–∞—è">
                            <label class="radio-label" for="roadGround"><span class="radio-dot"></span><span>–ì—Ä—É–Ω—Ç</span></label>
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label">
                        <span class="field-label-icon">üåç</span>
                        –¢–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
                    </label>
                    <input type="text" class="field-input" id="inputTerrain" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏...">
                </div>

                <a href="#" class="discord-link" id="discordLink">
                    <span>üí¨</span>
                    <span>Discord: KAST Team</span>
                </a>
            </div>

            <div class="footer">
                <button class="btn btn-scan" id="btnScan">
                    <span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
                </button>
                <button class="btn btn-fill" id="btnFill">
                    <span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>
                </button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∏ -->
        <div class="modal-overlay" id="modalAddPreset">
            <div class="modal">
                <div class="modal-title">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–µ—Å–µ—Ç</div>
                <div class="modal-content">
                    <input type="text" class="field-input" id="inputNewPresetName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞...">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" id="btnCancelAdd">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary"   id="btnConfirmAdd">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="modalEditPreset">
            <div class="modal">
                <div class="modal-title">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø—Ä–µ—Å–µ—Ç</div>
                <div class="modal-content">
                    <input type="text" class="field-input" id="inputEditPresetName" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" id="btnCancelEdit">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary"   id="btnConfirmEdit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="modalDeletePreset">
            <div class="modal">
                <div class="modal-title">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Å–µ—Ç?</div>
                <div class="modal-content">
                    <p class="modal-text">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Å–µ—Ç <span class="modal-highlight" id="deletePresetName"></span>?</p>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" id="btnCancelDelete">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary"   id="btnConfirmDelete">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="modalWireBinding">
            <div class="modal">
                <div class="modal-title">üîó –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—è–∑–∫–∏</div>
                <div class="modal-content">
                    <p class="modal-text">
                        –ú–∞—Ä–∫–∞: <span class="modal-highlight" id="wireTypeDisplay"></span><br>
                        –ö—Ä–µ–ø–ª–µ–Ω–∏–µ: <span class="modal-highlight" id="fasteningTypeDisplay"></span>
                    </p>
                    <div class="radio-group" style="flex-direction:column;">
                        <div class="radio-option" style="min-width:100%;">
                            <input type="radio" class="radio-input" id="bindingEnd" name="bindingType" value="end" checked>
                            <label class="radio-label" for="bindingEnd" style="font-size:12px;"><span class="radio-dot"></span><span>–í—è–∑–∫–∞ –∫–æ–Ω—Ü–µ–≤–∞—è</span></label>
                        </div>
                        <div class="radio-option" style="min-width:100%;">
                            <input type="radio" class="radio-input" id="bindingThrough" name="bindingType" value="through">
                            <label class="radio-label" for="bindingThrough" style="font-size:12px;"><span class="radio-dot"></span><span>–í—è–∑–∫–∞ –ø—Ä–æ—Ö–æ–¥–Ω–∞—è</span></label>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" id="btnCancelBinding">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary"   id="btnConfirmBinding">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="modalAnchorType">
            <div class="modal">
                <div class="modal-title">‚öì –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–Ω–∫–µ—Ä–Ω–æ–≥–æ –∫—Ä–µ–ø–ª–µ–Ω–∏—è</div>
                <div class="modal-content" id="anchorOptions">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" id="btnCancelAnchor">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary"   id="btnConfirmAnchor">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                </div>
            </div>
        </div>
        `;

        shadow.innerHTML = `<style>${css}</style>${html}`;

        const ui = {
            main: shadow.querySelector('#mainPanel'),
            body: shadow.querySelector('#bodyContent'),
            btnMinimize: shadow.querySelector('#btnMinimize'),
            btnFill: shadow.querySelector('#btnFill'),
            btnScan: shadow.querySelector('#btnScan'),
            inputWireLength: shadow.querySelector('#inputWireLength'),
            inputWireBrand: shadow.querySelector('#inputWireBrand'),
            inputTerrain: shadow.querySelector('#inputTerrain'),
            wireSuggestions: shadow.querySelector('#wireSuggestions'),
            wireSuggestionsList: shadow.querySelector('#wireSuggestionsList'),
            fasteningNatyazhnoe: shadow.querySelector('#fasteningNatyazhnoe'),
            fasteningPodderzh: shadow.querySelector('#fasteningPodderzh'),
            fasteningAnkernoe: shadow.querySelector('#fasteningAnkernoe'),
            crossingToggle: shadow.querySelector('#crossingToggle'),
            toggleStatus: shadow.querySelector('#toggleStatus'),
            crossingFields: shadow.querySelector('#crossingFields'),
            constructionKL: shadow.querySelector('#constructionKL'),
            constructionVL: shadow.querySelector('#constructionVL'),
            roadGround: shadow.querySelector('#roadGround'),
            roadAsphalt: shadow.querySelector('#roadAsphalt'),
            crossTree: shadow.querySelector('#crossTree'),
            crossFence: shadow.querySelector('#crossFence'),
            crossRoad: shadow.querySelector('#crossRoad'),
            crossBuilding: shadow.querySelector('#crossBuilding'),
            statusWire: shadow.querySelector('#statusWire'),
            statusPreset: shadow.querySelector('#statusPreset'),
            collapsedWire: shadow.querySelector('#collapsedWire'),
            collapsedPreset: shadow.querySelector('#collapsedPreset'),
            collapsedInfo: shadow.querySelector('#collapsedInfo'),
            presetSelect: shadow.querySelector('#presetSelect'),
            btnAddPreset: shadow.querySelector('#btnAddPreset'),
            btnEditPreset: shadow.querySelector('#btnEditPreset'),
            btnDeletePreset: shadow.querySelector('#btnDeletePreset'),
            modalAddPreset: shadow.querySelector('#modalAddPreset'),
            modalEditPreset: shadow.querySelector('#modalEditPreset'),
            modalDeletePreset: shadow.querySelector('#modalDeletePreset'),
            inputNewPresetName: shadow.querySelector('#inputNewPresetName'),
            inputEditPresetName: shadow.querySelector('#inputEditPresetName'),
            deletePresetName: shadow.querySelector('#deletePresetName'),
            btnCancelAdd: shadow.querySelector('#btnCancelAdd'),
            btnConfirmAdd: shadow.querySelector('#btnConfirmAdd'),
            btnCancelEdit: shadow.querySelector('#btnCancelEdit'),
            btnConfirmEdit: shadow.querySelector('#btnConfirmEdit'),
            btnCancelDelete: shadow.querySelector('#btnCancelDelete'),
            btnConfirmDelete: shadow.querySelector('#btnConfirmDelete'),
            discordLink: shadow.querySelector('#discordLink'),
            modalWireBinding: shadow.querySelector('#modalWireBinding'),
            btnCancelBinding: shadow.querySelector('#btnCancelBinding'),
            btnConfirmBinding: shadow.querySelector('#btnConfirmBinding'),
            wireTypeDisplay: shadow.querySelector('#wireTypeDisplay'),
            fasteningTypeDisplay: shadow.querySelector('#fasteningTypeDisplay'),
            bindingEnd: shadow.querySelector('#bindingEnd'),
            bindingThrough: shadow.querySelector('#bindingThrough'),
            modalAnchorType: shadow.querySelector('#modalAnchorType'),
            anchorOptions: shadow.querySelector('#anchorOptions'),
            btnCancelAnchor: shadow.querySelector('#btnCancelAnchor'),
            btnConfirmAnchor: shadow.querySelector('#btnConfirmAnchor'),
            inputClearance: shadow.querySelector('#inputClearance'),
            btnClearanceMinus: shadow.querySelector('#btnClearanceMinus'),
            btnClearancePlus: shadow.querySelector('#btnClearancePlus'),
            btnScaleUp: shadow.querySelector('#btnScaleUp'),
            btnScaleDown: shadow.querySelector('#btnScaleDown'),
            scaleValue: shadow.querySelector('#scaleValue'),
            btnSettings: shadow.querySelector('#btnSettings'),
            settingsPanel: shadow.querySelector('#settingsPanel'),
            toggleCompact: shadow.querySelector('#toggleCompact'),
            // –ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ñ—Ç
            inputCouplingCount: shadow.querySelector('#inputCouplingCount'),
            btnCouplingMinus: shadow.querySelector('#btnCouplingMinus'),
            btnCouplingPlus: shadow.querySelector('#btnCouplingPlus')
        };

        /******************************************************************
         * –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –ú–ê–†–ö–ò –ü–†–û–í–û–î–ê
         ******************************************************************/
        ui.inputWireBrand.addEventListener('input', (e) => {
            const v = e.target.value.trim();
            if (v.length >= 1) {
                const similar = findSimilarWires(v);
                if (similar.length > 0) {
                    ui.wireSuggestionsList.innerHTML = similar.map(w =>
                        `<div class="suggestion-item" data-wire="${w}">${w}</div>`
                    ).join('');
                    ui.wireSuggestions.style.display = 'block';
                } else {
                    ui.wireSuggestions.style.display = 'none';
                }
            } else {
                ui.wireSuggestions.style.display = 'none';
            }
        });
        ui.wireSuggestionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                const wire = e.target.dataset.wire;
                ui.inputWireBrand.value = wire;
                getActive().wireBrand = wire;
                saveDb();
                ui.wireSuggestions.style.display = 'none';
            }
        });
        document.addEventListener('click', (e) => {
            if (!shadow.contains(e.target)) ui.wireSuggestions.style.display = 'none';
        });

        /******************************************************************
         * –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–û–õ–ï–ô
         ******************************************************************/
        ui.inputWireLength.addEventListener('input', (e) => { db.wireLength = e.target.value; saveDb(); });
        ui.inputWireBrand.addEventListener('input', (e) => { getActive().wireBrand = e.target.value; saveDb(); });
        ui.inputTerrain.addEventListener('input',    (e) => { getActive().terrain = e.target.value; saveDb(); });
        [ui.fasteningNatyazhnoe, ui.fasteningPodderzh, ui.fasteningAnkernoe].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { db.fastening = e.target.value; saveDb(); } })
        );
        [ui.constructionKL, ui.constructionVL].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { getActive().construction = e.target.value; saveDb(); updateCrossingFieldsState(); } })
        );
        [ui.roadGround, ui.roadAsphalt].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { getActive().roadType = e.target.value; saveDb(); } })
        );
        [ui.crossTree, ui.crossFence, ui.crossRoad, ui.crossBuilding].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { db.crossingObject = e.target.value; saveDb(); } })
        );

        /******************************************************************
         * –ì–ê–ë–ê–†–ò–¢
         ******************************************************************/
        function clampClearance(val) { return Math.max(1.0, Math.min(15.0, val)); }
        function updateClearanceDisplay() { ui.inputClearance.value = db.clearance; }
        ui.btnClearanceMinus.addEventListener('click', () => {
            db.clearance = clampClearance(parseFloat(db.clearance) - 0.5).toFixed(1);
            updateClearanceDisplay(); saveDb();
        });
        ui.btnClearancePlus.addEventListener('click', () => {
            db.clearance = clampClearance(parseFloat(db.clearance) + 0.5).toFixed(1);
            updateClearanceDisplay(); saveDb();
        });
        ui.inputClearance.addEventListener('change', () => {
            const v = parseFloat(ui.inputClearance.value);
            if (!isNaN(v)) db.clearance = clampClearance(v).toFixed(1);
            updateClearanceDisplay(); saveDb();
        });

        /******************************************************************
         * –ö–û–õ–ò–ß–ï–°–¢–í–û –ú–£–§–¢ (–ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ)
         ******************************************************************/
        function clampCouplingCount(val) { return Math.max(0, Math.min(50, val)); }
        function updateCouplingDisplay() { ui.inputCouplingCount.value = db.couplingCount; }

        ui.btnCouplingMinus.addEventListener('click', () => {
            db.couplingCount = clampCouplingCount(parseInt(db.couplingCount) - 1).toString();
            updateCouplingDisplay(); saveDb();
        });
        ui.btnCouplingPlus.addEventListener('click', () => {
            db.couplingCount = clampCouplingCount(parseInt(db.couplingCount) + 1).toString();
            updateCouplingDisplay(); saveDb();
        });
        ui.inputCouplingCount.addEventListener('change', () => {
            const v = parseInt(ui.inputCouplingCount.value);
            if (!isNaN(v)) db.couplingCount = clampCouplingCount(v).toString();
            updateCouplingDisplay(); saveDb();
        });

        /******************************************************************
         * –í–ê–õ–ò–î–ê–¶–ò–Ø –ß–ò–°–õ–û–í–´–• –ü–û–õ–ï–ô
         ******************************************************************/
        function validateNumberInput(input) {
            const value = parseFloat(input.value);
            if (value < 0 || input.value === '' || isNaN(value)) {
                input.value = '';
                showNotification('‚ö†Ô∏è –ë—É–∫—Å–∏–Ω –Ω–µ —à–∞–ª–∏!', 'warning');
                return false;
            }
            return true;
        }
        ui.inputWireLength.addEventListener('blur', function() {
            if (this.value && !validateNumberInput(this)) { db.wireLength = ''; saveDb(); }
        });

        /******************************************************************
         * –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï
         ******************************************************************/
        function updateScale() {
            ui.main.style.transform = `scale(${db.scale / 100})`;
            ui.scaleValue.textContent = `${db.scale}%`;
        }
        ui.btnScaleUp.addEventListener('click',   () => { if (db.scale < 150) { db.scale += 5; updateScale(); saveDb(); } });
        ui.btnScaleDown.addEventListener('click', () => { if (db.scale > 60)  { db.scale -= 5; updateScale(); saveDb(); } });

        /******************************************************************
         * –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî –ü–ê–ù–ï–õ–¨ –ò –ö–û–ú–ü–ê–ö–¢–ù–´–ô –†–ï–ñ–ò–ú
         ******************************************************************/
        let settingsPanelOpen = false;
        function updateCompactMode() {
            ui.main.classList.toggle('compact', db.compactMode);
            ui.toggleCompact.checked = db.compactMode;
        }
        ui.btnSettings.addEventListener('click', () => {
            settingsPanelOpen = !settingsPanelOpen;
            ui.settingsPanel.style.display = settingsPanelOpen ? 'flex' : 'none';
            ui.btnSettings.style.background = settingsPanelOpen ? 'rgba(139,92,246,0.4)' : 'rgba(255,255,255,0.1)';
        });
        ui.toggleCompact.addEventListener('change', (e) => {
            db.compactMode = e.target.checked;
            updateCompactMode();
            saveDb();
            showNotification(db.compactMode ? 'üìê –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω' : 'üìê –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'success');
        });

        /******************************************************************
         * –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
         ******************************************************************/
        function showNotification(message, type = 'success') {
            const n = document.createElement('div');
            n.className = `notification notification-${type}`;
            n.textContent = message;
            shadow.appendChild(n);
            setTimeout(() => { n.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => n.remove(), 300); }, 3000);
        }

        /******************************************************************
         * –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ï–°–ï–¢–ê–ú–ò
         ******************************************************************/
        function generatePresetId() { return 'p' + Date.now() + Math.random().toString(36).substr(2, 5); }

        function createPreset(name) {
            const cur = getActive();
            const np = { id: generatePresetId(), name, wireBrand: cur.wireBrand || '', roadType: cur.roadType || '–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è', construction: cur.construction || '–í–õ', terrain: cur.terrain || '', designation: cur.designation || '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å' };
            db.presets.push(np); db.activeId = np.id; saveDb(); updateUI();
            showNotification(`‚úÖ –ü—Ä–µ—Å–µ—Ç "${name}" —Å–æ–∑–¥–∞–Ω!`, 'success');
        }
        function renamePreset(newName) {
            const p = getActive();
            if (p) { p.name = newName; saveDb(); updateUI(); showNotification(`‚úÖ –ü—Ä–µ—Å–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ "${newName}"`, 'success'); }
        }
        function deletePreset() {
            if (db.presets.length <= 1) { showNotification('‚ö†Ô∏è –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–µ—Å–µ—Ç!', 'warning'); return; }
            const idx = db.presets.findIndex(p => p.id === db.activeId);
            db.presets = db.presets.filter(p => p.id !== db.activeId);
            db.activeId = db.presets[Math.min(idx, db.presets.length - 1)].id;
            saveDb(); updateUI(); showNotification('‚úÖ –ü—Ä–µ—Å–µ—Ç —É–¥–∞–ª—ë–Ω', 'success');
        }
        function showModal(m) { m.style.display = 'flex'; }
        function hideModal(m) { m.style.display = 'none'; }

        /******************************************************************
         * –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
         ******************************************************************/
        function updateToggleStatus() {
            const on = ui.crossingToggle.checked;
            ui.toggleStatus.textContent = on ? '–í–ö–õ' : '–í–´–ö–õ';
            ui.toggleStatus.className = on ? 'toggle-status active' : 'toggle-status inactive';
            ui.crossingFields.classList.toggle('hidden', !on);
        }
        function updateCrossingFieldsState() {
            const kl = ui.constructionKL.checked, on = ui.crossingToggle.checked;
            [ui.crossTree, ui.crossFence, ui.crossRoad, ui.crossBuilding].forEach(r => r.disabled = kl);
            ui.crossingFields.classList.toggle('hidden', !on);
        }
        function updateUI() {
            const preset = getActive();
            ui.inputWireLength.value = db.wireLength || '';
            ui.inputWireBrand.value  = preset.wireBrand || '';
            ui.inputTerrain.value    = preset.terrain || '';
            updateClearanceDisplay();
            updateCouplingDisplay();  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –º—É—Ñ—Ç

            const f = db.fastening || '–ù–∞—Ç—è–∂–Ω–æ–µ';
            ui.fasteningNatyazhnoe.checked = f === '–ù–∞—Ç—è–∂–Ω–æ–µ';
            ui.fasteningPodderzh.checked   = f === '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ';
            ui.fasteningAnkernoe.checked   = f === '–ê–Ω–∫–µ—Ä–Ω–æ–µ';

            (preset.construction === '–ö–õ' ? ui.constructionKL : ui.constructionVL).checked = true;
            (preset.roadType === '–ì—Ä—É–Ω—Ç–æ–≤–∞—è' ? ui.roadGround : ui.roadAsphalt).checked = true;

            const co = db.crossingObject || '–î–µ—Ä–µ–≤–æ';
            if (co === '–î–µ—Ä–µ–≤–æ')    ui.crossTree.checked     = true;
            if (co === '–ó–∞–±–æ—Ä')     ui.crossFence.checked    = true;
            if (co === '–î–æ—Ä–æ–≥–∞')    ui.crossRoad.checked     = true;
            if (co === '–°—Ç—Ä–æ–µ–Ω–∏–µ')  ui.crossBuilding.checked = true;

            ui.presetSelect.innerHTML = db.presets.map(p =>
                `<option value="${p.id}" ${p.id === db.activeId ? 'selected' : ''}>${p.name}</option>`
            ).join('');

            ui.statusPreset.textContent = preset.name;
            ui.collapsedPreset.textContent = preset.name;
            ui.crossingToggle.checked = db.isCrossingEnabled;
            updateToggleStatus();
            updateCrossingFieldsState();
            updateScale();
            updateCompactMode();
        }

        /******************************************************************
         * –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö –ö–û–ù–°–¢–†–£–ö–¶–ò–ò –ò –î–û–†–û–ì–ò
         ******************************************************************/
        [ui.constructionKL, ui.constructionVL].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { getActive().construction = e.target.value; saveDb(); updateCrossingFieldsState(); } })
        );
        [ui.roadGround, ui.roadAsphalt].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { getActive().roadType = e.target.value; saveDb(); } })
        );
        [ui.crossTree, ui.crossFence, ui.crossRoad, ui.crossBuilding].forEach(r =>
            r.addEventListener('change', (e) => { if (e.target.checked) { db.crossingObject = e.target.value; saveDb(); } })
        );

        /******************************************************************
         * –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –ü–ï–†–ï–°–ï–ß–ï–ù–ò–ô
         ******************************************************************/
        ui.crossingToggle.addEventListener('change', (e) => {
            db.isCrossingEnabled = e.target.checked; updateToggleStatus(); updateCrossingFieldsState(); saveDb();
            showNotification(e.target.checked ? '‚úÖ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : '‚ö†Ô∏è –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã', e.target.checked ? 'success' : 'warning');
        });
        shadow.querySelector('#toggleCrossing').addEventListener('click', (e) => {
            if (e.target === ui.crossingToggle || e.target.classList.contains('toggle-slider')) return;
            ui.crossingToggle.checked = !ui.crossingToggle.checked;
            db.isCrossingEnabled = ui.crossingToggle.checked; updateToggleStatus(); updateCrossingFieldsState(); saveDb();
            showNotification(ui.crossingToggle.checked ? '‚úÖ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : '‚ö†Ô∏è –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã', ui.crossingToggle.checked ? 'success' : 'warning');
        });

        /******************************************************************
         * –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–†–ï–°–ï–¢–û–í
         ******************************************************************/
        ui.presetSelect.addEventListener('change', (e) => { db.activeId = e.target.value; saveDb(); updateUI(); showNotification('–ü—Ä–µ—Å–µ—Ç –∏–∑–º–µ–Ω—ë–Ω', 'success'); });

        /******************************************************************
         * –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ï–°–ï–¢–ê–ú–ò
         ******************************************************************/
        ui.btnAddPreset.addEventListener('click', () => { ui.inputNewPresetName.value = ''; showModal(ui.modalAddPreset); setTimeout(() => ui.inputNewPresetName.focus(), 100); });
        ui.btnCancelAdd.addEventListener('click', () => hideModal(ui.modalAddPreset));
        ui.btnConfirmAdd.addEventListener('click', () => {
            const n = ui.inputNewPresetName.value.trim();
            if (!n) { showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞!', 'warning'); return; }
            createPreset(n); hideModal(ui.modalAddPreset);
        });
        ui.inputNewPresetName.addEventListener('keypress', (e) => { if (e.key === 'Enter') ui.btnConfirmAdd.click(); });

        ui.btnEditPreset.addEventListener('click', () => { ui.inputEditPresetName.value = getActive().name; showModal(ui.modalEditPreset); setTimeout(() => { ui.inputEditPresetName.focus(); ui.inputEditPresetName.select(); }, 100); });
        ui.btnCancelEdit.addEventListener('click', () => hideModal(ui.modalEditPreset));
        ui.btnConfirmEdit.addEventListener('click', () => {
            const n = ui.inputEditPresetName.value.trim();
            if (!n) { showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞!', 'warning'); return; }
            renamePreset(n); hideModal(ui.modalEditPreset);
        });
        ui.inputEditPresetName.addEventListener('keypress', (e) => { if (e.key === 'Enter') ui.btnConfirmEdit.click(); });

        ui.btnDeletePreset.addEventListener('click', () => { ui.deletePresetName.textContent = getActive().name; showModal(ui.modalDeletePreset); });
        ui.btnCancelDelete.addEventListener('click',  () => hideModal(ui.modalDeletePreset));
        ui.btnConfirmDelete.addEventListener('click', () => { deletePreset(); hideModal(ui.modalDeletePreset); });

        [ui.modalAddPreset, ui.modalEditPreset, ui.modalDeletePreset, ui.modalWireBinding, ui.modalAnchorType].forEach(m =>
            m.addEventListener('click', (e) => { if (e.target === m) hideModal(m); })
        );
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') [ui.modalAddPreset, ui.modalEditPreset, ui.modalDeletePreset, ui.modalWireBinding, ui.modalAnchorType].forEach(hideModal);
        });

        /******************************************************************
         * –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –°–ê–ô–¢–ê
         ******************************************************************/
        ui.btnScan.addEventListener('click', async () => {
            ui.btnScan.disabled = true;
            ui.btnScan.innerHTML = '<span>‚è≥</span><span>–°–∫–∞–Ω–∏—Ä—É—é...</span>';
            try {
                const data = scanSiteData();
                const preset = getActive();
                let updated = false;
                if (data.wireBrand && data.wireBrand !== '...')    { preset.wireBrand    = data.wireBrand;    updated = true; }
                if (data.fastening)                                 { db.fastening        = data.fastening;    updated = true; }
                if (data.terrain)                                   { preset.terrain      = data.terrain;      updated = true; }
                if (data.roadType)                                  { preset.roadType     = data.roadType;     updated = true; }
                if (data.construction)                              { preset.construction = data.construction; updated = true; }
                if (data.crossingObject)                            { db.crossingObject   = data.crossingObject; updated = true; }
                if (data.wireLength)                                { db.wireLength       = data.wireLength;   updated = true; }
                if (updated) { saveDb(); updateUI(); showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å—á–∏—Ç–∞–Ω—ã —Å —Ñ–æ—Ä–º—ã!', 'success'); }
                else showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ', 'warning');
            } catch (err) {
                console.error(err);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏', 'error');
                alert(`[KOLUS] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–æ—Ä–º—ã:\n\n${err.message}\n\n–°–º. –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.`);
            } finally {
                ui.btnScan.disabled = false;
                ui.btnScan.innerHTML = '<span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>';
            }
        });

        /******************************************************************
         * –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –§–û–†–ú–´
         ******************************************************************/
        ui.btnFill.addEventListener('click', async () => {
            const preset = getActive();
            if (db.wireLength && parseFloat(db.wireLength) < 0) { showNotification('‚ö†Ô∏è –ë—É–∫—Å–∏–Ω –Ω–µ —à–∞–ª–∏!', 'warning'); return; }
            if (!preset.wireBrand) { showNotification('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –º–∞—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∞!', 'warning'); return; }
            if (!db.fastening)     { showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∫—Ä–µ–ø–ª–µ–Ω–∏—è!', 'warning'); return; }

            if (db.fastening === '–ê–Ω–∫–µ—Ä–Ω–æ–µ') {
                if (isWireTypeAorAC(preset.wireBrand)) {
                    ui.anchorOptions.innerHTML = `
                        <div class="radio-group" style="flex-direction:column;">
                            <div class="radio-option" style="min-width:100%;"><input type="radio" class="radio-input" id="anchorBindingEnd"     name="anchorType" value="–í—è–∑–∫–∞ –∫–æ–Ω—Ü–µ–≤–∞—è"  checked><label class="radio-label" for="anchorBindingEnd"    style="font-size:11px;"><span class="radio-dot"></span><span>–í—è–∑–∫–∞ –∫–æ–Ω—Ü–µ–≤–∞—è</span></label></div>
                            <div class="radio-option" style="min-width:100%;"><input type="radio" class="radio-input" id="anchorBindingThrough" name="anchorType" value="–í—è–∑–∫–∞ –ø—Ä–æ—Ö–æ–¥–Ω–∞—è">       <label class="radio-label" for="anchorBindingThrough" style="font-size:11px;"><span class="radio-dot"></span><span>–í—è–∑–∫–∞ –ø—Ä–æ—Ö–æ–¥–Ω–∞—è</span></label></div>
                        </div>`;
                } else {
                    ui.anchorOptions.innerHTML = `
                        <div class="radio-group" style="flex-direction:column;">
                            <div class="radio-option" style="min-width:100%;"><input type="radio" class="radio-input" id="anchorClamp" name="anchorType" value="–ó–∞–∂–∏–º –∞–Ω–∫–µ—Ä–Ω—ã–π –∫–ª–∏–Ω–æ–≤–æ–π" checked><label class="radio-label" for="anchorClamp" style="font-size:11px;"><span class="radio-dot"></span><span>–ó–∞–∂–∏–º –∞–Ω–∫–µ—Ä–Ω—ã–π –∫–ª–∏–Ω–æ–≤–æ–π</span></label></div>
                            <div class="radio-option" style="min-width:100%;"><input type="radio" class="radio-input" id="anchorBolt"  name="anchorType" value="–ë–æ–ª—Ç–æ–≤–æ–π –∑–∞–∂–∏–º">                  <label class="radio-label" for="anchorBolt"  style="font-size:11px;"><span class="radio-dot"></span><span>–ë–æ–ª—Ç–æ–≤–æ–π –∑–∞–∂–∏–º</span></label></div>
                        </div>`;
                }
                ui.btnConfirmAnchor.disabled = false;
                showModal(ui.modalAnchorType);
                return;
            }

            if (isWireTypeAorAC(preset.wireBrand)) {
                ui.wireTypeDisplay.textContent    = preset.wireBrand;
                ui.fasteningTypeDisplay.textContent = db.fastening || '‚Äî';
                (db.fastening === '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ' ? ui.bindingThrough : ui.bindingEnd).checked = true;
                showModal(ui.modalWireBinding);
                return;
            }

            await performFill();
        });

        ui.btnCancelBinding.addEventListener('click',  () => hideModal(ui.modalWireBinding));
        ui.btnConfirmBinding.addEventListener('click', async () => {
            const sel = ui.bindingEnd.checked ? '–í—è–∑–∫–∞ –∫–æ–Ω—Ü–µ–≤–∞—è' : '–í—è–∑–∫–∞ –ø—Ä–æ—Ö–æ–¥–Ω–∞—è';
            hideModal(ui.modalWireBinding);
            await performFill(sel);
        });

        ui.btnCancelAnchor.addEventListener('click', () => { hideModal(ui.modalAnchorType); ui.btnConfirmAnchor.disabled = false; });
        ui.btnConfirmAnchor.addEventListener('click', async () => {
            const r = shadow.querySelector('input[name="anchorType"]:checked');
            if (!r) { showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—Ä–µ–ø–ª–µ–Ω–∏—è!', 'warning'); return; }
            hideModal(ui.modalAnchorType); ui.btnConfirmAnchor.disabled = false;
            await performFill(null, r.value);
        });

        async function performFill(wireTension = null, anchorType = null) {
            ui.btnFill.disabled = true;
            ui.btnFill.innerHTML = '<span>‚è≥</span><span>–ó–∞–ø–æ–ª–Ω—è—é...</span>';
            try {
                const preset      = getActive();
                const construction = ui.constructionKL.checked ? '–ö–õ' : '–í–õ';
                const roadType     = ui.roadGround.checked ? '–ì—Ä—É–Ω—Ç–æ–≤–∞—è' : '–ê—Å—Ñ–∞–ª—å—Ç–æ–≤–∞—è';
                const fastening    = db.fastening || '–ù–∞—Ç—è–∂–Ω–æ–µ';

                console.log('[KOLUS DEBUG 1] performFill start');

                // ‚îÄ‚îÄ –ü–æ–ª–µ designation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const designationInput = await waitForInput('input[name="designation"]');
                if (!designationInput) {
                    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ "designation" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–æ—Ä–º–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å.');
                }
                setReactInputValue(designationInput, preset.designation || '–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å');
                console.log('[KOLUS DEBUG 2] designation done');

                // ‚îÄ‚îÄ –õ–æ–≥–∏–∫–∞ –º–∞—Ä–∫–∏ –ø—Ä–æ–≤–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const wireEl = document.querySelector('fieldset[name="cableType"] .smwb-select-field span') ||
                               document.querySelector('input[name="cableType"]');
                const siteWireRaw = wireEl ? (wireEl.textContent || wireEl.value || '') : '';
                const siteWire = siteWireRaw.trim().replace(/\u00a0/g, '').replace(/\s+/g, ' ');
                const hasPlaceholderClass = wireEl && (
                    wireEl.closest('.smwb-select-field')?.classList.contains('smwb-select-field--placeholder') ||
                    wireEl.classList.contains('smwb-select-field__placeholder')
                );
                const siteWireIsEmpty = !siteWire || siteWire === '...' || siteWire.length <= 2 || hasPlaceholderClass;

                if (siteWireIsEmpty) {
                    console.log('üîå KOLUS: –ú–∞—Ä–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –≤—Å—Ç–∞–≤–ª—è–µ–º –∏–∑ –ø—Ä–µ—Å–µ—Ç–∞:', preset.wireBrand);
                    try {
                        const ok = await selectWireBrandReact(preset.wireBrand);
                        if (!ok) {
                            showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –º–∞—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∞', 'warning');
                            alert(`[KOLUS] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –º–∞—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∞ "${preset.wireBrand}" –∏–∑ —Å–ø–∏—Å–∫–∞.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–∫–∞—è –º–∞—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ –Ω–∞ —Å–∞–π—Ç–µ.`);
                        }
                    } catch (wireErr) {
                        console.error('‚ö†Ô∏è KOLUS: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–∞—Ä–∫–∏:', wireErr);
                        showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –º–∞—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∞', 'warning');
                        alert(`[KOLUS] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–∞—Ä–∫–∏ –ø—Ä–æ–≤–æ–¥–∞:\n\n${wireErr.message}`);
                    }
                } else if (wireMatches(siteWire, preset.wireBrand)) {
                    console.log('‚è≠Ô∏è KOLUS: –ú–∞—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (' + siteWire + ') ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                } else {
                    const msg = `–ú–∞—Ä–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ (${siteWire}) –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–µ—Å–µ—Ç–∞ (${preset.wireBrand})!\n\n–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ.`;
                    showNotification('‚ö†Ô∏è ' + msg.split('\n')[0], 'warning');
                    alert('[KOLUS] ‚ö†Ô∏è ' + msg);
                    return;
                }

                console.log('[KOLUS DEBUG 3] wire done, continuing...');
                await sleep(200);

                // ‚îÄ‚îÄ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –î–ª—è –°–ò–ü 2—Ö16 —Ñ–∞–∑—ã=1, –ø—Ä–æ–≤–æ–¥–∞ –≤ —Ñ–∞–∑–µ=1 ‚îÄ‚îÄ
                console.log('[KOLUS DEBUG 4] phaseCount...');
                const phaseInput = await waitForInput('input[name="phaseCount"]');
                if (!phaseInput) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ "phaseCount". –§–æ—Ä–º–∞ –º–æ–≥–ª–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.');

                const isSIP2 = isSIP2x16(preset.wireBrand);
                if (isSIP2) {
                    console.log('üîå KOLUS: –û–±–Ω–∞—Ä—É–∂–µ–Ω –°–ò–ü 2—Ö16 ‚Üí —Ñ–∞–∑—ã=1, –ø—Ä–æ–≤–æ–¥–∞ –≤ —Ñ–∞–∑–µ=1');
                    setReactInputValue(phaseInput, '1');
                } else {
                    setReactInputValue(phaseInput, '3');
                }

                console.log('[KOLUS DEBUG 5] wireCountInPhase...');
                const wireCountInput = await waitForInput('input[name="wireCountInPhase"]');
                if (wireCountInput) {
                    setReactInputValue(wireCountInput, '1');
                }

                console.log('[KOLUS DEBUG 6] construction...');
                setReactInputValue(await waitForInput('input[name="construction"]'), construction);

                console.log('[KOLUS DEBUG 7] fastening...');
                setReactInputValue(await waitForInput('input[name="fastening.type"]'), fastening);

                console.log('[KOLUS DEBUG 8] areaType...');
                setReactInputValue(await waitForInput('input[name="areaType"]'), preset.terrain);
                console.log('[KOLUS DEBUG 9] areaType done');

                console.log('üìè KOLUS: –ì–∞–±–∞—Ä–∏—Ç:', db.clearance);
                setReactInputValue(await waitForInput('input[name="overallDimension.height"]'), db.clearance);

                const tension = anchorType || wireTension ||
                    (fastening === '–ù–∞—Ç—è–∂–Ω–æ–µ' ? '–ó–∞–∂–∏–º –Ω–∞—Ç—è–∂–Ω–æ–π –∫–ª–∏–Ω–æ–≤–æ–π' : '–ó–∞–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π');
                setReactInputValue(await waitForInput('input[name="wireTension"]'), tension);
                setReactInputValue(await waitForInput('input[name="roadType"]'), roadType);

                if (db.wireLength) {
                    const li = await waitForInput('input[name*="length"]') ||
                               await waitForInput('input[name*="wireLength"]') ||
                               await waitForInput('input[name*="cableLength"]');
                    if (li) setReactInputValue(li, db.wireLength);
                }

                // ‚îÄ‚îÄ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º—É—Ñ—Ç ‚îÄ‚îÄ
                if (db.couplingCount && parseInt(db.couplingCount) > 0) {
                    console.log('üîå KOLUS: –ó–∞–ø–æ–ª–Ω—è—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º—É—Ñ—Ç:', db.couplingCount);
                    const couplingInput = await waitForInput('input[name*="coupling"]') ||
                                         await waitForInput('input[name*="–º—É—Ñ—Ç"]') ||
                                         await waitForInput('input[name*="muff"]');
                    if (couplingInput) {
                        setReactInputValue(couplingInput, db.couplingCount);
                    } else {
                        console.warn('‚ö†Ô∏è KOLUS: –ü–æ–ª–µ –¥–ª—è –º—É—Ñ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                    }
                }

                if (construction === '–í–õ' && db.isCrossingEnabled) {
                    const cb = document.querySelector('input[name="crossing.exists"]');
                    if (cb && !cb.checked) cb.click();
                    await sleep(200);
                    setReactInputValue(await waitForInput('input[name="crossing.type"]'),   '–≤–æ–∑–¥—É—à–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥');
                    setReactInputValue(await waitForInput('input[name="crossing.object"]'), db.crossingObject);
                } else {
                    const cb = document.querySelector('input[name="crossing.exists"]');
                    if (cb && cb.checked) cb.click();
                }

                await sleep(300);
                const cards = [...document.querySelectorAll('.smwb-card')];
                for (const title of ['–ì–∞–±–∞—Ä–∏—Ç –Ω–∞–¥ –∑–µ–º–ª–µ–π', '–°–ø–æ—Å–æ–± –∫—Ä–µ–ø–ª–µ–Ω–∏—è –Ω–∞ –æ–ø–æ—Ä–µ']) {
                    const card = cards.find(c => c.querySelector('.smwb-card__title')?.textContent.includes(title));
                    if (!card) continue;
                    const photoGrid = card.querySelector('[name$="photoUrls"]');
                    if (photoGrid?.querySelectorAll('img,video').length > 0) continue;
                    const btn = card.querySelector('button.smwb-fab');
                    if (btn) ['mousedown', 'mouseup', 'click'].forEach(t =>
                        btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                    );
                }

                showNotification('‚úÖ –§–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!', 'success');

            } catch (err) {
                console.error('‚ùå KOLUS: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:', err);
                console.trace();
                showNotification('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏', 'error');
                alert(
                    `[KOLUS v1.6.0] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã!\n\n` +
                    `–û—à–∏–±–∫–∞: ${err.message}\n\n` +
                    `–°—Ç–µ–∫:\n${err.stack || '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}\n\n` +
                    `–ü—Ä–µ—Å–µ—Ç: ${getActive().name}\n` +
                    `–ú–∞—Ä–∫–∞: ${getActive().wireBrand}\n` +
                    `–ö—Ä–µ–ø–ª–µ–Ω–∏–µ: ${db.fastening}\n\n` +
                    `–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12 ‚Üí Console) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.`
                );
            } finally {
                ui.btnFill.disabled = false;
                ui.btnFill.innerHTML = '<span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>';
            }
        }

        /******************************************************************
         * –ú–ò–ù–ò–ú–ò–ó–ê–¶–ò–Ø –û–ö–ù–ê
         ******************************************************************/
        ui.btnMinimize.addEventListener('click', () => {
            db.isCollapsed = !db.isCollapsed;
            ui.body.style.display = db.isCollapsed ? 'none' : 'flex';
            ui.collapsedInfo.classList.toggle('visible', db.isCollapsed);
            ui.btnMinimize.textContent = db.isCollapsed ? '+' : '‚àí';
            saveDb();
        });

        /******************************************************************
         * –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï
         ******************************************************************/
        let isDragging = false, offsetX, offsetY;
        shadow.querySelector('#dragHandle').addEventListener('mousedown', (e) => {
            isDragging = true; offsetX = e.clientX - ui.main.offsetLeft; offsetY = e.clientY - ui.main.offsetTop; ui.main.style.cursor = 'grabbing';
        });
        document.addEventListener('mousemove', (e) => {
            if (isDragging) { ui.main.style.left = (e.clientX - offsetX) + 'px'; ui.main.style.top = (e.clientY - offsetY) + 'px'; }
        });
        document.addEventListener('mouseup', () => {
            if (isDragging) { isDragging = false; ui.main.style.cursor = ''; db.pos = { x: parseInt(ui.main.style.left), y: parseInt(ui.main.style.top) }; saveDb(); }
        });

        /******************************************************************
         * –ú–û–ù–ò–¢–û–†–ò–ù–ì –ú–ê–†–ö–ò –ü–†–û–í–û–î–ê
         ******************************************************************/
        function monitorWire() {
            try {
                const wireEl    = document.querySelector('fieldset[name="cableType"] .smwb-select-field span') || document.querySelector('input[name="cableType"]');
                const siteWire  = wireEl ? (wireEl.textContent || wireEl.value || '').trim() : '';
                const presetWire = ui.inputWireBrand.value.trim();

                function updateWireStatus(el, wire, preset) {
                    if (!wire || wire === '...') {
                        el.textContent = '–ü—É—Å—Ç–æ';
                        el.className = el.className.replace(/match-\w+/g, '') + ' match-yellow';
                        return false;
                    } else if (wireMatches(wire, preset)) {
                        el.textContent = wire;
                        el.className = el.className.replace(/match-\w+/g, '') + ' match-green';
                        return true;
                    } else {
                        el.textContent = wire;
                        el.className = el.className.replace(/match-\w+/g, '') + ' match-red';
                        return false;
                    }
                }

                updateWireStatus(ui.statusWire,    siteWire, presetWire);
                updateWireStatus(ui.collapsedWire, siteWire, presetWire);

                const siteWireIsEmpty = !siteWire || siteWire === '...' || siteWire.length <= 2;
                const brandMismatch = !siteWireIsEmpty && !wireMatches(siteWire, presetWire);
                ui.btnFill.disabled = !presetWire || brandMismatch;
                if (brandMismatch) {
                    ui.btnFill.style.opacity = '0.4';
                    ui.btnFill.title = `–ú–∞—Ä–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ (${siteWire}) ‚â† –ø—Ä–µ—Å–µ—Ç (${presetWire})`;
                } else {
                    ui.btnFill.style.opacity = '';
                    ui.btnFill.title = '';
                }
            } catch (e) { /* ignore */ }
            requestAnimationFrame(monitorWire);
        }

        /******************************************************************
         * DISCORD
         ******************************************************************/
        ui.discordLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.open('https://discord.gg/RC6HhTqCdR', '_blank');
        });

        /******************************************************************
         * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
         ******************************************************************/
        ui.main.style.left = db.pos.x + 'px';
        ui.main.style.top  = db.pos.y + 'px';
        if (db.isCollapsed) {
            ui.body.style.display = 'none';
            ui.collapsedInfo.classList.add('visible');
            ui.btnMinimize.textContent = '+';
        }

        updateUI();
        monitorWire();

        console.log('‚úÖ KOLUS v1.6.0 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! | Created by KAST Team');
        document.getElementById('kolus-ui-host').style.display = db.isVisible ? 'block' : 'none';
    }

    /******************************************************************
     * –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ò–î–ò–ú–û–°–¢–¨–Æ UI
     ******************************************************************/
    function showUI() {
        const h = document.getElementById('kolus-ui-host');
        if (h) { h.style.display = 'block'; console.log('‚úÖ KOLUS: UI –ø–æ–∫–∞–∑–∞–Ω'); }
    }
    function hideUI() {
        const h = document.getElementById('kolus-ui-host');
        if (h) { h.style.display = 'none'; console.log('üôà KOLUS: UI —Å–∫—Ä—ã—Ç'); }
    }
    function toggleUI() {
        window.kolusManuallyHidden = !window.kolusManuallyHidden;
        if (window.kolusManuallyHidden) {
            hideUI();
            showNotificationGlobal('üôà KOLUS —Å–∫—Ä—ã—Ç. ALT + –ó –¥–ª—è –ø–æ–∫–∞–∑–∞', 'warning');
        } else if (isWireForm()) {
            showUI();
            showNotificationGlobal('‚úÖ KOLUS –ø–æ–∫–∞–∑–∞–Ω. ALT + –ó –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è', 'success');
        }
    }
    function showNotificationGlobal(message, type = 'success') {
        const n = document.createElement('div');
        n.style.cssText = `position:fixed;top:20px;right:20px;background:${type==='success'?'linear-gradient(135deg,rgba(22,163,74,0.95),rgba(0,0,0,0.95))':'linear-gradient(135deg,rgba(234,179,8,0.95),rgba(0,0,0,0.95))'};border:1px solid ${type==='success'?'rgba(34,197,94,0.5)':'rgba(234,179,8,0.5)'};border-radius:12px;padding:16px 20px;color:#fff;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;z-index:1000001;box-shadow:0 10px 30px rgba(0,0,0,0.5);max-width:300px;`;
        n.textContent = message;
        document.body.appendChild(n);
        setTimeout(() => { setTimeout(() => n.remove(), 300); }, 3000);
    }

    document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key.toLowerCase() === '–∑') { e.preventDefault(); toggleUI(); }
    });

    console.log('üöÄ KOLUS v1.6.0 –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
    console.log('üí° –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: ALT + –ó - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å UI');

    window.kolusManuallyHidden = false;
    startFormObserver();
})();