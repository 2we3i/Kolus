// ==UserScript==
// @name         –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä - v1.8.4 (KOLUS Style)
// @namespace    pillar.autofill.advanced
// @version      1.8.4
// @description  üèóÔ∏è –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –æ–ø–æ—Ä –≤ —Å—Ç–∏–ª–µ KOLUS | Created by KAST Team
// @match        https://moe2.agentumit.ru/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    console.log('üöÄ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä v1.8.4 –∑–∞–≥—Ä—É–∂–µ–Ω | Created by KAST Team');

    const STORAGE_KEY = 'pillar_autofill_v1';

    /******************************************************************
     * –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
     ******************************************************************/
    const PILLAR_TYPE_TO_MATERIAL = {
        '–°–í 95': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è', '–°–í 110': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è', '–°–ö–¶': '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è',
        '–î–µ—Ä–µ–≤—è–Ω–∞—è –Ω/–≤': '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', '–û–°–¶-1.5-9.0': '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', '–¢—Ä—É–±–æ—Å—Ç–æ–π–∫–∞': '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è'
    };
    const PILLAR_TYPES       = ['–°–í 95', '–°–í 110', '–°–ö–¶', '–î–µ—Ä–µ–≤—è–Ω–∞—è –Ω/–≤', '–û–°–¶-1.5-9.0', '–¢—Ä—É–±–æ—Å—Ç–æ–π–∫–∞'];
    const CONSTRUCTION_TYPES = [
        { name: '–æ–¥–Ω–æ—Å—Ç–æ–µ—á–Ω–∞—è', stands: 1 }, { name: '–¥–≤—É—Ö—Å—Ç–æ–µ—á–Ω–∞—è', stands: 2 },
        { name: '—Ç—Ä–µ—Ö—Å—Ç–æ–µ—á–Ω–∞—è', stands: 3 }, { name: '–ê-–æ–±—Ä–∞–∑–Ω–∞—è', stands: 2 }, { name: '–ü-–æ–±—Ä–∞–∑–Ω–∞—è', stands: 2 }
    ];
    const PLACEMENT_TYPES = ['–û—Ç–≤–µ—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è', '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è', '–£–≥–ª–æ–≤–∞—è', '–ö–æ–Ω—Ü–µ–≤–∞—è'];
    const BRACING_MATS    = ['–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è'];
    const ATTACH_MATS     = ['–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è', '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è'];
    const LAMP_TYPES         = ['–î–ù–ê–¢', '–î–†–õ', '–°–≤–µ—Ç–æ–¥–∏–æ–¥', '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é'];
    const INSULATOR_TYPES    = ['–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π', '–Ω–∞—Ç—è–∂–Ω–æ–π', '—à—Ç—ã—Ä–µ–≤–æ–π', '—É–≥–ª–æ–≤–æ–π'];
    const INSULATOR_MATS     = ['—Ñ–∞—Ä—Ñ–æ—Ä–æ–≤—ã–π', '—Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π', '–ø–æ–ª–∏–º–µ—Ä–Ω—ã–π'];

    const defaultData = {
        pillar: { type: '–°–í 95', constructionType: '–æ–¥–Ω–æ—Å—Ç–æ–µ—á–Ω–∞—è', placement: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è', material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' },
        stands: { count: 1, material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' },
        bracing: { count: 0, material: '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è' },
        attachments: { count: 0, material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' },
        additionalLoad: { communicationCabinet: 0, communicationLine: 0, streetLamp: 0, volsMuffle: 0, streetLantern: 0, voltageLines: 0 },
        subscribers: { settlement: '', street: '' },
        lamps: [],
        insulators: { count: 1, type: '–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π', material: '—Ñ–∞—Ä—Ñ–æ—Ä–æ–≤—ã–π', qty: 6 },
        wireTypeA: false,
        ui: { pos: { x: 20, y: 20 }, isCollapsed: false, scale: 100 }
    };

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;
    db.additionalLoad = Object.assign({ communicationCabinet: 0, communicationLine: 0, streetLamp: 0, volsMuffle: 0, streetLantern: 0, voltageLines: 0 }, db.additionalLoad || {});
    db.ui = Object.assign({ pos: { x: 20, y: 20 }, isCollapsed: false, scale: 100 }, db.ui || {});
    if (!db.attachments) db.attachments = { count: 0, material: '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' };
    if (db.attachments.material !== '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è' && db.attachments.material !== '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è') {
        db.attachments.material = '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è';
    }
    if (!db.subscribers) db.subscribers = { settlement: '', street: '' };
    if (!db.insulators) db.insulators = { count: 1, type: '–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π', material: '—Ñ–∞—Ä—Ñ–æ—Ä–æ–≤—ã–π', qty: 6 };
    if (db.wireTypeA === undefined) db.wireTypeA = false;
    const saveDb = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(db));

    /******************************************************************
     * –£–¢–ò–õ–ò–¢–´
     ******************************************************************/
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function setReactInput(input, value) {
        if (!input) return false;
        try {
            Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set.call(input, value);
            input.dispatchEvent(new Event('input',  { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            return true;
        } catch (e) { return false; }
    }

    async function waitForField(selector, timeout = 6000) {
        const t0 = Date.now();
        let el = document.querySelector(selector);
        while (!el && Date.now() - t0 < timeout) { await sleep(150); el = document.querySelector(selector); }
        return el || null;
    }

    async function fillField(selector, value, label) {
        const el = await waitForField(selector, 5000);
        if (!el) { console.warn(`${label}: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`); return false; }
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await sleep(100);
        if ((el.value || '') === value) return true;
        for (let i = 0; i < 5; i++) {
            setReactInput(el, value);
            await sleep(200);
            if ((el.value || '') === value) return true;
            await sleep(150);
        }
        return false;
    }

    async function clickReactSelect(selector, value) {
        const sel = document.querySelector(selector);
        if (!sel) return false;
        ['mousedown', 'mouseup', 'click'].forEach(t =>
            sel.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(300);
        for (let i = 0; i < 40; i++) {
            const opt = [...document.querySelectorAll('.smwb-menu__item')].find(o => o.textContent.trim() === value);
            if (opt) {
                ['mousedown', 'mouseup', 'click'].forEach(t =>
                    opt.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    async function clickCamera(selector) {
        const btn = document.querySelector(selector);
        if (!btn) return false;
        const fs = btn.closest('fieldset');
        if (fs) {
            fs.scrollIntoView({ behavior: 'smooth', block: 'center' });
            await sleep(150);
            const hasPhoto = [...fs.querySelectorAll('img')].some(img => {
                const src = img.src || '';
                return (src.startsWith('https://') || src.startsWith('blob:') || src.startsWith('data:image'))
                    && !src.includes('iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB')
                    && img.width > 10;
            });
            if (hasPhoto) return true;
        }
        ['mousedown', 'mouseup', 'click'].forEach(t =>
            btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(100);
        return true;
    }

    async function clickCameraN(selector, needed) {
        const fs = document.querySelector(selector);
        if (!fs) return false;
        fs.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await sleep(150);
        const countRealPhotos = () => [...fs.querySelectorAll('img')].filter(img => {
            const src = img.src || '';
            return (src.startsWith('https://') || src.startsWith('blob:') || src.startsWith('data:image'))
                && !src.includes('iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB')
                && img.width > 10;
        }).length;
        const already = countRealPhotos();
        const toClick = Math.max(0, needed - already);
        for (let i = 0; i < toClick; i++) {
            const btn = fs.querySelector('button.smwb-fab');
            if (!btn) break;
            ['mousedown', 'mouseup', 'click'].forEach(t =>
                btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
            );
            await sleep(400);
        }
        return true;
    }

    async function setCounter(selector, target) {
        const inp = await waitForField(selector, 4000);
        if (!inp) return false;
        const cont  = inp.closest('.zC3boZPYpGZ1oTnRKpH9') || inp.closest('.MUUhtVW6OxD9dYFURbyO') || inp.parentElement;
        const plus  = cont.querySelector('button.tKCNx3Mjilgu1eJFpBSs');
        const minus = cont.querySelector('button.bfwPpp5XjJbr4xH4oW1r');
        if (!plus || !minus) return false;
        const get = () => parseInt(inp.value) || 0;
        let retries = 0;
        while (get() < target && retries < 15) {
            const b = get(); plus.click(); await sleep(300);
            if (get() === b) { retries++; await sleep(300); } else retries = 0;
        }
        while (get() > target) { minus.click(); await sleep(500); }
        return get() === target;
    }

    /******************************************************************
     * –ö–ê–†–£–°–ï–õ–¨ (–æ–±—â–∞—è ‚Äî –¥–ª—è —Å—Ç–æ–µ–∫, —É–∫–æ—Å–æ–≤, –Ω–∞–≥—Ä—É–∑–æ–∫)
     ******************************************************************/
    function getCarouselIndex() {
        const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
        for (let i = 0; i < dots.length; i++) if (dots[i].classList.contains('current')) return i;
        return 0;
    }

    async function goToSlide(target, maxTries = 5) {
        for (let t = 1; t <= maxTries; t++) {
            const cur = getCarouselIndex();
            if (cur === target) return true;
            const diff = target - cur;
            const next = document.querySelector('.smwb-carousel__navigation__button--next');
            const prev = document.querySelector('.smwb-carousel__navigation__button--prev');
            const btn  = diff > 0 ? next : prev;
            if (btn) { for (let c = 0; c < Math.abs(diff); c++) { btn.click(); await sleep(350); } }
            if (getCarouselIndex() === target) return true;
            const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
            if (target < dots.length) {
                const d = dots[target].querySelector('button') || dots[target];
                ['mousedown', 'mouseup', 'click'].forEach(e =>
                    d.dispatchEvent(new MouseEvent(e, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(500);
                if (getCarouselIndex() === target) return true;
            }
            await sleep(300);
        }
        return false;
    }

    /******************************************************************
     * –ö–ê–†–£–°–ï–õ–¨ –ê–ë–û–ù–ï–ù–¢–û–í (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è)
     ******************************************************************/
    function getSubscriberCarousel() {
        const countInp = document.querySelector('input[name="subscribers.count"]');
        if (!countInp) return null;
        // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë –∫–∞—Ä—É—Å–µ–ª—å
        const card = countInp.closest('.smwb-card');
        if (card) {
            const c = card.querySelector('.smwb-carousel');
            if (c) return c;
        }
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –∏–¥—ë–º –≤–≤–µ—Ä—Ö –ø–æ DOM
        let el = countInp.parentElement;
        for (let i = 0; i < 8; i++) {
            if (!el) break;
            const c = el.querySelector('.smwb-carousel');
            if (c) return c;
            el = el.parentElement;
        }
        return null;
    }

    async function goToSubscriberSlide(target) {
        const carousel = getSubscriberCarousel();
        if (!carousel) {
            log('–ö–∞—Ä—É—Å–µ–ª—å –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'warning');
            return false;
        }

        const getDots    = () => carousel.querySelectorAll('.smwb-carousel__navigation__dot');
        const getCurrent = () => {
            const dots = getDots();
            for (let i = 0; i < dots.length; i++) if (dots[i].classList.contains('current')) return i;
            return 0;
        };

        for (let attempt = 0; attempt < 6; attempt++) {
            if (getCurrent() === target) return true;

            const diff    = target - getCurrent();
            const nextBtn = carousel.querySelector('.smwb-carousel__arrow_next');
            const prevBtn = carousel.querySelector('.smwb-carousel__arrow_prev');
            const btn     = diff > 0 ? nextBtn : prevBtn;

            if (btn) {
                for (let c = 0; c < Math.abs(diff); c++) {
                    ['mousedown', 'mouseup', 'click'].forEach(t =>
                        btn.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                    );
                    await sleep(350);
                }
            }

            if (getCurrent() === target) return true;

            // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –∫–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const dots = getDots();
            if (target < dots.length) {
                const dot = dots[target].querySelector('button') || dots[target];
                ['mousedown', 'mouseup', 'click'].forEach(t =>
                    dot.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(500);
                if (getCurrent() === target) return true;
            }

            await sleep(300);
        }
        return false;
    }

    /******************************************************************
     * –ù–ê–ì–†–£–ó–ö–ò
     ******************************************************************/
    function buildDesiredLoads() {
        const list = [];
        for (let i = 0; i < db.additionalLoad.streetLamp; i++) {
            const lamp = db.lamps[i] || { type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' };
            list.push({ type: '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π', lamp });
        }
        for (let i = 0; i < db.additionalLoad.streetLantern; i++)
            list.push({ type: '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫' });
        for (let i = 0; i < db.additionalLoad.communicationCabinet; i++)
            list.push({ type: '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π', owner: '–ù/–î' });
        for (let i = 0; i < db.additionalLoad.communicationLine; i++)
            list.push({ type: '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏', lineType: '–í–û–õ–°' });
        for (let i = 0; i < db.additionalLoad.volsMuffle; i++)
            list.push({ type: '–º—É—Ñ—Ç–∞ –í–û–õ–°' });
        for (let i = 0; i < db.additionalLoad.voltageLines; i++)
            list.push({ type: '–ª–∏–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è' });
        return list;
    }

    function getLoadCounter() {
        const inp = document.querySelector('input[name="additionalLoad.count"]');
        if (!inp) return null;
        const cont = inp.closest('.zC3boZPYpGZ1oTnRKpH9') || inp.closest('.MUUhtVW6OxD9dYFURbyO') || inp.parentElement;
        return { input: inp, plus: cont.querySelector('button.tKCNx3Mjilgu1eJFpBSs'), minus: cont.querySelector('button.bfwPpp5XjJbr4xH4oW1r'), count: () => parseInt(inp.value) || 0 };
    }

    async function fillLoad(loadIndex, loadData) {
        const { type } = loadData;
        const typeSelector = `input[name="additionalLoad.info[${loadIndex}].type"]`;
        let typeInput = document.querySelector(typeSelector);
        if (!typeInput) {
            const dots = document.querySelectorAll('.smwb-carousel__navigation__dot');
            const slideIdx = loadIndex + 1;
            if (slideIdx < dots.length) {
                const d = dots[slideIdx].querySelector('button') || dots[slideIdx];
                ['mousedown', 'mouseup', 'click'].forEach(t =>
                    d.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
                );
                await sleep(600);
            }
            typeInput = await waitForField(typeSelector, 8000);
        }
        if (!typeInput) return false;
        await fillField(typeSelector, type, `–¢–∏–ø[${loadIndex}]`);
        await sleep(200);
        if (type === '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π') {
            await fillField(`input[name="additionalLoad.info[${loadIndex}].distributionCabinetOwner"]`, loadData.owner || '–ù/–î', `–í–ª–∞–¥–µ–ª–µ—Ü[${loadIndex}]`);
        } else if (type === '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏') {
            await fillField(`input[name="additionalLoad.info[${loadIndex}].communicationLineType"]`, loadData.lineType || '–í–û–õ–°', `–¢–∏–ø –ª–∏–Ω–∏–∏[${loadIndex}]`);
        } else if (type === '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π' && loadData.lamp) {
            const lamp = loadData.lamp;
            const lt   = lamp.type === '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é' ? lamp.customType : lamp.type;
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampType"]`, lt, `–õ–∞–º–ø–∞[${loadIndex}]`);
            await sleep(150);
            const powerInp = document.querySelector(`input[name="additionalLoad.info[${loadIndex}].streetLampPower"]`);
            if (powerInp) {
                const powerCont  = powerInp.closest('.zC3boZPYpGZ1oTnRKpH9') || powerInp.closest('.MUUhtVW6OxD9dYFURbyO') || powerInp.parentElement;
                const powerMinus = powerCont ? powerCont.querySelector('button.bfwPpp5XjJbr4xH4oW1r') : null;
                const powerPlus  = powerCont ? powerCont.querySelector('button.tKCNx3Mjilgu1eJFpBSs') : null;
                const getVal = () => parseInt(powerInp.value) || 0;
                if (powerMinus && powerPlus) {
                    let attempts = 0;
                    while (getVal() !== 3 && attempts < 4) {
                        getVal() > 3 ? powerMinus.click() : powerPlus.click();
                        await sleep(300);
                        attempts++;
                    }
                    if (getVal() !== 3) log(`–ú–æ—â–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞—Ä—è[${loadIndex}]: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å 3 (–æ—Å—Ç–∞–ª–æ—Å—å ${getVal()}), –ø—Ä–æ–ø—É—â–µ–Ω–æ`, 'debug');
                }
            }
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampMountType"]`, lamp.mounting, `–ö—Ä–µ–ø–ª–µ–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampFasteningType"]`, lamp.powerSupply, `–ü–∏—Ç–∞–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            await fillField(`input[name="additionalLoad.info[${loadIndex}].streetLampLuminaireDirection"]`, lamp.direction, `–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ[${loadIndex}]`);
            await sleep(150);
            await clickCameraN(`fieldset[name="additionalLoad.info[${loadIndex}].streetLampPhotoUrls"]`, 2);
            await sleep(150);
            await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].streetLampMountPhotoUrls"] button.smwb-fab`);
        } else if (type === '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫') {
            await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].lampBracketPhotoUrls"] button.smwb-fab`);
        } else if (type === '–º—É—Ñ—Ç–∞ –í–û–õ–°') {
            await fillField(`input[name="additionalLoad.info[${loadIndex}].fiberOpticSpliceClosureOwner"]`, '–ù/–î', `–í–ª–∞–¥–µ–ª–µ—Ü –º—É—Ñ—Ç—ã[${loadIndex}]`);
        }
        await sleep(150);
        await clickCamera(`fieldset[name="additionalLoad.info[${loadIndex}].photoUrls"] button.smwb-fab`);
        return true;
    }

    async function syncLoads() {
        const desired = buildDesiredLoads();
        const N = desired.length;
        const counter = await (async () => {
            for (let i = 0; i < 10; i++) { const c = getLoadCounter(); if (c && c.plus && c.minus) return c; await sleep(500); }
            return null;
        })();
        if (!counter) return;
        let siteCount = counter.count();
        if (siteCount > N) {
            for (let i = 0; i < siteCount - N; i++) { counter.minus.click(); await sleep(700); }
        } else if (siteCount < N) {
            for (let i = 0; i < N - siteCount; i++) { counter.plus.click(); await sleep(700); }
        }
        siteCount = counter.count();
        if (siteCount !== N) return;
        for (let i = 0; i < N; i++) { await fillLoad(i, desired[i]); await sleep(200); }
    }

    /******************************************************************
     * –ò–ó–û–õ–Ø–¢–û–†–´
     ******************************************************************/
    async function syncInsulators() {
        const ins = db.insulators;
        if (!ins || ins.count < 1) return;

        log(`\n=== –ò–ó–û–õ–Ø–¢–û–†–´ (–≥—Ä—É–ø–ø: ${ins.count}, —à—Ç.: ${ins.qty}) ===`, 'info');

        // –í—ã—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø
        if (!await setCounter('input[name="insulator.count"]', ins.count)) {
            log('  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø', 'error');
            return;
        }
        await sleep(600);

        for (let i = 0; i < ins.count; i++) {
            log(`  –ò–∑–æ–ª—è—Ç–æ—Ä ${i + 1}/${ins.count}`, 'info');

            // –ù–∞–π—Ç–∏ –∫–∞—Ä—É—Å–µ–ª—å –∏–∑–æ–ª—è—Ç–æ—Ä–æ–≤ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–ª–∞–π–¥
            const insCard = (() => {
                const inp = document.querySelector('input[name="insulator.count"]');
                if (!inp) return null;
                const card = inp.closest('.smwb-card');
                return card ? card.querySelector('.smwb-carousel') : null;
            })();

            if (insCard) {
                const getDots    = () => insCard.querySelectorAll('.smwb-carousel__navigation__dot');
                const getCurrent = () => { const d = getDots(); for (let k=0;k<d.length;k++) if (d[k].classList.contains('current')) return k; return 0; };
                for (let attempt = 0; attempt < 5 && getCurrent() !== i; attempt++) {
                    const diff = i - getCurrent();
                    const btn  = diff > 0
                        ? insCard.querySelector('.smwb-carousel__arrow_next')
                        : insCard.querySelector('.smwb-carousel__arrow_prev');
                    if (btn) { for (let c=0;c<Math.abs(diff);c++) { btn.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); await sleep(350); } }
                    if (getCurrent() === i) break;
                    const dots = getDots();
                    if (i < dots.length) { (dots[i].querySelector('button')||dots[i]).dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); await sleep(500); }
                    await sleep(300);
                }
            }

            // –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π
            for (let r=0;r<10;r++) {
                if (document.querySelector(`input[name="insulator.info[${i}].type"]`)) break;
                await sleep(300);
            }

            await fillField(`input[name="insulator.info[${i}].type"]`,     ins.type,     `–¢–∏–ø –∏–∑–æ–ª—è—Ç–æ—Ä–∞[${i}]`);
            await sleep(150);
            await fillField(`input[name="insulator.info[${i}].material"]`, ins.material, `–ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑–æ–ª—è—Ç–æ—Ä–∞[${i}]`);
            await sleep(150);

            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ –≤ –≥—Ä—É–ø–ø–µ
            await setCounter(`input[name="insulator.info[${i}].count"]`, ins.qty);
            await sleep(200);

            // –§–∏–¥–µ—Ä ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω
            const fiderFieldset = document.querySelector(`fieldset[name="insulator.info[${i}].fider"]`);
            if (fiderFieldset) {
                const fiderSelect = fiderFieldset.querySelector('.smwb-select-field');
                const currentVal  = fiderFieldset.querySelector('.smwb-select-field__values');
                const alreadySet  = currentVal && currentVal.textContent.trim() !== '';
                if (!alreadySet && fiderSelect) {
                    ['mousedown','mouseup','click'].forEach(t =>
                        fiderSelect.dispatchEvent(new MouseEvent(t,{bubbles:true,cancelable:true,view:window}))
                    );
                    await sleep(400);
                    const firstItem = document.querySelector('.smwb-menu__item');
                    if (firstItem) {
                        ['mousedown','mouseup','click'].forEach(t =>
                            firstItem.dispatchEvent(new MouseEvent(t,{bubbles:true,cancelable:true,view:window}))
                        );
                        await sleep(200);
                        log(`  –§–∏–¥–µ—Ä: –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç`, 'success');
                    } else {
                        log(`  –§–∏–¥–µ—Ä: –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`, 'warning');
                    }
                } else if (alreadySet) {
                    log(`  –§–∏–¥–µ—Ä: —É–∂–µ –≤—ã–±—Ä–∞–Ω "${currentVal.textContent.trim()}", –ø—Ä–æ–ø—É—â–µ–Ω–æ`, 'debug');
                }
            }
            await sleep(150);

            // –§–æ—Ç–æ
            await clickCamera(`fieldset[name="insulator.info[${i}].photoUrls"] button.smwb-fab`);
            await sleep(150);
        }

        log('  ‚úÖ –ò–∑–æ–ª—è—Ç–æ—Ä—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã', 'success');
    }

    /******************************************************************
     * –ê–ë–û–ù–ï–ù–¢–´ ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
     ******************************************************************/

    /******************************************************************
     * –°–ò–°–¢–ï–ú–ê –ü–û–°–¢–û–Ø–ù–ù–û–ô –ü–û–î–°–í–ï–¢–ö–ò –û–®–ò–ë–û–ö
     ******************************************************************/
    // –•—Ä–∞–Ω–∏—Ç CSS-—Å–µ–ª–µ–∫—Ç–æ—Ä—ã –ø–æ–ª–µ–π —Å –æ—à–∏–±–∫–∞–º–∏
    const errorSelectors = new Set();

    const ERROR_STYLE = `
        outline: 3px solid #ef4444 !important;
        outline-offset: 3px !important;
        border-radius: 8px !important;
        background: rgba(239,68,68,0.15) !important;
        box-shadow: 0 0 0 5px rgba(239,68,68,0.2), 0 0 16px rgba(239,68,68,0.35) !important;
    `;

    function applyErrorStyle(el) {
        if (!el) return;
        const holder = el.closest('.smwb-text-field') || el.closest('fieldset') || el.parentElement;
        if (!holder) return;
        holder.setAttribute('data-pillar-error', '1');
        holder.style.cssText += ERROR_STYLE;
    }

    // –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    function reapplyErrors() {
        for (const sel of errorSelectors) {
            const el = document.querySelector(sel);
            if (el) {
                const holder = el.closest('.smwb-text-field') || el.closest('fieldset') || el.parentElement;
                // –ï—Å–ª–∏ holder —É–∂–µ –∏–º–µ–µ—Ç –∞—Ç—Ä–∏–±—É—Ç ‚Äî —É–∂–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
                if (holder && !holder.hasAttribute('data-pillar-error')) {
                    applyErrorStyle(el);
                }
            }
        }
    }

    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ DOM –∏ –ø–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ ‚Äî —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç
    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–∞ React (–ø—Ä–∏ –ª–∏—Å—Ç–∞–Ω–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏)
    const errorPersistObserver = new MutationObserver(() => {
        if (errorSelectors.size === 0) return;
        reapplyErrors();
        // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å
        if (!document.querySelector('fieldset[name="pillarType"]') && !document.querySelector('input[name="stand.count"]')) {
            errorSelectors.clear();
        }
    });
    errorPersistObserver.observe(document.body, { childList: true, subtree: true });

    // –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ –∫–∞–∫ –æ—à–∏–±–æ—á–Ω–æ–µ –∏ —Å—Ä–∞–∑—É –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
    function highlightFieldError(el, selector) {
        if (!el) return;
        if (selector) errorSelectors.add(selector);
        applyErrorStyle(el);
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)
    function clearAllErrors() {
        errorSelectors.clear();
        document.querySelectorAll('[data-pillar-error]').forEach(el => {
            el.removeAttribute('data-pillar-error');
            el.style.outline = '';
            el.style.outlineOffset = '';
            el.style.borderRadius = '';
            el.style.background = '';
            el.style.boxShadow = '';
        });
    }

    // –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤ smwb-select –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ
    async function selectFirstIfEmpty(fieldsetSelector) {
        const fs = document.querySelector(fieldsetSelector);
        if (!fs) return false;
        const valEl  = fs.querySelector('.smwb-select-field__values');
        const selEl  = fs.querySelector('.smwb-select-field');
        const alreadySet = valEl && valEl.textContent.trim() !== '';
        if (alreadySet) return true; // —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
        if (!selEl) return false;
        ['mousedown','mouseup','click'].forEach(t =>
            selEl.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
        );
        await sleep(400);
        const firstItem = document.querySelector('.smwb-menu__item');
        if (firstItem) {
            ['mousedown','mouseup','click'].forEach(t =>
                firstItem.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window }))
            );
            await sleep(200);
            return true;
        }
        return false;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∞ —É –∞–±–æ–Ω–µ–Ω—Ç–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç input –∏ select)
    function getSubscriberCable(i) {
        const inp   = document.querySelector(`input[name="subscribers.info[${i}].cableType"]`);
        const selEl = document.querySelector(`fieldset[name="subscribers.info[${i}].cableType"] .smwb-select-field__values`);
        return (inp ? inp.value : (selEl ? selEl.textContent : '')).trim();
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≤–æ–¥ –ø–æ —Ñ–∞–∑–µ
    // –§–∞–∑–∞ A/B/C ‚Üí –°–ò–ü 2—Ö16, –ê–í–í–ì 2—Ö16, –ê-16
    // –§–∞–∑–∞ ABC   ‚Üí –°–ò–ü 4—ÖY, –ê–í–í–ì 4—ÖY, –ê-Y  –≥–¥–µ Y > 16
    function validateCableForPhase(cable, phase) {
        if (!cable) return false;
        const singlePhase = /^(A|B|C)$/i.test(phase);
        const threePhase  = /^ABC$/i.test(phase);

        if (singlePhase) {
            if (/^–°–ò–ü 2—Ö16$/i.test(cable))  return true;
            if (/^–ê–í–í–ì 2—Ö16$/i.test(cable)) return true;
            if (/^–ê-16$/.test(cable))        return true;
            return false;
        }
        if (threePhase) {
            let m;
            m = cable.match(/^–°–ò–ü 4—Ö(\d+)$/i);
            if (m && parseInt(m[1]) > 16) return true;
            m = cable.match(/^–ê–í–í–ì 4—Ö(\d+)$/i);
            if (m && parseInt(m[1]) > 16) return true;
            m = cable.match(/^–ê-(\d+)$/);
            if (m && parseInt(m[1]) > 16) return true;
            return false;
        }
        return true; // –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ–∞–∑–∞ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
    }

    /******************************************************************
     * –ê–ë–û–ù–ï–ù–¢–´
     ******************************************************************/
    async function syncSubscribers() {
        if (!db.subscribers.settlement && !db.subscribers.street) {
            log('–ê–±–æ–Ω–µ–Ω—Ç—ã: –ø–æ–ª—è –ø—É—Å—Ç—ã, –ø—Ä–æ–ø—É—â–µ–Ω–æ', 'debug');
            return;
        }
        const countInp = document.querySelector('input[name="subscribers.count"]');
        if (!countInp) {
            log('–ê–±–æ–Ω–µ–Ω—Ç—ã: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'debug');
            return;
        }
        const total = parseInt(countInp.value) || 0;
        if (total === 0) {
            log('–ê–±–æ–Ω–µ–Ω—Ç—ã: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 0', 'debug');
            return;
        }

        log(`\n=== –ê–ë–û–ù–ï–ù–¢–´ (${total}) ===`, 'info');

        for (let i = 0; i < total; i++) {
            log(`–ê–±–æ–Ω–µ–Ω—Ç ${i + 1}/${total}`, 'info');

            const moved = await goToSubscriberSlide(i);
            if (!moved) log(`  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–∞–π–¥—É ${i}`, 'warning');
            await sleep(400);

            // –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ DOM (React —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å–ª–∞–π–¥—ã –ª–µ–Ω–∏–≤–æ)
            for (let retry = 0; retry < 10; retry++) {
                const s = document.querySelector(`input[name="subscribers.info[${i}].settlement"]`);
                const r = document.querySelector(`input[name="subscribers.info[${i}].street"]`);
                if (s && r) break;
                await sleep(300);
            }

            // ‚îÄ‚îÄ –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç / –£–ª–∏—Ü–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (db.subscribers.settlement) {
                const ok = await fillField(
                    `input[name="subscribers.info[${i}].settlement"]`,
                    db.subscribers.settlement,
                    `–ù–∞—Å. –ø—É–Ω–∫—Ç[${i}]`
                );
                log(`  –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç: ${ok ? '‚úÖ' : '‚ùå'} "${db.subscribers.settlement}"`, ok ? 'success' : 'warning');
                await sleep(150);
            }

            if (db.subscribers.street) {
                const ok = await fillField(
                    `input[name="subscribers.info[${i}].street"]`,
                    db.subscribers.street,
                    `–£–ª–∏—Ü–∞[${i}]`
                );
                log(`  –£–ª–∏—Ü–∞: ${ok ? '‚úÖ' : '‚ùå'} "${db.subscribers.street}"`, ok ? 'success' : 'warning');
                await sleep(150);
            }

            // ‚îÄ‚îÄ –¢–ü ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const tpOk = await selectFirstIfEmpty(`fieldset[name="subscribers.info[${i}].substation"]`);
            const tpVal = (document.querySelector(`fieldset[name="subscribers.info[${i}].substation"] .smwb-select-field__values`) || {}).textContent?.trim() || '';
            if (!tpVal) {
                log(`  –¢–ü: ‚ùå –Ω–µ –≤—ã–±—Ä–∞–Ω–æ`, 'warning');
                const tpSel = `fieldset[name="subscribers.info[${i}].substation"] .smwb-select-field`;
                highlightFieldError(document.querySelector(tpSel), tpSel);
            } else {
                log(`  –¢–ü: ‚úÖ "${tpVal}"`, 'success');
            }
            await sleep(150);

            // ‚îÄ‚îÄ –§–∏–¥–µ—Ä ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const fiderOk = await selectFirstIfEmpty(`fieldset[name="subscribers.info[${i}].fider"]`);
            const fiderVal = (document.querySelector(`fieldset[name="subscribers.info[${i}].fider"] .smwb-select-field__values`) || {}).textContent?.trim() || '';
            if (!fiderVal) {
                log(`  –§–∏–¥–µ—Ä: ‚ùå –Ω–µ –≤—ã–±—Ä–∞–Ω`, 'warning');
                const fiderSel = `fieldset[name="subscribers.info[${i}].fider"] .smwb-select-field`;
                highlightFieldError(document.querySelector(fiderSel), fiderSel);
            } else {
                log(`  –§–∏–¥–µ—Ä: ‚úÖ "${fiderVal}"`, 'success');
            }
            await sleep(150);

            // ‚îÄ‚îÄ –°–ø–æ—Å–æ–± –∫—Ä–µ–ø–ª–µ–Ω–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –ù–∞—Ç—è–∂–Ω–æ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            await fillField(`input[name="subscribers.info[${i}].fastening.type"]`, '–ù–∞—Ç—è–∂–Ω–æ–µ', `–ö—Ä–µ–ø–ª–µ–Ω–∏–µ[${i}]`);
            await sleep(150);

            // ‚îÄ‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–æ–¥–∞ –ø–æ —Ñ–∞–∑–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const phaseInp = document.querySelector(`input[name="subscribers.info[${i}].phasesType"]`);
            const phase = phaseInp ? phaseInp.value.trim() : '';
            const cable = getSubscriberCable(i);

            const cableValid = validateCableForPhase(cable, phase);
            if (!cableValid || !cable) {
                const singlePhase = /^(A|B|C)$/i.test(phase);
                const threePhase  = /^ABC$/i.test(phase);
                const hint = singlePhase
                    ? '–û–∂–∏–¥–∞–µ—Ç—Å—è: –°–ò–ü 2—Ö16 / –ê–í–í–ì 2—Ö16 / –ê-16'
                    : threePhase
                        ? '–û–∂–∏–¥–∞–µ—Ç—Å—è: –°–ò–ü 4—ÖY / –ê–í–í–ì 4—ÖY / –ê-Y (Y > 16)'
                        : `–§–∞–∑–∞: "${phase}" ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è`;
                log(`  –ü—Ä–æ–≤–æ–¥: ‚ùå "${cable || '–ø—É—Å—Ç–æ'}" (—Ñ–∞–∑–∞ "${phase}") ‚Äî ${hint}`, 'warning');
                // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ø–æ–ª–µ –ø—Ä–æ–≤–æ–¥–∞ –∫—Ä–∞—Å–Ω—ã–º –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ–æ–∫—É—Å –Ω–∞ –Ω–µ–≥–æ
                const cableInpEl = document.querySelector(`input[name="subscribers.info[${i}].cableType"]`)
                                || document.querySelector(`fieldset[name="subscribers.info[${i}].cableType"] .smwb-select-field`);
                const cableSel = document.querySelector(`input[name="subscribers.info[${i}].cableType"]`)
                    ? `input[name="subscribers.info[${i}].cableType"]`
                    : `fieldset[name="subscribers.info[${i}].cableType"] .smwb-select-field`;
                highlightFieldError(cableInpEl, cableSel);
                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª —É—Å–ø–µ–ª –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å, –∑–∞—Ç–µ–º —Ñ–æ–∫—É—Å
                await sleep(400);
                if (cableInpEl) cableInpEl.focus();
            } else {
                log(`  –ü—Ä–æ–≤–æ–¥: ‚úÖ "${cable}" (—Ñ–∞–∑–∞ "${phase}")`, 'success');
            }

            // ‚îÄ‚îÄ –ù–∞—Ç—è–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∞ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º –ü–û–°–õ–ï —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø—Ä–æ–≤–æ–¥–µ ‚îÄ
            await sleep(150);
            const isTypeA = /^(–ê|–ê–°)-\d+$/i.test(cable);
            const wireTension = isTypeA ? '–í—è–∑–∫–∞ –∫–æ–Ω—Ü–µ–≤–∞—è' : '–ó–∞–∂–∏–º –Ω–∞—Ç—è–∂–Ω–æ–π –∫–ª–∏–Ω–æ–≤–æ–π';
            await fillField(`input[name="subscribers.info[${i}].wireTension"]`, wireTension, `–ù–∞—Ç—è–∂–µ–Ω–∏–µ[${i}]`);
            log(`  –ù–∞—Ç—è–∂–µ–Ω–∏–µ: "${wireTension}"`, 'debug');
            await sleep(150);
        }
    }

    /******************************************************************
     * –ê–í–¢–û–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –§–û–†–ú–´
     ******************************************************************/
    async function loadFromForm() {
        try {
            let changed = false;
            const pillarEl = document.querySelector('fieldset[name="pillarType"] .smwb-select-field__values');
            if (pillarEl) {
                const t = pillarEl.textContent.trim();
                if (t && PILLAR_TYPE_TO_MATERIAL[t] && db.pillar.type !== t) {
                    db.pillar.type = t; db.pillar.material = PILLAR_TYPE_TO_MATERIAL[t];
                    db.stands.material = db.pillar.material; changed = true;
                }
            }
            const pairs = [
                ['input[name="constructionType"]', v => { db.pillar.constructionType = v; }],
                ['input[name="placement"]',        v => { db.pillar.placement = v; }],
                ['input[name="material"]',         v => { db.pillar.material = v; db.stands.material = v; }]
            ];
            for (const [sel, setter] of pairs) {
                const el = document.querySelector(sel);
                if (el?.value) { setter(el.value); changed = true; }
            }
            const sc = document.querySelector('input[name="stand.count"]');
            if (sc) { const v = parseInt(sc.value)||0; if (db.stands.count !== v) { db.stands.count = v; changed = true; } }
            const bc = document.querySelector('input[name="bracing.count"]');
            if (bc) { const v = parseInt(bc.value)||0; if (db.bracing.count !== v) { db.bracing.count = v; changed = true; } }
            const bm = document.querySelector('input[name="bracing.info[0].material"]') ||
                       document.querySelector('input[name="bracing.material"]');
            if (bm?.value && db.bracing.material !== bm.value) { db.bracing.material = bm.value; changed = true; }
            const loadCounter = getLoadCounter();
            if (loadCounter) {
                const siteLoadCount = loadCounter.count();
                let cabs=0, lines=0, lamps=0, muffles=0, lanterns=0, voltLines=0;
                for (let i = 0; i < siteLoadCount; i++) {
                    const ti = document.querySelector(`input[name="additionalLoad.info[${i}].type"]`);
                    if (!ti) continue;
                    const v = ti.value.trim();
                    if (v === '—à–∫–∞—Ñ –∫–æ–º–º—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π') cabs++;
                    else if (v === '–ª–∏–Ω–∏—è —Å–≤—è–∑–∏') lines++;
                    else if (v === '—Ñ–æ–Ω–∞—Ä—å —É–ª–∏—á–Ω—ã–π') lamps++;
                    else if (v === '–º—É—Ñ—Ç–∞ –í–û–õ–°') muffles++;
                    else if (v === '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫') lanterns++;
                    else if (v === '–ª–∏–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è') voltLines++;
                }
                if (db.additionalLoad.communicationCabinet !== cabs || db.additionalLoad.communicationLine !== lines ||
                    db.additionalLoad.streetLamp !== lamps || db.additionalLoad.volsMuffle !== muffles ||
                    db.additionalLoad.streetLantern !== lanterns || db.additionalLoad.voltageLines !== voltLines) {
                    db.additionalLoad.communicationCabinet = cabs;
                    db.additionalLoad.communicationLine = lines;
                    db.additionalLoad.streetLamp = lamps;
                    db.additionalLoad.volsMuffle = muffles;
                    db.additionalLoad.streetLantern = lanterns;
                    db.additionalLoad.voltageLines = voltLines;
                    db.lamps = Array.from({ length: lamps }, () => ({ type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' }));
                    changed = true;
                }
            }
            if (changed) { saveDb(); updateUI(); }
        } catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e); }
    }

    let formDetected = false;
    function startDetection() {
        setInterval(async () => {
            const ok = document.querySelector('fieldset[name="pillarType"]') && document.querySelector('input[name="constructionType"]');
            if (ok && !formDetected) { formDetected = true; await sleep(800); await loadFromForm(); }
            if (!ok && formDetected) formDetected = false;
        }, 2000);
    }

    /******************************************************************
     * UI (SHADOW DOM)
     ******************************************************************/
    const host = document.createElement('div');
    host.id = 'pillar-ui-host';
    host.style.display = 'none';
    document.body.appendChild(host);
    const shadow = host.attachShadow({ mode: 'open' });

    const css = `
    @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    .root { position: fixed; width: 340px; background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; z-index: 1000000; box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1); color: #fff; overflow: hidden; animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: top left; display: flex; flex-direction: column; max-height: 90vh; }

    .header { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 8px 12px; cursor: move; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); user-select: none; flex-shrink: 0; }
    .header-title { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 13px; letter-spacing: 0.3px; }
    .header-icon { width: 18px; height: 18px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
    .header-controls { display: flex; gap: 6px; align-items: center; }
    .header-btn { width: 24px; height: 24px; border-radius: 5px; background: rgba(255,255,255,0.1); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; line-height: 1; }
    .header-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

    .collapsed-info { padding: 8px 12px; display: none; flex-direction: column; gap: 6px; background: rgba(0,0,0,0.2); }
    .collapsed-info.visible { display: flex; }
    .collapsed-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .collapsed-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; font-size: 9px; }
    .collapsed-value { font-weight: 700; font-size: 11px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.3); color: #a78bfa; }

    .body { padding: 10px 12px; padding-bottom: 70px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex: 1; }
    .body::-webkit-scrollbar { width: 5px; }
    .body::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
    .body::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 3px; }
    .body::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.7); }

    .status-panel { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
    .status-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .status-label { color: rgba(255,255,255,0.6); font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; font-size: 9px; }
    .status-value { font-weight: 700; font-size: 11px; padding: 3px 8px; border-radius: 5px; background: rgba(0,0,0,0.3); color: #a78bfa; }

    .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); margin: 2px 0; }

    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-label { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.3px; }
    .field-label-icon { font-size: 12px; }
    .field-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; padding: 7px 10px; color: #fff; font-size: 12px; transition: all 0.2s; outline: none; font-family: inherit; width: 100%; }
    .field-input:focus { border-color: rgba(139,92,246,0.6); background: rgba(0,0,0,0.4); box-shadow: 0 0 0 2px rgba(139,92,246,0.1); }
    .field-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; padding: 7px 10px; color: #fff; font-size: 12px; transition: all 0.2s; outline: none; font-family: inherit; width: 100%; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23fff' opacity='.5' d='M5 7L1 3h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
    .field-select:focus { border-color: rgba(139,92,246,0.6); box-shadow: 0 0 0 2px rgba(139,92,246,0.1); }
    .field-select option { background: #1e1b4b; }

    .number-control { display: flex; align-items: center; gap: 6px; }
    .number-btn { width: 26px; height: 26px; border-radius: 6px; border: none; background: rgba(139,92,246,0.2); color: #8b5cf6; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; transition: all 0.2s; flex-shrink: 0; }
    .number-btn:hover { background: rgba(139,92,246,0.35); transform: scale(1.05); }
    .number-display { flex: 1; text-align: center; font-size: 14px; font-weight: 700; color: #a78bfa; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 7px; }

    .compact-row { display: flex; gap: 6px; }
    .compact-row .field-group { flex: 1; }

    .load-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .load-tile { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px 10px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 4px; user-select: none; }
    .load-tile:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
    .load-tile.active { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.5); }
    .load-tile-header { display: flex; justify-content: space-between; align-items: center; }
    .load-tile-icon { font-size: 15px; }
    .load-tile-count { background: rgba(139,92,246,0.3); color: #a78bfa; border-radius: 5px; padding: 2px 7px; font-weight: 700; font-size: 12px; min-width: 22px; text-align: center; }
    .load-tile.active .load-tile-count { background: rgba(139,92,246,0.5); color: #c4b5fd; }
    .load-tile-name { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.3px; }
    .load-tile.active .load-tile-name { color: rgba(167,139,250,0.9); }
    .load-hint { font-size: 9px; color: rgba(255,255,255,0.35); text-align: center; margin-top: 2px; }

    .footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 12px; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.4)); display: flex; gap: 6px; backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); }
    .btn { flex: 1; padding: 9px 16px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-fill { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; box-shadow: 0 3px 10px rgba(139,92,246,0.3); }
    .btn-fill:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139,92,246,0.4); }
    .btn-scan { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.3)); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
    .btn-scan:hover:not(:disabled) { background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.4)); transform: translateY(-1px); }

    .scale-controls { display: flex; align-items: center; gap: 4px; }
    .scale-btn { width: 20px; height: 20px; border-radius: 4px; border: none; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; transition: all 0.2s; }
    .scale-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
    .scale-value { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.8); min-width: 32px; text-align: center; }

    .log-panel { position: fixed; bottom: 20px; right: 20px; width: 420px; max-height: 320px; background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1); z-index: 999999; display: flex; flex-direction: column; overflow: hidden; }
    .log-panel.hidden { display: none; }
    .log-header { background: rgba(0,0,0,0.3); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
    .log-title { font-weight: 700; font-size: 12px; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 6px; }
    .log-actions { display: flex; gap: 5px; }
    .log-btn { padding: 4px 8px; background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.3); border-radius: 5px; color: #a78bfa; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .log-btn:hover { background: rgba(139,92,246,0.3); }
    .log-content { flex: 1; overflow-y: auto; padding: 10px 12px; }
    .log-content::-webkit-scrollbar { width: 4px; }
    .log-content::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 2px; }
    .log-entry { font-size: 10px; font-family: 'Menlo', 'Consolas', monospace; margin-bottom: 3px; line-height: 1.5; }

    .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(0,0,0,0.95)); border: 1px solid rgba(34,197,94,0.5); border-radius: 10px; padding: 12px 16px; color: #fff; font-size: 12px; font-weight: 600; z-index: 1000002; box-shadow: 0 8px 24px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; max-width: 280px; }
    .notification-warning { background: linear-gradient(135deg, rgba(234,179,8,0.95), rgba(0,0,0,0.95)); border-color: rgba(234,179,8,0.5); }
    .notification-error   { background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(0,0,0,0.95)); border-color: rgba(239,68,68,0.5); }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000001; }
    .modal-overlay.show { display: flex; }
    .modal { background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%); border-radius: 12px; padding: 20px; width: 90%; max-width: 340px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto; }
    .modal::-webkit-scrollbar { width: 4px; }
    .modal::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 2px; }
    .modal-title { font-size: 14px; font-weight: 700; margin-bottom: 14px; color: #fff; display: flex; align-items: center; gap: 6px; }
    .modal-content { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
    .modal-buttons { display: flex; gap: 6px; }
    .modal-btn { flex: 1; padding: 9px 16px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .modal-btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; }
    .modal-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(139,92,246,0.4); }
    .modal-btn-secondary { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
    .modal-btn-secondary:hover { background: rgba(255,255,255,0.15); }

    .lamp-card { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .lamp-card-title { font-size: 11px; font-weight: 700; color: #a78bfa; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .radio-group { display: flex; gap: 4px; flex-wrap: wrap; }
    .radio-option { flex: 1; min-width: calc(33.33% - 3px); }
    .radio-input  { display: none; }
    .radio-label  { display: flex; align-items: center; justify-content: center; padding: 6px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 7px; cursor: pointer; transition: all 0.2s; font-size: 11px; font-weight: 500; text-align: center; }
    .radio-label:hover { background: rgba(0,0,0,0.4); border-color: rgba(139,92,246,0.4); }
    .radio-input:checked + .radio-label { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.6); color: #a78bfa; font-weight: 600; }

    .discord-link { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 6px 10px; background: rgba(88,101,242,0.2); border: 1px solid rgba(88,101,242,0.3); border-radius: 7px; color: #5865f2; font-size: 10px; font-weight: 600; text-decoration: none; transition: all 0.2s; margin-top: 4px; }
    .discord-link:hover { background: rgba(88,101,242,0.3); transform: translateY(-1px); }

    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; cursor: pointer; user-select: none; transition: all 0.2s; }
    .toggle-row:hover { background: rgba(0,0,0,0.35); border-color: rgba(139,92,246,0.35); }
    .toggle-row.active { background: rgba(139,92,246,0.12); border-color: rgba(139,92,246,0.45); }
    .toggle-row-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.85); display: flex; align-items: center; gap: 6px; }
    .toggle-pill { width: 34px; height: 18px; border-radius: 9px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); position: relative; transition: all 0.25s; flex-shrink: 0; }
    .toggle-pill.on { background: rgba(139,92,246,0.6); border-color: rgba(139,92,246,0.8); }
    .toggle-thumb { width: 12px; height: 12px; border-radius: 50%; background: #fff; position: absolute; top: 2px; left: 2px; transition: all 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    .toggle-pill.on .toggle-thumb { left: 18px; }

    .insulator-section { display: flex; flex-direction: column; gap: 8px; }
    .insulator-section.hidden { display: none; }
    `;

    const html = `
    <div class="root" id="mainPanel">
        <div class="header" id="dragHandle">
            <div class="header-title">
                <div class="header-icon">üèóÔ∏è</div>
                <span>–û–ø–æ—Ä—ã v1.8.4</span>
            </div>
            <div class="header-controls">
                <div class="scale-controls">
                    <button class="scale-btn" id="btnScaleDown">‚àí</button>
                    <span class="scale-value" id="scaleValue">100%</span>
                    <button class="scale-btn" id="btnScaleUp">+</button>
                </div>
                <button class="header-btn" id="btnToggleLogs" title="–ñ—É—Ä–Ω–∞–ª">üìã</button>
                <button class="header-btn" id="btnMinimize">‚àí</button>
            </div>
        </div>

        <div class="collapsed-info" id="collapsedInfo">
            <div class="collapsed-row">
                <span class="collapsed-label">üèóÔ∏è –û–ø–æ—Ä–∞</span>
                <span class="collapsed-value" id="collapsedPillar">‚Äî</span>
            </div>
            <div class="collapsed-row">
                <span class="collapsed-label">üìê –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</span>
                <span class="collapsed-value" id="collapsedConstruct">‚Äî</span>
            </div>
        </div>

        <div class="body" id="bodyContent">
            <div class="status-panel">
                <div class="status-row">
                    <span class="status-label">üèóÔ∏è –ú–∞—Ä–∫–∞ –æ–ø–æ—Ä—ã</span>
                    <span class="status-value" id="statusPillar">‚Äî</span>
                </div>
                <div class="status-row">
                    <span class="status-label">üìê –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</span>
                    <span class="status-value" id="statusConstruct">‚Äî</span>
                </div>
            </div>

            <div class="divider"></div>

            <div class="field-group">
                <label class="field-label"><span class="field-label-icon">üèóÔ∏è</span>–ú–∞—Ä–∫–∞ –æ–ø–æ—Ä—ã</label>
                <select class="field-select" id="selPillarType"></select>
            </div>

            <div class="compact-row">
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üìê</span>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</label>
                    <select class="field-select" id="selConstructionType"></select>
                </div>
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üìç</span>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                    <select class="field-select" id="selPlacement"></select>
                </div>
            </div>

            <div class="divider"></div>

            <div class="compact-row">
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üîß</span>–£–∫–æ—Å—ã</label>
                    <div class="number-control">
                        <button class="number-btn" id="btnBrDown">‚àí</button>
                        <div class="number-display" id="dispBracing">0</div>
                        <button class="number-btn" id="btnBrUp">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">ü™µ</span>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select class="field-select" id="selBracingMat"></select>
                </div>
            </div>

            <div class="divider"></div>

            <div class="field-group">
                <label class="field-label"><span class="field-label-icon">‚ö°</span>–ù–∞–≥—Ä—É–∑–∫–∏</label>
                <div class="load-hint">–õ–ö–ú ‚Äî –¥–æ–±–∞–≤–∏—Ç—å ¬∑ –ü–ö–ú ‚Äî —É–±—Ä–∞—Ç—å</div>
                <div class="load-grid">
                    <div class="load-tile" id="loadCabinet">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üóÑÔ∏è</span>
                            <span class="load-tile-count" id="cntCabinet">0</span>
                        </div>
                        <div class="load-tile-name">–®–∫–∞—Ñ</div>
                    </div>
                    <div class="load-tile" id="loadCommLine">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üì°</span>
                            <span class="load-tile-count" id="cntCommLine">0</span>
                        </div>
                        <div class="load-tile-name">–õ–∏–Ω–∏—è —Å–≤—è–∑–∏</div>
                    </div>
                    <div class="load-tile" id="loadStreetLamp">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üí°</span>
                            <span class="load-tile-count" id="cntStreetLamp">0</span>
                        </div>
                        <div class="load-tile-name">–§–æ–Ω–∞—Ä—å</div>
                    </div>
                    <div class="load-tile" id="loadVolsMuffle">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üîå</span>
                            <span class="load-tile-count" id="cntVolsMuffle">0</span>
                        </div>
                        <div class="load-tile-name">–ú—É—Ñ—Ç–∞ –í–û–õ–°</div>
                    </div>
                    <div class="load-tile" id="loadStreetLantern">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">üîÜ</span>
                            <span class="load-tile-count" id="cntStreetLantern">0</span>
                        </div>
                        <div class="load-tile-name">–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫</div>
                    </div>
                    <div class="load-tile" id="loadVoltageLines">
                        <div class="load-tile-header">
                            <span class="load-tile-icon">‚ö°</span>
                            <span class="load-tile-count" id="cntVoltageLines">0</span>
                        </div>
                        <div class="load-tile-name">–†–∞–∑–Ω. –Ω–∞–ø—Ä.</div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="field-group">
                <label class="field-label"><span class="field-label-icon">üë§</span>–ê–±–æ–Ω–µ–Ω—Ç—ã (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)</label>
            </div>
            <div class="field-group">
                <label class="field-label">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                <input type="text" class="field-input" id="inpSettlement" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–ø–∞–ª–∏—Ö–∞">
            </div>
            <div class="field-group">
                <label class="field-label">–£–ª–∏—Ü–∞</label>
                <input type="text" class="field-input" id="inpStreet" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–π–±—ã—à–µ–≤–∞ –ø–µ—Ä.">
            </div>

            <div class="divider"></div>

            <div class="toggle-row" id="toggleWireTypeA">
                <span class="toggle-row-label"><span>üî©</span> –ü—Ä–æ–≤–æ–¥ —Ç–∏–ø–∞ "–ê"</span>
                <div class="toggle-pill" id="pillWireTypeA"><div class="toggle-thumb"></div></div>
            </div>

            <div class="insulator-section hidden" id="insulatorSection">
                <div class="field-group">
                    <label class="field-label"><span class="field-label-icon">üî©</span>–ò–∑–æ–ª—è—Ç–æ—Ä—ã</label>
                </div>
                <div class="compact-row">
                    <div class="field-group">
                        <label class="field-label">–¢–∏–ø</label>
                        <select class="field-select" id="selInsulatorType"></select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        <select class="field-select" id="selInsulatorMat"></select>
                    </div>
                </div>
                <div class="compact-row">
                    <div class="field-group">
                        <label class="field-label">–ì—Ä—É–ø–ø</label>
                        <div class="number-control">
                            <button class="number-btn" id="btnInsCountDown">‚àí</button>
                            <div class="number-display" id="dispInsCount">1</div>
                            <button class="number-btn" id="btnInsCountUp">+</button>
                        </div>
                    </div>
                    <div class="field-group">
                        <label class="field-label">–ö–æ–ª-–≤–æ –≤ –≥—Ä—É–ø–ø–µ</label>
                        <div class="number-control">
                            <button class="number-btn" id="btnInsQtyDown">‚àí</button>
                            <div class="number-display" id="dispInsQty">6</div>
                            <button class="number-btn" id="btnInsQtyUp">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <a href="#" class="discord-link" id="discordLink">
                <span>üí¨</span><span>Discord: KAST Team</span>
            </a>
        </div>

        <div class="footer">
            <button class="btn btn-scan" id="btnScan">
                <span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
            <button class="btn btn-fill" id="btnFill">
                <span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <div class="log-panel hidden" id="logPanel">
        <div class="log-header">
            <div class="log-title">üìã –ñ—É—Ä–Ω–∞–ª</div>
            <div class="log-actions">
                <button class="log-btn" id="btnCopyLogs">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="log-btn" id="btnClearLogs">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="log-btn" id="btnCloseLogs">‚úï</button>
            </div>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-entry" style="color:rgba(255,255,255,0.35);font-style:italic;">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAttach">
        <div class="modal">
            <div class="modal-title">ü™µ –ü—Ä–∏—Å—Ç–∞–≤–∫–∏</div>
            <div class="modal-content">
                <div class="field-group">
                    <label class="field-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <div class="number-control">
                        <button class="number-btn" id="btnAtDown">‚àí</button>
                        <div class="number-display" id="dispAttach">0</div>
                        <button class="number-btn" id="btnAtUp">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select class="field-select" id="selAttachMat"></select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="btnCancelAttach">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary"   id="btnConfirmAttach">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalLamps">
        <div class="modal">
            <div class="modal-title">üí° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–∞—Ä–µ–π</div>
            <div class="modal-content" id="lampsConfig"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="btnCancelLamps">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary"   id="btnConfirmLamps">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    `;

    shadow.innerHTML = `<style>${css}</style>${html}`;

    /******************************************************************
     * –°–°–´–õ–ö–ò –ù–ê –≠–õ–ï–ú–ï–ù–¢–´
     ******************************************************************/
    const ui = {
        main:           shadow.querySelector('#mainPanel'),
        body:           shadow.querySelector('#bodyContent'),
        btnMin:         shadow.querySelector('#btnMinimize'),
        btnTogLogs:     shadow.querySelector('#btnToggleLogs'),
        btnScaleUp:     shadow.querySelector('#btnScaleUp'),
        btnScaleDown:   shadow.querySelector('#btnScaleDown'),
        scaleValue:     shadow.querySelector('#scaleValue'),
        statusPillar:   shadow.querySelector('#statusPillar'),
        statusConstruct:shadow.querySelector('#statusConstruct'),
        collapsedInfo:  shadow.querySelector('#collapsedInfo'),
        collapsedPillar:shadow.querySelector('#collapsedPillar'),
        collapsedConst: shadow.querySelector('#collapsedConstruct'),
        selPillar:      shadow.querySelector('#selPillarType'),
        selConstruct:   shadow.querySelector('#selConstructionType'),
        selPlacement:   shadow.querySelector('#selPlacement'),
        dispBracing:    shadow.querySelector('#dispBracing'),
        btnBrUp:        shadow.querySelector('#btnBrUp'),
        btnBrDown:      shadow.querySelector('#btnBrDown'),
        selBracingMat:  shadow.querySelector('#selBracingMat'),
        loadCabinet:    shadow.querySelector('#loadCabinet'),
        loadCommLine:   shadow.querySelector('#loadCommLine'),
        loadStreetLamp: shadow.querySelector('#loadStreetLamp'),
        loadVolsMuffle: shadow.querySelector('#loadVolsMuffle'),
        cntCabinet:     shadow.querySelector('#cntCabinet'),
        cntCommLine:    shadow.querySelector('#cntCommLine'),
        cntStreetLamp:  shadow.querySelector('#cntStreetLamp'),
        cntVolsMuffle:  shadow.querySelector('#cntVolsMuffle'),
        loadStreetLantern: shadow.querySelector('#loadStreetLantern'),
        cntStreetLantern:  shadow.querySelector('#cntStreetLantern'),
        loadVoltageLines:  shadow.querySelector('#loadVoltageLines'),
        cntVoltageLines:   shadow.querySelector('#cntVoltageLines'),
        btnFill:        shadow.querySelector('#btnFill'),
        btnScan:        shadow.querySelector('#btnScan'),
        modalAttach:    shadow.querySelector('#modalAttach'),
        dispAttach:     shadow.querySelector('#dispAttach'),
        btnAtUp:        shadow.querySelector('#btnAtUp'),
        btnAtDown:      shadow.querySelector('#btnAtDown'),
        selAttachMat:   shadow.querySelector('#selAttachMat'),
        btnConfAtch:    shadow.querySelector('#btnConfirmAttach'),
        btnCancAtch:    shadow.querySelector('#btnCancelAttach'),
        modalLamps:     shadow.querySelector('#modalLamps'),
        lampsConfig:    shadow.querySelector('#lampsConfig'),
        btnConfLamps:   shadow.querySelector('#btnConfirmLamps'),
        btnCancLamps:   shadow.querySelector('#btnCancelLamps'),
        inpSettlement:  shadow.querySelector('#inpSettlement'),
        inpStreet:      shadow.querySelector('#inpStreet'),
        discordLink:    shadow.querySelector('#discordLink'),
        logPanel:       shadow.querySelector('#logPanel'),
        logContent:     shadow.querySelector('#logContent'),
        selInsulatorType:  shadow.querySelector('#selInsulatorType'),
        selInsulatorMat:   shadow.querySelector('#selInsulatorMat'),
        dispInsCount:      shadow.querySelector('#dispInsCount'),
        btnInsCountUp:     shadow.querySelector('#btnInsCountUp'),
        btnInsCountDown:   shadow.querySelector('#btnInsCountDown'),
        dispInsQty:        shadow.querySelector('#dispInsQty'),
        btnInsQtyUp:       shadow.querySelector('#btnInsQtyUp'),
        btnInsQtyDown:     shadow.querySelector('#btnInsQtyDown'),
        toggleWireTypeA:   shadow.querySelector('#toggleWireTypeA'),
        pillWireTypeA:     shadow.querySelector('#pillWireTypeA'),
        insulatorSection:  shadow.querySelector('#insulatorSection'),
    };

    /******************************************************************
     * –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
     ******************************************************************/
    let logMessages = [];
    function log(message, type = 'info') {
        const ts = new Date().toLocaleTimeString('ru-RU');
        logMessages.push({ time: ts, message, type });
        const colors = { success: '#22c55e', error: '#ef4444', warning: '#eab308', debug: '#60a5fa', info: 'rgba(255,255,255,0.5)' };
        const icons  = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', debug: 'üîç', info: '‚ÑπÔ∏è' };
        const el = document.createElement('div');
        el.className = 'log-entry';
        el.style.color = colors[type] || colors.info;
        el.innerHTML = `<span style="opacity:0.5;">[${ts}]</span> ${icons[type]||'‚ÑπÔ∏è'} ${message}`;
        ui.logContent.appendChild(el);
        ui.logContent.scrollTop = ui.logContent.scrollHeight;
    }
    function clearLogs() {
        logMessages = [];
        ui.logContent.innerHTML = '<div class="log-entry" style="color:rgba(255,255,255,0.35);font-style:italic;">–û—á–∏—â–µ–Ω–æ</div>';
    }
    function copyLogs() {
        const t = document.createElement('textarea');
        t.value = logMessages.map(e => `[${e.time}] ${e.message}`).join('\n');
        t.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(t);
        t.select();
        try { document.execCommand('copy'); showNotification('‚úÖ –õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!'); }
        catch { showNotification('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error'); }
        document.body.removeChild(t);
    }

    shadow.querySelector('#btnCopyLogs').addEventListener('click', copyLogs);
    shadow.querySelector('#btnClearLogs').addEventListener('click', () => clearLogs());
    shadow.querySelector('#btnCloseLogs').addEventListener('click', () => ui.logPanel.classList.add('hidden'));
    ui.btnTogLogs.addEventListener('click', () => {
        ui.logPanel.classList.toggle('hidden');
        ui.btnTogLogs.style.background = ui.logPanel.classList.contains('hidden') ? 'rgba(255,255,255,0.1)' : 'rgba(139,92,246,0.4)';
    });

    /******************************************************************
     * –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
     ******************************************************************/
    function showNotification(message, type = 'success') {
        const n = document.createElement('div');
        n.className = `notification notification-${type}`;
        n.textContent = message;
        shadow.appendChild(n);
        setTimeout(() => { n.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => n.remove(), 300); }, 3000);
    }

    /******************************************************************
     * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–õ–ï–ö–¢–û–í
     ******************************************************************/
    function initSelects() {
        const fill = (el, items) => items.forEach(v => {
            const o = document.createElement('option');
            o.value = v; o.textContent = v; el.appendChild(o);
        });
        fill(ui.selPillar,     PILLAR_TYPES);
        fill(ui.selConstruct,  CONSTRUCTION_TYPES.map(c => c.name));
        fill(ui.selPlacement,  PLACEMENT_TYPES);
        fill(ui.selBracingMat, BRACING_MATS);
        fill(ui.selAttachMat,  ATTACH_MATS);
        fill(ui.selInsulatorType, INSULATOR_TYPES);
        fill(ui.selInsulatorMat,  INSULATOR_MATS);
    }

    /******************************************************************
     * –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
     ******************************************************************/
    function updateUI() {
        ui.selPillar.value      = db.pillar.type;
        ui.selConstruct.value   = db.pillar.constructionType;
        ui.selPlacement.value   = db.pillar.placement;
        ui.dispBracing.textContent = db.bracing.count;
        ui.selBracingMat.value  = db.bracing.material;

        ui.inpSettlement.value = db.subscribers.settlement;
        ui.inpStreet.value     = db.subscribers.street;

        ui.selInsulatorType.value  = db.insulators.type;
        ui.selInsulatorMat.value   = db.insulators.material;
        ui.dispInsCount.textContent = db.insulators.count;
        ui.dispInsQty.textContent   = db.insulators.qty;

        ui.pillWireTypeA.classList.toggle('on', db.wireTypeA);
        ui.toggleWireTypeA.classList.toggle('active', db.wireTypeA);
        ui.insulatorSection.classList.toggle('hidden', !db.wireTypeA);

        ui.statusPillar.textContent    = db.pillar.type;
        ui.statusConstruct.textContent = db.pillar.constructionType;
        ui.collapsedPillar.textContent = db.pillar.type;
        ui.collapsedConst.textContent  = db.pillar.constructionType;

        const loads = [
            { tile: ui.loadCabinet,       cnt: ui.cntCabinet,       key: 'communicationCabinet' },
            { tile: ui.loadCommLine,      cnt: ui.cntCommLine,      key: 'communicationLine' },
            { tile: ui.loadStreetLamp,    cnt: ui.cntStreetLamp,    key: 'streetLamp' },
            { tile: ui.loadVolsMuffle,    cnt: ui.cntVolsMuffle,    key: 'volsMuffle' },
            { tile: ui.loadStreetLantern, cnt: ui.cntStreetLantern, key: 'streetLantern' },
            { tile: ui.loadVoltageLines,  cnt: ui.cntVoltageLines,  key: 'voltageLines' },
        ];
        loads.forEach(({ tile, cnt, key }) => {
            const v = db.additionalLoad[key];
            cnt.textContent = v;
            tile.classList.toggle('active', v > 0);
        });

        updateScale();
    }

    /******************************************************************
     * –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï
     ******************************************************************/
    function updateScale() {
        ui.main.style.transform = `scale(${db.ui.scale / 100})`;
        ui.scaleValue.textContent = `${db.ui.scale}%`;
    }
    ui.btnScaleUp.addEventListener('click',   () => { if (db.ui.scale < 150) { db.ui.scale += 5; updateScale(); saveDb(); } });
    ui.btnScaleDown.addEventListener('click', () => { if (db.ui.scale > 60)  { db.ui.scale -= 5; updateScale(); saveDb(); } });

    /******************************************************************
     * –°–û–ë–´–¢–ò–Ø –ü–û–õ–ï–ô
     ******************************************************************/
    ui.selPillar.addEventListener('change', e => {
        db.pillar.type = e.target.value;
        db.pillar.material = PILLAR_TYPE_TO_MATERIAL[e.target.value] || '–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è';
        db.stands.material = db.pillar.material; saveDb(); updateUI();
    });
    ui.selConstruct.addEventListener('change', e => {
        db.pillar.constructionType = e.target.value;
        const ct = CONSTRUCTION_TYPES.find(c => c.name === e.target.value);
        if (ct) db.stands.count = ct.stands; saveDb(); updateUI();
    });
    ui.selPlacement.addEventListener('change', e => { db.pillar.placement = e.target.value; saveDb(); });
    ui.btnBrUp.addEventListener('click',   () => { db.bracing.count++; saveDb(); updateUI(); });
    ui.btnBrDown.addEventListener('click', () => { if (db.bracing.count > 0) { db.bracing.count--; saveDb(); updateUI(); } });
    ui.selBracingMat.addEventListener('change', e => { db.bracing.material = e.target.value; saveDb(); });

    ui.inpSettlement.addEventListener('input', e => { db.subscribers.settlement = e.target.value; saveDb(); });
    ui.inpStreet.addEventListener('input',     e => { db.subscribers.street = e.target.value; saveDb(); });

    ui.selInsulatorType.addEventListener('change', e => { db.insulators.type = e.target.value; saveDb(); });
    ui.selInsulatorMat.addEventListener('change',  e => { db.insulators.material = e.target.value; saveDb(); });
    ui.btnInsCountUp.addEventListener('click',   () => { db.insulators.count++; ui.dispInsCount.textContent = db.insulators.count; saveDb(); });
    ui.btnInsCountDown.addEventListener('click', () => { if (db.insulators.count > 1) { db.insulators.count--; ui.dispInsCount.textContent = db.insulators.count; saveDb(); } });
    ui.btnInsQtyUp.addEventListener('click',   () => { db.insulators.qty++; ui.dispInsQty.textContent = db.insulators.qty; saveDb(); });
    ui.btnInsQtyDown.addEventListener('click', () => { if (db.insulators.qty > 1) { db.insulators.qty--; ui.dispInsQty.textContent = db.insulators.qty; saveDb(); } });

    ui.toggleWireTypeA.addEventListener('click', () => {
        db.wireTypeA = !db.wireTypeA;
        saveDb();
        ui.pillWireTypeA.classList.toggle('on', db.wireTypeA);
        ui.toggleWireTypeA.classList.toggle('active', db.wireTypeA);
        ui.insulatorSection.classList.toggle('hidden', !db.wireTypeA);
    });

    [
        { el: ui.loadCabinet,       key: 'communicationCabinet' },
        { el: ui.loadCommLine,      key: 'communicationLine' },
        { el: ui.loadStreetLamp,    key: 'streetLamp' },
        { el: ui.loadVolsMuffle,    key: 'volsMuffle' },
        { el: ui.loadStreetLantern, key: 'streetLantern' },
        { el: ui.loadVoltageLines,  key: 'voltageLines' },
    ].forEach(({ el, key }) => {
        el.addEventListener('click', e => {
            if (e.button !== 0) return;
            db.additionalLoad[key]++;
            if (key === 'streetLamp') db.lamps.push({ type: '–î–ù–ê–¢', customType: '', mounting: '–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π', powerSupply: '–ö–∞–±–µ–ª—å', direction: '–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏' });
            saveDb(); updateUI();
            showNotification(`+1 ${el.querySelector('.load-tile-name').textContent.trim()}`);
        });
        el.addEventListener('contextmenu', e => {
            e.preventDefault();
            if (db.additionalLoad[key] > 0) {
                db.additionalLoad[key]--;
                if (key === 'streetLamp' && db.lamps.length > 0) db.lamps.pop();
                saveDb(); updateUI();
            }
        });
    });

    ui.btnAtUp.addEventListener('click',   () => { db.attachments.count++; ui.dispAttach.textContent = db.attachments.count; saveDb(); });
    ui.btnAtDown.addEventListener('click', () => { if (db.attachments.count > 0) { db.attachments.count--; ui.dispAttach.textContent = db.attachments.count; saveDb(); } });
    ui.selAttachMat.addEventListener('change', e => { db.attachments.material = e.target.value; saveDb(); });
    ui.btnCancAtch.addEventListener('click',  () => ui.modalAttach.classList.remove('show'));
    ui.btnConfAtch.addEventListener('click',  () => { ui.modalAttach.classList.remove('show'); afterAttachments(); });

    ui.btnCancLamps.addEventListener('click', () => ui.modalLamps.classList.remove('show'));
    ui.btnConfLamps.addEventListener('click', () => { ui.modalLamps.classList.remove('show'); startFill(); });

    [ui.modalAttach, ui.modalLamps].forEach(m =>
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); })
    );
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') [ui.modalAttach, ui.modalLamps].forEach(m => m.classList.remove('show'));
    });

    /******************************************************************
     * –ì–ï–ù–ï–†–ê–¶–ò–Ø UI –î–õ–Ø –§–û–ù–ê–†–ï–ô
     ******************************************************************/
    function genLampsUI() {
        ui.lampsConfig.innerHTML = db.lamps.map((lamp, i) => `
            <div class="lamp-card">
                <div class="lamp-card-title">üí° –§–æ–Ω–∞—Ä—å ${i + 1}</div>
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–¢–∏–ø –ª–∞–º–ø—ã</label>
                    <select class="field-select lamp-type" data-i="${i}">
                        ${LAMP_TYPES.map(t => `<option value="${t}" ${lamp.type===t?'selected':''}>${t}</option>`).join('')}
                    </select>
                </div>
                ${lamp.type === '–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é' ? `
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø</label>
                    <input type="text" class="field-input lamp-custom" data-i="${i}" value="${lamp.customType||''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–†–í-250">
                </div>` : ''}
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–ö—Ä–µ–ø–ª–µ–Ω–∏–µ</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" class="radio-input lamp-mount" id="m${i}a" name="m${i}" value="–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π"  ${lamp.mounting==='–ø—Ä–∏—Å—Ç–∞–≤–Ω–æ–π' ?'checked':''} data-i="${i}"><label class="radio-label" for="m${i}a">–ü—Ä–∏—Å—Ç–∞–≤–Ω–æ–π</label></div>
                        <div class="radio-option"><input type="radio" class="radio-input lamp-mount" id="m${i}b" name="m${i}" value="–∫–æ–Ω—Å–æ–ª—å–Ω—ã–π" ${lamp.mounting==='–∫–æ–Ω—Å–æ–ª—å–Ω—ã–π'?'checked':''} data-i="${i}"><label class="radio-label" for="m${i}b">–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π</label></div>
                    </div>
                </div>
                <div class="field-group" style="margin-bottom:8px;">
                    <label class="field-label">–ü–∏—Ç–∞–Ω–∏–µ</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" class="radio-input lamp-power" id="p${i}a" name="p${i}" value="–ö–∞–±–µ–ª—å" ${lamp.powerSupply==='–ö–∞–±–µ–ª—å'?'checked':''} data-i="${i}"><label class="radio-label" for="p${i}a">–ö–∞–±–µ–ª—å</label></div>
                        <div class="radio-option"><input type="radio" class="radio-input lamp-power" id="p${i}b" name="p${i}" value="–ü—Ä–æ–≤–æ–¥" ${lamp.powerSupply==='–ü—Ä–æ–≤–æ–¥'?'checked':''} data-i="${i}"><label class="radio-label" for="p${i}b">–ü—Ä–æ–≤–æ–¥</label></div>
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                    <select class="field-select lamp-dir" data-i="${i}">
                        <option value="–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏" ${lamp.direction==='–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏'?'selected':''}>–ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏</option>
                        <option value="–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ"           ${lamp.direction==='–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ'          ?'selected':''}>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ</option>
                        <option value="–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏"     ${lamp.direction==='–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏'    ?'selected':''}>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏</option>
                    </select>
                </div>
            </div>`).join('');

        shadow.querySelectorAll('.lamp-type').forEach(s   => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].type        = e.target.value; saveDb(); genLampsUI(); }));
        shadow.querySelectorAll('.lamp-custom').forEach(s => s.addEventListener('input',  e => { const i = +e.target.dataset.i; db.lamps[i].customType  = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-mount').forEach(s  => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].mounting    = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-power').forEach(s  => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].powerSupply = e.target.value; saveDb(); }));
        shadow.querySelectorAll('.lamp-dir').forEach(s    => s.addEventListener('change', e => { const i = +e.target.dataset.i; db.lamps[i].direction   = e.target.value; saveDb(); }));
    }

    /******************************************************************
     * –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï
     ******************************************************************/
    ui.btnScan.addEventListener('click', async () => {
        ui.btnScan.disabled = true;
        ui.btnScan.innerHTML = '<span>‚è≥</span><span>–°–∫–∞–Ω–∏—Ä—É—é...</span>';
        try {
            await loadFromForm();
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞–Ω—ã —Å —Å–∞–π—Ç–∞', 'success');
        } catch (err) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏', 'error');
        } finally {
            ui.btnScan.disabled = false;
            ui.btnScan.innerHTML = '<span>üîç</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>';
        }
    });

    /******************************************************************
     * –ö–ù–û–ü–ö–ê –ó–ê–ü–û–õ–ù–ò–¢–¨
     ******************************************************************/
    ui.btnFill.addEventListener('click', async () => {
        clearLogs();
        clearAllErrors();
        log('üöÄ –ó–∞–ø—É—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–æ—Ä—ã...', 'info');
        if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è') {
            ui.dispAttach.textContent = db.attachments.count;
            ui.selAttachMat.value     = db.attachments.material;
            ui.modalAttach.classList.add('show');
        } else {
            db.attachments.count = 0;
            afterAttachments();
        }
    });

    async function afterAttachments() {
        if (db.additionalLoad.streetLamp > 0) { genLampsUI(); ui.modalLamps.classList.add('show'); }
        else startFill();
    }

    /******************************************************************
     * –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø
     ******************************************************************/
    async function startFill() {
        ui.btnFill.disabled = true;
        ui.btnFill.innerHTML = '<span>‚è≥</span><span>–ó–∞–ø–æ–ª–Ω—è—é...</span>';
        showNotification('‚è≥ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'warning');
        try {
            log('‚ïê'.repeat(45), 'info');
            log('v1.8.4 ‚Äî –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä—ã', 'info');
            log('‚ïê'.repeat(45), 'info');

            if (db.pillar.type) {
                const cur = document.querySelector('fieldset[name="pillarType"] .smwb-select-field__values');
                if (!cur || cur.textContent.trim() !== db.pillar.type)
                    await clickReactSelect('fieldset[name="pillarType"] .smwb-select-field', db.pillar.type);
                log(`–ú–∞—Ä–∫–∞: ${db.pillar.type}`, 'success');
                await sleep(150);
            }

            await fillField('input[name="constructionType"]', db.pillar.constructionType, '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤');
            await sleep(150);
            await fillField('input[name="placement"]', db.pillar.placement, '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
            await sleep(150);
            await fillField('input[name="material"]', db.pillar.material, '–ú–∞—Ç–µ—Ä–∏–∞–ª');
            await sleep(150);

            if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è')
                await fillField('input[name="woodTemporaryType"]', '–±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏', '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ü–∏—è');
            await sleep(150);

            log(`\n=== –°–¢–û–ô–ö–ò (${db.stands.count}) ===`, 'info');
            if (await setCounter('input[name="stand.count"]', db.stands.count) && db.stands.count > 0) {
                await sleep(600);
                for (let i = 0; i < db.stands.count; i++) {
                    log(`–°—Ç–æ–π–∫–∞ ${i+1}/${db.stands.count}`, 'info');
                    await goToSlide(i); await sleep(200);
                    await fillField(`input[name="stand.info[${i}].material"]`, db.stands.material, `–ú–∞—Ç. —Å—Ç–æ–π–∫–∏ ${i+1}`);
                    await sleep(100);
                    await clickCamera(`fieldset[name="stand.info[${i}].photoUrls"] button.smwb-fab`);
                    await sleep(100);
                }
            }

            if (db.bracing.count > 0) {
                log(`\n=== –£–ö–û–°–´ (${db.bracing.count}) ===`, 'info');
                if (await setCounter('input[name="bracing.count"]', db.bracing.count)) {
                    await sleep(600);
                    for (let i = 0; i < db.bracing.count; i++) {
                        log(`–£–∫–æ—Å ${i+1}/${db.bracing.count}`, 'info');
                        await goToSlide(i); await sleep(200);
                        await fillField(`input[name="bracing.info[${i}].material"]`, db.bracing.material, `–ú–∞—Ç. —É–∫–æ—Å–∞ ${i+1}`);
                        await sleep(100);
                        await clickCamera(`fieldset[name="bracing.info[${i}].photoUrls"] button.smwb-fab`);
                        await sleep(100);
                    }
                }
            }

            if (db.pillar.material === '–¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è' && db.attachments.count > 0) {
                log(`\n=== –ü–†–ò–°–¢–ê–í–ö–ò (${db.attachments.count}) ===`, 'info');
                if (await setCounter('input[name="attachment.count"]', db.attachments.count)) {
                    await sleep(600);
                    for (let i = 0; i < db.attachments.count; i++) {
                        log(`–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ ${i+1}/${db.attachments.count}`, 'info');
                        await goToSlide(i); await sleep(200);
                        await fillField(`input[name="attachment.info[${i}].material"]`, db.attachments.material, `–ú–∞—Ç. –ø—Ä–∏—Å—Ç. ${i+1}`);
                        await sleep(100);
                        await clickCamera(`fieldset[name="attachment.info[${i}].photoUrls"] button.smwb-fab`);
                        await sleep(100);
                    }
                }
            }

            await syncLoads();
            if (db.wireTypeA) await syncInsulators();
            await syncSubscribers();

            log('\n‚úÖ –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û', 'success');
            showNotification('‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!', 'success');

        } catch (err) {
            log(`‚ùå –û–®–ò–ë–ö–ê: ${err.message}`, 'error');
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
        } finally {
            ui.btnFill.disabled = false;
            ui.btnFill.innerHTML = '<span>‚ú®</span><span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</span>';
        }
    }

    /******************************************************************
     * –ú–ò–ù–ò–ú–ò–ó–ê–¶–ò–Ø + –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï
     ******************************************************************/
    ui.btnMin.addEventListener('click', () => {
        db.ui.isCollapsed = !db.ui.isCollapsed;
        ui.body.style.display = db.ui.isCollapsed ? 'none' : 'flex';
        ui.collapsedInfo.classList.toggle('visible', db.ui.isCollapsed);
        ui.btnMin.textContent = db.ui.isCollapsed ? '+' : '‚àí';
        saveDb();
    });

    let dragging = false, ox, oy;
    shadow.querySelector('#dragHandle').addEventListener('mousedown', e => {
        dragging = true; ox = e.clientX - ui.main.offsetLeft; oy = e.clientY - ui.main.offsetTop;
        ui.main.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e => {
        if (dragging) { ui.main.style.left = (e.clientX - ox) + 'px'; ui.main.style.top = (e.clientY - oy) + 'px'; }
    });
    document.addEventListener('mouseup', () => {
        if (dragging) {
            dragging = false; ui.main.style.cursor = '';
            db.ui.pos = { x: parseInt(ui.main.style.left), y: parseInt(ui.main.style.top) }; saveDb();
        }
    });

    /******************************************************************
     * DISCORD
     ******************************************************************/
    ui.discordLink.addEventListener('click', e => {
        e.preventDefault();
        window.open('https://discord.gg/RC6HhTqCdR', '_blank');
    });

    /******************************************************************
     * –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨ –ó–ê –§–û–†–ú–û–ô
     ******************************************************************/
    function isPillarForm() {
        return !!(
            document.querySelector('fieldset[name="pillarType"]') ||
            document.querySelector('input[name="constructionType"]') ||
            document.querySelector('input[name="stand.count"]')
        );
    }

    function checkFormPresence() {
        const visible = isPillarForm();
        host.style.display = (visible && !window.pillarManuallyHidden) ? 'block' : 'none';
    }

    function startFormObserver() {
        checkFormPresence();
        const observer = new MutationObserver(() => checkFormPresence());
        observer.observe(document.body, { childList: true, subtree: true });
    }

    /******************************************************************
     * –ì–û–†–Ø–ß–ê–Ø –ö–õ–ê–í–ò–®–ê ALT+–û
     ******************************************************************/
    window.pillarManuallyHidden = false;
    document.addEventListener('keydown', e => {
        if (e.altKey && e.key.toLowerCase() === '–æ') {
            e.preventDefault();
            window.pillarManuallyHidden = !window.pillarManuallyHidden;
            checkFormPresence();
            const msg = window.pillarManuallyHidden ? 'üôà –û–ø–æ—Ä—ã —Å–∫—Ä—ã—Ç—ã. ALT+–û –¥–ª—è –ø–æ–∫–∞–∑–∞' : '‚úÖ –û–ø–æ—Ä—ã –ø–æ–∫–∞–∑–∞–Ω—ã. ALT+–û –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è';
            const n = document.createElement('div');
            n.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,rgba(139,92,246,0.95),rgba(0,0,0,0.95));border:1px solid rgba(139,92,246,0.5);border-radius:10px;padding:12px 16px;color:#fff;font-size:12px;font-family:-apple-system,sans-serif;z-index:1000001;box-shadow:0 8px 24px rgba(0,0,0,0.5);max-width:280px;`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }
    });

    /******************************************************************
     * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
     ******************************************************************/
    ui.main.style.left = db.ui.pos.x + 'px';
    ui.main.style.top  = db.ui.pos.y + 'px';
    if (db.ui.isCollapsed) {
        ui.body.style.display = 'none';
        ui.collapsedInfo.classList.add('visible');
        ui.btnMin.textContent = '+';
    }

    initSelects();
    updateUI();
    startDetection();
    startFormObserver();

    console.log('‚úÖ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–æ—Ä v1.8.4 –≥–æ—Ç–æ–≤! | Created by KAST Team');
    console.log('üí° –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: ALT+–û ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å UI');
})();
